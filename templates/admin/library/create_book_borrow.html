{% extends 'admin/base.html' %}
{% load static %}
{% block title %} Borrow New Book {% endblock title %}

{% block breadcrumb %}
    <a href="{% url 'admin_book_borrows_list' %}" class="btn btn-outline-secondary">
        <i class="fas fa-arrow-left"></i> Back to Borrow List
    </a>
{% endblock breadcrumb %}

{% block extra_css %}
<style>
    .required-field::after {
        content: " *";
        color: #dc3545;
    }
    .borrower-type-buttons .btn {
        min-width: 120px;
    }
    .book-copy-item {
        border-left: 4px solid #007bff;
        padding-left: 10px;
        margin-bottom: 5px;
    }
    .book-copy-item small {
        color: #6c757d;
    }
    .rules-info {
        background-color: #f8f9fa;
        border-radius: 5px;
        padding: 15px;
        margin-bottom: 15px;
    }
    .borrower-info {
        background-color: #e8f4fd;
        border-radius: 5px;
        padding: 15px;
        margin-bottom: 15px;
    }
    .book-info {
        background-color: #f0f9f0;
        border-radius: 5px;
        padding: 15px;
        margin-bottom: 15px;
    }
</style>
{% endblock extra_css %}

{% block content %}
<div class="container-fluid">
    <div class="row">
        <div class="col-lg-10 offset-lg-1">
            <div class="card">
                <div class="card-header bg-primary text-white">
                    <h5 class="card-title mb-0">
                        <i class="fas fa-plus-circle"></i> Borrow New Book
                    </h5>
                </div>
                <div class="card-body">
                    <form id="borrow-form">
                        {% csrf_token %}
                        
                        <!-- Step 1: Select Borrower Type -->
                        <div class="step-section" id="step-1">
                            <h5 class="mb-3"><i class="fas fa-user-check"></i> Step 1: Select Borrower Type</h5>
                            <div class="form-group">
                                <label class="required-field">Who is borrowing the book?</label>
                                <div class="row borrower-type-buttons">
                                    <div class="col-md-3 mb-2">
                                        <button type="button" class="btn btn-outline-primary btn-block borrower-type-btn" data-type="staff">
                                            <i class="fas fa-user-tie fa-2x mb-2"></i><br>
                                            Staff Member
                                        </button>
                                    </div>
                                    <div class="col-md-3 mb-2">
                                        <button type="button" class="btn btn-outline-success btn-block borrower-type-btn" data-type="student">
                                            <i class="fas fa-user-graduate fa-2x mb-2"></i><br>
                                            Student
                                        </button>
                                    </div>
                                </div>
                                <input type="hidden" id="borrower_type" name="borrower_type" required>
                            </div>
                        </div>
                        
                        <!-- Step 2: Select Borrower (Dynamic based on type) -->
                        <div class="step-section" id="step-2" style="display: none;">
                            <h5 class="mb-3"><i class="fas fa-user"></i> Step 2: Select Borrower</h5>
                            
                            <!-- Staff Borrowers -->
                            <div class="borrower-option" id="staff-borrowers" style="display: none;">
                                <div class="form-group">
                                    <label for="staff_borrower" class="required-field">Select Staff Member</label>
                                    <select class="form-control select2bs4" id="staff_borrower" style="width: 100%;">
                                        <option value="">Select Staff Member</option>
                                        {% for staff in staff_borrowers %}
                                            <option value="{{ staff.id }}">
                                                {{ staff.get_full_name }} 
                                                {% if staff.admin.email %} - {{ staff.admin.email }}{% endif %}
                                                {% if staff.position_title %} ({{ staff.position_title }}){% endif %}
                                            </option>
                                        {% endfor %}
                                    </select>
                                </div>
                            </div>
                            
                            <!-- Student Borrowers -->
                            <div class="borrower-option" id="student-borrowers" style="display: none;">
                                <div class="form-group">
                                    <label for="student_borrower" class="required-field">Select Student</label>
                                    <select class="form-control select2bs4" id="student_borrower" style="width: 100%;">
                                        <option value="">Select Student</option>
                                        {% for student in student_borrowers %}
                                            <option value="{{ student.id }}">
                                                {{ student.full_name }} 
                                                {% if student.registration_number %} - {{ student.registration_number }}{% endif %}
                                                {% if student.class_level %} ({{ student.class_level.name }}{% if student.stream_class %} - {{ student.stream_class.name }}{% endif %}){% endif %}
                                            </option>
                                        {% endfor %}
                                    </select>
                                </div>
                            </div>
                            
                            <input type="hidden" id="borrower_id" name="borrower_id" required>
                            
                            <!-- Borrower Information Display -->
                            <div class="borrower-info mt-3" id="borrower-info-display" style="display: none;">
                                <h6><i class="fas fa-info-circle"></i> Borrower Information</h6>
                                <div id="borrower-details"></div>
                            </div>
                        </div>
                        
                        <!-- Step 3: Select Book -->
                        <div class="step-section" id="step-3" style="display: none;">
                            <h5 class="mb-3"><i class="fas fa-book"></i> Step 3: Select Book</h5>
                            
                            <div class="form-group">
                                <label for="book" class="required-field">Book</label>
                                <select class="form-control select2bs4" id="book" name="book" required style="width: 100%;">
                                    <option value="">Select Book</option>
                                    {% for book in available_books %}
                                        <option value="{{ book.id }}" 
                                                data-reference="{{ book.is_reference|yesno:'true,false' }}"
                                                data-available="{{ book.available_copies }}">
                                            {{ book.title }} by {{ book.author }} 
                                            ({{ book.available_copies }} available{% if book.is_reference %}, Reference{% endif %})
                                        </option>
                                    {% endfor %}
                                </select>
                            </div>
                            
                            <!-- Book Information Display -->
                            <div class="book-info mt-3" id="book-info-display" style="display: none;">
                                <h6><i class="fas fa-info-circle"></i> Book Information</h6>
                                <div id="book-details"></div>
                            </div>
                            
                            <!-- Book Copies Selection -->
                            <div class="form-group mt-3" id="book-copies-section" style="display: none;">
                                <label for="book_copy">Select Specific Copy (Optional)</label>
                                <select class="form-control select2bs4" id="book_copy" name="book_copy" style="width: 100%;">
                                    <option value="">Any Available Copy (Auto-assigned)</option>
                                    <!-- Dynamic options will be loaded here -->
                                </select>
                                <small class="form-text text-muted">
                                    Leave empty to auto-assign any available copy, or select a specific copy.
                                </small>
                            </div>
                            
                            <!-- Available Copies Display -->
                            <div class="mt-3" id="available-copies-display" style="display: none;">
                                <h6><i class="fas fa-copy"></i> Available Copies</h6>
                                <div id="copies-list" class="list-group"></div>
                            </div>
                        </div>
                        
                        <!-- Step 4: Confirm and Submit -->
                        <div class="step-section" id="step-4" style="display: none;">
                            <h5 class="mb-3"><i class="fas fa-check-circle"></i> Step 4: Confirm Details</h5>
                            
                            <div class="rules-info">
                                <h6><i class="fas fa-clipboard-list"></i> Borrowing Rules</h6>
                                <div id="rules-details"></div>
                            </div>
                            
                            <div class="borrower-info">
                                <h6><i class="fas fa-user"></i> Borrower</h6>
                                <div id="confirm-borrower"></div>
                            </div>
                            
                            <div class="book-info">
                                <h6><i class="fas fa-book"></i> Book Details</h6>
                                <div id="confirm-book"></div>
                            </div>
                            
                            <div class="row mt-3">
                                <div class="col-md-6">
                                    <div class="form-group">
                                        <label for="due_date" class="required-field">Due Date</label>
                                        <input type="date" class="form-control" id="due_date" name="due_date" required>
                                        <small class="form-text text-muted">
                                            Auto-calculated based on borrower type and borrowing rules
                                        </small>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="form-group">
                                        <label for="notes">Notes (Optional)</label>
                                        <textarea class="form-control" id="notes" name="notes" rows="2" placeholder="Any special notes about this borrowing..."></textarea>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="alert alert-warning mt-3">
                                <i class="fas fa-exclamation-triangle"></i>
                                <strong>Important:</strong> 
                                <ul class="mb-0 mt-2">
                                    <li>Books must be returned by the due date to avoid fines</li>
                                    <li>Reference books may have different borrowing rules</li>
                                    <li>Lost or damaged books will incur replacement charges</li>
                                </ul>
                            </div>
                        </div>
                        
                        <!-- Navigation Buttons -->
                        <div class="form-group mt-4">
                            <div class="d-flex justify-content-between">
                                <button type="button" class="btn btn-secondary" id="prev-btn" style="display: none;">
                                    <i class="fas fa-arrow-left"></i> Previous
                                </button>
                                <button type="button" class="btn btn-primary" id="next-btn">
                                    Next <i class="fas fa-arrow-right"></i>
                                </button>
                                <button type="submit" class="btn btn-success" id="submit-btn" style="display: none;">
                                    <span class="spinner-border spinner-border-sm" role="status" aria-hidden="true" style="display: none;"></span>
                                    <i class="fas fa-check"></i> Complete Borrowing
                                </button>
                            </div>
                        </div>
                        
                        <!-- Progress Indicator -->
                        <div class="progress mt-4" style="height: 10px;">
                            <div class="progress-bar" id="progress-bar" role="progressbar" style="width: 25%;" 
                                 aria-valuenow="25" aria-valuemin="0" aria-valuemax="100"></div>
                        </div>
                        <div class="text-center mt-2">
                            <small class="text-muted" id="step-indicator">Step 1 of 4</small>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
$(document).ready(function() {
    let currentStep = 1;
    let borrowerType = null;
    let borrowerId = null;
    let bookId = null;
    let borrowingRules = null;
    
    // Initialize Select2
    $('.select2bs4').select2({
        theme: 'bootstrap4',
        width: '100%'
    });
    
    // Borrower Type Selection
    $('.borrower-type-btn').on('click', function() {
        borrowerType = $(this).data('type');
        $('#borrower_type').val(borrowerType);
        
        // Show appropriate borrower selection
        $('.borrower-option').hide();
        $(`#${borrowerType}-borrowers`).show();
        
        // Reset borrower selection
        $(`#${borrowerType}_borrower`).val('').trigger('change');
        $('#borrower_id').val('');
        $('#borrower-info-display').hide();
        
        // Update UI
        $(this).addClass('active').siblings().removeClass('active');
        $('#next-btn').prop('disabled', false);
    });
    
    // Borrower Selection
    $('#staff_borrower, #student_borrower').on('change', function() {
        if ($(this).val()) {
            borrowerId = $(this).val();
            $('#borrower_id').val(borrowerId);
            loadBorrowerInfo();
        }
    });
    
    // Book Selection
    $('#book').on('change', function() {
        if ($(this).val()) {
            bookId = $(this).val();
            loadBookInfo();
            loadBookCopies();
        }
    });
    
    // Book Copy Selection
    $('#book_copy').on('change', function() {
        // Optional: Highlight selected copy in the list
        const copyId = $(this).val();
        $('.copy-item').removeClass('active');
        if (copyId) {
            $(`.copy-item[data-copy-id="${copyId}"]`).addClass('active');
        }
    });
    
    // Navigation
    $('#next-btn').on('click', function() {
        if (validateStep(currentStep)) {
            currentStep++;
            updateStep();
        }
    });
    
    $('#prev-btn').on('click', function() {
        currentStep--;
        updateStep();
    });
    
    // Form Submission
    $('#borrow-form').on('submit', function(e) {
        e.preventDefault();
        
        if (!validateStep(4)) {
            return;
        }
        
        const submitBtn = $('#submit-btn');
        const spinner = submitBtn.find('.spinner-border');
        
        // Show loading
        submitBtn.prop('disabled', true);
        spinner.show();
        
        // Prepare form data
        const formData = new FormData(this);
        
        // Add borrower_id
        formData.append('borrower_id', borrowerId);
        
        // Send AJAX request
        $.ajax({
            url: '{% url "admin_create_book_borrow" %}',
            method: 'POST',
            headers: {
                'X-CSRFToken': $('input[name="csrfmiddlewaretoken"]').val(),
                'X-Requested-With': 'XMLHttpRequest'
            },
            data: formData,
            processData: false,
            contentType: false,
            success: function(data) {
                if (data.success) {
                    Swal.fire({
                        icon: 'success',
                        title: 'Success!',
                        html: `
                            <p>${data.message}</p>
                            <div class="alert alert-info mt-3">
                                <i class="fas fa-info-circle"></i>
                                <strong>Borrowing Details:</strong><br>
                                Due Date: ${data.due_date}<br>
                                Borrow ID: ${data.borrow_id}
                            </div>
                        `,
                        showConfirmButton: false,
                        timer: 3000
                    }).then(() => {
                        window.location.href = '{% url "admin_book_borrows_list" %}';
                    });
                } else {
                    Swal.fire({
                        icon: 'error',
                        title: 'Error!',
                        text: data.message
                    });
                    submitBtn.prop('disabled', false);
                    spinner.hide();
                }
            },
            error: function(xhr, status, error) {
                console.error('Error:', error);
                Swal.fire({
                    icon: 'error',
                    title: 'Error!',
                    text: 'An error occurred. Please try again.'
                });
                submitBtn.prop('disabled', false);
                spinner.hide();
            }
        });
    });
    
    // Functions
    function validateStep(step) {
        switch(step) {
            case 1:
                if (!borrowerType) {
                    Swal.fire({
                        icon: 'warning',
                        title: 'Required',
                        text: 'Please select borrower type (Staff or Student)'
                    });
                    return false;
                }
                return true;
                
            case 2:
                if (!borrowerId) {
                    Swal.fire({
                        icon: 'warning',
                        title: 'Required',
                        text: 'Please select a borrower'
                    });
                    return false;
                }
                return true;
                
            case 3:
                if (!bookId) {
                    Swal.fire({
                        icon: 'warning',
                        title: 'Required',
                        text: 'Please select a book'
                    });
                    return false;
                }
                
                const selectedBook = $('#book option:selected');
                const isReference = selectedBook.data('reference') === 'true';
                const availableCopies = parseInt(selectedBook.data('available'));
                
                if (availableCopies === 0) {
                    Swal.fire({
                        icon: 'error',
                        title: 'Not Available',
                        text: 'This book has no available copies'
                    });
                    return false;
                }
                
                if (isReference && borrowingRules && !borrowingRules.can_borrow_reference) {
                    Swal.fire({
                        icon: 'error',
                        title: 'Restricted',
                        text: 'Reference books cannot be borrowed by this borrower type'
                    });
                    return false;
                }
                return true;
                
            case 4:
                if (!$('#due_date').val()) {
                    Swal.fire({
                        icon: 'warning',
                        title: 'Required',
                        text: 'Due date is required'
                    });
                    return false;
                }
                return true;
                
            default:
                return true;
        }
    }
    
    function updateStep() {
        // Hide all steps
        $('.step-section').hide();
        
        // Show current step
        $(`#step-${currentStep}`).show();
        
        // Update buttons
        $('#prev-btn').toggle(currentStep > 1);
        $('#next-btn').toggle(currentStep < 4);
        $('#submit-btn').toggle(currentStep === 4);
        
        // Update progress
        const progress = (currentStep / 4) * 100;
        $('#progress-bar').css('width', `${progress}%`);
        $('#step-indicator').text(`Step ${currentStep} of 4`);
        
        // Update step titles
        const stepTitles = {
            1: 'Select Borrower Type',
            2: 'Select Borrower',
            3: 'Select Book',
            4: 'Confirm Details'
        };
        
        // If going back to step 3 and book is already selected, reload info
        if (currentStep === 3 && bookId) {
            loadBookInfo();
            loadBookCopies();
        }
        
        // If going back to step 2 and borrower is already selected, reload info
        if (currentStep === 2 && borrowerId) {
            loadBorrowerInfo();
        }
        
        // If on step 4, update confirmation details
        if (currentStep === 4) {
            updateConfirmation();
        }
    }
    
    function loadBorrowerInfo() {
        $.ajax({
            url: '{% url "admin_get_borrower_info" %}',
            method: 'GET',
            data: {
                borrower_type: borrowerType,
                borrower_id: borrowerId
            },
            success: function(data) {
                if (data.success) {
                    borrowingRules = data.rules;
                    
                    // Update borrower info display
                    let borrowerHtml = `
                        <p><strong>Name:</strong> ${data.borrower_name}</p>
                        <p><strong>Active Borrows:</strong> ${data.active_borrows} of ${data.rules ? data.rules.max_books_allowed : 'N/A'}</p>
                    `;
                    
                    if (data.rules) {
                        borrowerHtml += `
                            <p><strong>Borrowing Limit:</strong> ${data.rules.max_books_allowed} books</p>
                            <p><strong>Borrowing Duration:</strong> ${data.rules.borrowing_duration_days} days</p>
                        `;
                    }
                    
                    $('#borrower-details').html(borrowerHtml);
                    $('#borrower-info-display').show();
                    
                    // Update due date
                    if (data.due_date) {
                        $('#due_date').val(data.due_date);
                    }
                    
                    // Enable next button if borrower can borrow more
                    if (data.can_borrow_more === false) {
                        Swal.fire({
                            icon: 'error',
                            title: 'Limit Reached',
                            text: 'This borrower has reached the maximum number of books allowed'
                        });
                        $('#next-btn').prop('disabled', true);
                    } else {
                        $('#next-btn').prop('disabled', false);
                    }
                } else {
                    $('#borrower-info-display').hide();
                    $('#next-btn').prop('disabled', true);
                }
            },
            error: function() {
                $('#borrower-info-display').hide();
                $('#next-btn').prop('disabled', true);
            }
        });
    }
    
    function loadBookInfo() {
        const selectedBook = $('#book option:selected');
        const isReference = selectedBook.data('reference') === 'true';
        const availableCopies = parseInt(selectedBook.data('available'));
        
        let bookHtml = `
            <p><strong>Title:</strong> ${selectedBook.text().split(' (')[0]}</p>
            <p><strong>Available Copies:</strong> ${availableCopies}</p>
            <p><strong>Type:</strong> ${isReference ? 'Reference Book' : 'Regular Book'}</p>
        `;
        
        if (isReference && borrowingRules && !borrowingRules.can_borrow_reference) {
            bookHtml += `<div class="alert alert-danger mt-2">
                <i class="fas fa-exclamation-triangle"></i>
                This borrower cannot borrow reference books
            </div>`;
            $('#next-btn').prop('disabled', true);
        } else if (availableCopies === 0) {
            bookHtml += `<div class="alert alert-warning mt-2">
                <i class="fas fa-exclamation-triangle"></i>
                No copies available for borrowing
            </div>`;
            $('#next-btn').prop('disabled', true);
        } else {
            $('#next-btn').prop('disabled', false);
        }
        
        $('#book-details').html(bookHtml);
        $('#book-info-display').show();
    }
    
    function loadBookCopies() {
        $.ajax({
            url: '{% url "admin_get_book_copies" %}',
            method: 'GET',
            data: { book_id: bookId },
            success: function(data) {
                if (data.success) {
                    // Update book copies select
                    $('#book_copy').empty();
                    $('#book_copy').append('<option value="">Any Available Copy (Auto-assigned)</option>');
                    
                    let copiesListHtml = '';
                    
                    $.each(data.copies, function(index, copy) {
                        // Add to select dropdown
                        $('#book_copy').append(
                            `<option value="${copy.id}">${copy.display_text}</option>`
                        );
                        
                        // Add to copies list
                        copiesListHtml += `
                            <div class="copy-item list-group-item book-copy-item" data-copy-id="${copy.id}">
                                <div class="d-flex justify-content-between align-items-center">
                                    <div>
                                        <strong>Copy #${copy.copy_number}</strong><br>
                                        <small>Accession: ${copy.accession_number} | Condition: ${copy.condition}</small>
                                    </div>
                                    <button type="button" class="btn btn-sm btn-outline-primary select-copy-btn" data-copy-id="${copy.id}">
                                        Select
                                    </button>
                                </div>
                            </div>
                        `;
                    });
                    
                    $('#copies-list').html(copiesListHtml);
                    
                    // Show/hide sections
                    $('#book-copies-section').show();
                    $('#available-copies-display').show();
                    
                    // Add click handlers for copy selection buttons
                    $('.select-copy-btn').on('click', function() {
                        const copyId = $(this).data('copy-id');
                        $('#book_copy').val(copyId).trigger('change');
                    });
                    
                } else {
                    $('#book-copies-section').hide();
                    $('#available-copies-display').hide();
                }
            },
            error: function() {
                $('#book-copies-section').hide();
                $('#available-copies-display').hide();
            }
        });
    }
    
    function updateConfirmation() {
        // Borrower info
        const borrowerName = $('#borrower-details').find('p:first').text().replace('Name: ', '');
        const borrowerSelect = borrowerType === 'staff' ? $('#staff_borrower') : $('#student_borrower');
        const borrowerText = borrowerSelect.find('option:selected').text();
        
        $('#confirm-borrower').html(`
            <p><strong>Type:</strong> ${borrowerType === 'staff' ? 'Staff' : 'Student'}</p>
            <p><strong>Name:</strong> ${borrowerText}</p>
        `);
        
        // Book info
        const bookText = $('#book option:selected').text().split(' (')[0];
        const selectedCopy = $('#book_copy option:selected');
        const copyText = selectedCopy.val() ? selectedCopy.text() : 'Any Available Copy';
        
        $('#confirm-book').html(`
            <p><strong>Book:</strong> ${bookText}</p>
            <p><strong>Copy:</strong> ${copyText}</p>
        `);
        
        // Rules info
        if (borrowingRules) {
            $('#rules-details').html(`
                <p><strong>Max Books:</strong> ${borrowingRules.max_books_allowed}</p>
                <p><strong>Duration:</strong> ${borrowingRules.borrowing_duration_days} days</p>
                <p><strong>Renewals:</strong> ${borrowingRules.renewal_allowed ? `Yes (${borrowingRules.max_renewals} max)` : 'No'}</p>
                <p><strong>Fine Rate:</strong> TZS ${borrowingRules.fine_per_day}/day</p>
                <p><strong>Max Fine:</strong> TZS ${borrowingRules.max_fine_amount}</p>
                <p><strong>Reference Books:</strong> ${borrowingRules.can_borrow_reference ? 'Allowed' : 'Not Allowed'}</p>
            `);
        }
    }
    
    // Initialize
    updateStep();
});
</script>
{% endblock extra_js %}