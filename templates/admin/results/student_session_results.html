{% extends 'admin/base.html' %}
{% load static %}
{% load custom_filters %}
{% block title %}{{ page_title }}{% endblock title %}

{% block breadcrumb %}
<nav aria-label="breadcrumb">
    <ol class="breadcrumb">
        <li class="breadcrumb-item"><a href="{% url 'admin_students_list' %}">Students</a></li>
        <li class="breadcrumb-item"><a href="{% url 'admin_exam_sessions_list' %}">Exam Sessions</a></li>
        <li class="breadcrumb-item"><a href="{% url 'student_sessions_list' student.id %}">{{ student.full_name }} Sessions</a></li>
        <li class="breadcrumb-item active" aria-current="page">{{ breadcrumb_title }}</li>
    </ol>
</nav>
{% endblock breadcrumb %}

{% block extra_css %}
<style>
    .student-header {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        border-radius: 10px;
        padding: 20px;
        margin-bottom: 20px;
        box-shadow: 0 4px 6px rgba(0,0,0,0.1);
    }
    
    .session-header {
        background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
        color: white;
        border-radius: 10px;
        padding: 20px;
        margin-bottom: 20px;
        box-shadow: 0 4px 6px rgba(0,0,0,0.1);
    }
    
    .performance-card {
        background: white;
        border-radius: 8px;
        padding: 20px;
        margin-bottom: 20px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        border: 1px solid #e9ecef;
    }
    
    .grade-badge {
        padding: 6px 12px;
        border-radius: 20px;
        font-size: 0.8rem;
        font-weight: 600;
    }
    
    .grade-A { background-color: #28a745; color: white; }
    .grade-B { background-color: #17a2b8; color: white; }
    .grade-C { background-color: #ffc107; color: #212529; }
    .grade-D { background-color: #fd7e14; color: white; }
    .grade-E { background-color: #6f42c1; color: white; }
    .grade-F { background-color: #dc3545; color: white; }
    .grade-S { background-color: #6c757d; color: white; }
    
    .performance-stat {
        text-align: center;
        padding: 15px;
        border-radius: 8px;
        background: #f8f9fa;
        margin-bottom: 10px;
    }
    
    .stat-value {
        font-size: 1.8rem;
        font-weight: 700;
        color: #343a40;
        margin-bottom: 5px;
    }
    
    .stat-label {
        font-size: 0.9rem;
        color: #6c757d;
        text-transform: uppercase;
        letter-spacing: 1px;
    }
    
    .ranking-badge {
        font-size: 1.2rem;
        font-weight: 700;
        padding: 10px 20px;
        border-radius: 50px;
        background: linear-gradient(135deg, #ffd700 0%, #ffa500 100%);
        color: #212529;
    }
    
    .table-responsive {
        border-radius: 8px;
        overflow: hidden;
        box-shadow: 0 2px 4px rgba(0,0,0,0.05);
    }
    
    .table th {
        background: #f8f9fa;
        font-weight: 600;
        border-top: none;
    }
    
    .action-buttons {
        background: white;
        border-radius: 8px;
        padding: 15px;
        margin-bottom: 20px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        border: 1px solid #e9ecef;
    }
    
    @media print {
        .no-print {
            display: none !important;
        }
        
        .action-buttons {
            display: none;
        }
    }
    
    /* PDF download button styling */
    .btn-pdf {
        background: linear-gradient(135deg, #dc3545 0%, #c82333 100%);
        color: white;
        border: none;
        padding: 10px 20px;
        border-radius: 6px;
        font-weight: 600;
        transition: all 0.3s;
    }
    
    .btn-pdf:hover {
        background: linear-gradient(135deg, #c82333 0%, #bd2130 100%);
        color: white;
        transform: translateY(-2px);
        box-shadow: 0 4px 8px rgba(220, 53, 69, 0.3);
    }
    
    .btn-pdf i {
        margin-right: 8px;
    }
    
    /* Action buttons styling */
    .action-btn {
        padding: 10px 20px;
        font-weight: 600;
        border-radius: 6px;
        transition: all 0.3s;
        display: inline-flex;
        align-items: center;
        justify-content: center;
    }
    
    .action-btn i {
        margin-right: 8px;
    }
    
    .btn-back {
        background: #6c757d;
        color: white;
        border: none;
    }
    
    .btn-back:hover {
        background: #5a6268;
        color: white;
        transform: translateY(-2px);
        box-shadow: 0 4px 8px rgba(108, 117, 125, 0.3);
    }
    
    .btn-all-sessions {
        background: #007bff;
        color: white;
        border: none;
    }
    
    .btn-all-sessions:hover {
        background: #0069d9;
        color: white;
        transform: translateY(-2px);
        box-shadow: 0 4px 8px rgba(0, 123, 255, 0.3);
    }
    
    /* Results table styling for better print/PDF */
    .results-table {
        border-collapse: collapse;
        width: 100%;
        margin-bottom: 20px;
    }
    
    .results-table th,
    .results-table td {
        padding: 12px 15px;
        text-align: left;
        border-bottom: 1px solid #e9ecef;
    }
    
    .results-table thead th {
        background-color: #f8f9fa;
        font-weight: 600;
        color: #495057;
        position: sticky;
        top: 0;
    }
    
    .results-table tbody tr:hover {
        background-color: #f8f9fa;
    }
    
    .results-table .grade-cell {
        text-align: center;
        font-weight: bold;
    }
    
    .results-table .highlight-row {
        background-color: #fff3cd !important;
    }
    
    /* Print-specific styles */
    @media print {
        .student-header, .session-header {
            background: white !important;
            color: black !important;
            box-shadow: none !important;
            border: 2px solid #000 !important;
        }
        
        .performance-card {
            box-shadow: none !important;
            border: 1px solid #000 !important;
        }
        
        .results-table {
            border: 1px solid #000 !important;
        }
        
        .results-table th,
        .results-table td {
            border: 1px solid #000 !important;
        }
    }
</style>
{% endblock extra_css %}

{% block content %}
<section class="content">
    <div class="container-fluid">
        <!-- Action Buttons -->
        <div class="action-buttons no-print">
            <div class="row">
                <div class="col-md-6">
                    <a href="{% url 'student_sessions_list' student.id %}" class="btn btn-back action-btn">
                        <i class="fas fa-arrow-left"></i> Back to All Sessions
                    </a>
                </div>
                <div class="col-md-6 text-right">
                    <a href="{% url 'download_student_pdf_report' student.id exam_session.id %}" 
                       class="btn btn-pdf action-btn" target="_blank">
                        <i class="fas fa-file-pdf"></i> Download PDF Report
                    </a>
                    <a href="{% url 'admin_exam_sessions_list' %}" class="btn btn-all-sessions action-btn ml-2">
                        <i class="fas fa-clipboard-list"></i> All Sessions
                    </a>
                </div>
            </div>
        </div>

        <!-- Student Information Header -->
        <div class="student-header">
            <div class="row align-items-center">
                <div class="col-md-2 text-center">
                    {% if student.profile_pic %}
                        <img src="{{ student.profile_pic.url }}" alt="{{ student.full_name }}" 
                             class="rounded-circle" style="width: 80px; height: 80px; object-fit: cover; border: 4px solid white;">
                    {% else %}
                        <div class="rounded-circle bg-white d-inline-flex align-items-center justify-content-center" 
                             style="width: 80px; height: 80px; border: 4px solid white;">
                            <i class="fas fa-user-graduate fa-2x text-primary"></i>
                        </div>
                    {% endif %}
                </div>
                <div class="col-md-10">
                    <h3 class="mb-1">{{ student.full_name }}</h3>
                    <p class="mb-2">{{ student.registration_number }} | {{ student.get_gender_display }}</p>
                    <div class="row mt-3">
                        <div class="col-md-4">
                            <small><i class="fas fa-graduation-cap"></i> Current Class</small>
                            <p class="mb-0">{{ student.class_level.name }} {{ student.stream_class.stream_letter|default:"" }}</p>
                        </div>
                        <div class="col-md-4">
                            <small><i class="fas fa-calendar"></i> Academic Year</small>
                            <p class="mb-0">{{ student.academic_year.name|default:"N/A" }}</p>
                        </div>
                        <div class="col-md-4">
                            <small><i class="fas fa-user-tag"></i> Status</small>
                            <p class="mb-0">
                                <span class="badge badge-{{ student.is_active|yesno:'success,danger' }}">
                                    {{ student.get_status_display }}
                                </span>
                            </p>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Exam Session Information -->
        <div class="session-header">
            <div class="row align-items-center">
                <div class="col-md-8">
                    <h4 class="mb-2">{{ exam_session.name }}</h4>
                    <div class="row">
                        <div class="col-md-4">
                            <small><i class="fas fa-calendar-alt"></i> Exam Date</small>
                            <p class="mb-0">{{ exam_session.exam_date|date:"F d, Y" }}</p>
                        </div>
                        <div class="col-md-4">
                            <small><i class="fas fa-graduation-cap"></i> Session Class</small>
                            <p class="mb-0">
                                {{ exam_session.class_level.name }}
                                {% if exam_session.stream_class %}
                                    - {{ exam_session.stream_class.stream_letter }}
                                {% endif %}
                            </p>
                        </div>
                        <div class="col-md-4">
                            <small><i class="fas fa-tag"></i> Exam Type</small>
                            <p class="mb-0">{{ exam_session.exam_type.name }}</p>
                        </div>
                    </div>
                </div>
                <div class="col-md-4 text-center">
                    <span class="badge badge-{{ exam_session.status }} p-2" style="font-size: 1rem;">
                        {{ exam_session.get_status_display }}
                    </span>
                </div>
            </div>
        </div>

        <!-- Performance Summary -->
        <div class="row">
            <div class="col-lg-4">
                <div class="performance-card">
                    <h6 class="text-center mb-4"><i class="fas fa-chart-bar"></i> Academic Summary</h6>
                    <div class="performance-stat">
                        <div class="stat-value">{{ overall_stats.total_marks|floatformat:1 }}</div>
                        <div class="stat-label">Total Marks</div>
                    </div>
                    <div class="performance-stat">
                        <div class="stat-value">{{ overall_stats.average_marks|floatformat:1 }}</div>
                        <div class="stat-label">Average Marks</div>
                    </div>
                    <div class="performance-stat">
                        <div class="stat-value">{{ overall_stats.completion_rate|floatformat:1 }}%</div>
                        <div class="stat-label">Completion Rate</div>
                    </div>
                </div>
            </div>
            
            <div class="col-lg-4">
                <div class="performance-card">
                    <h6 class="text-center mb-4"><i class="fas fa-award"></i> Grading Summary</h6>
                    {% if metrics %}
                    <div class="performance-stat">
                        <div class="stat-value">{{ metrics.average_percentage|floatformat:1 }}%</div>
                        <div class="stat-label">Average Percentage</div>
                    </div>
                    <div class="performance-stat">
                        <div class="stat-value">{{ metrics.average_grade|default:"-" }}</div>
                        <div class="stat-label">Average Grade</div>
                    </div>
                    <div class="performance-stat">
                        <div class="stat-value">{{ metrics.division.division|default:"-" }}-{{ metrics.total_grade_points|default:"-" }}</div>
                        <div class="stat-label">Division</div>
                    </div>
                    {% else %}
                    <div class="text-center py-4">
                        <i class="fas fa-chart-pie fa-3x text-muted mb-3"></i>
                        <p class="text-muted">Grading metrics not available</p>
                    </div>
                    {% endif %}
                </div>
            </div>
            
            <div class="col-lg-4">
                <div class="performance-card">
                    <h6 class="text-center mb-4"><i class="fas fa-trophy"></i> Ranking</h6>
                    {% if positions and positions.class_position %}
                    <div class="text-center mb-4">
                        <div class="ranking-badge d-inline-block">
                            {{ positions.class_position|ordinal }} Position
                        </div>
                    </div>
                    <div class="text-center">
                        <p class="mb-1">Class: {{ class_ranking }}</p>
                        {% if positions.stream_position %}
                        <p class="mb-0">Stream: {{ positions.stream_position|ordinal }} of {{ class_students_count }}</p>
                        {% endif %}
                    </div>
                    {% else %}
                    <div class="text-center py-4">
                        <i class="fas fa-chart-line fa-3x text-muted mb-3"></i>
                        <p class="text-muted">Ranking not available</p>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>

        <!-- Subject-wise Results -->
        <div class="row">
            <div class="col-lg-12">
                <div class="card shadow-sm">
                    <div class="card-header bg-white">
                        <h6 class="header-title mb-0">
                            <i class="fas fa-book-open"></i> Subject-wise Results
                        </h6>
                    </div>
                    <div class="card-body">
                        {% if subject_results %}
                        <div class="table-responsive">
                            <table class="table table-hover text-nowrap table-responsive-sm table-bordered table-striped table-sm  results-table">
                                <thead class="thead-light">
                                    <tr>
                                        <th>#</th>
                                        <th>Subject</th>
                                        <th>Code</th>
                                        <th class="text-center">Marks</th>
                                        <th class="text-center">Percentage</th>
                                        <th class="text-center grade-cell">Grade</th>
                                        <th class="text-center">Grade Points</th>
                                        <th class="text-center">Position</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for item in subject_results %}
                                    <tr class="{% if not item.has_result %}table-secondary{% endif %} {% if item.grade in 'AB' %}highlight-row{% endif %}">
                                        <td>{{ forloop.counter }}</td>
                                        <td>
                                            <strong>{{ item.subject.name }}</strong>
                                            {% if not item.has_result %}
                                            <br><small class="text-muted">No result</small>
                                            {% endif %}
                                        </td>
                                        <td>{{ item.subject.code }}</td>
                                        <td class="text-center">
                                            {% if item.has_result %}
                                            <span class="font-weight-bold">{{ item.marks|floatformat:1 }}</span>
                                            {% else %}
                                            <span class="text-muted">-</span>
                                            {% endif %}
                                        </td>
                                        <td class="text-center">
                                            {% if item.has_result and item.percentage %}
                                            <span class="font-weight-bold">{{ item.percentage|floatformat:1 }}%</span>
                                            {% else %}
                                            <span class="text-muted">-</span>
                                            {% endif %}
                                        </td>
                                        <td class="text-center grade-cell">
                                            {% if item.has_result and item.grade %}
                                            <span class="grade-badge grade-{{ item.grade }}">{{ item.grade }}</span>
                                            {% else %}
                                            <span class="text-muted">-</span>
                                            {% endif %}
                                        </td>
                                        <td class="text-center">
                                            {% if item.has_result and item.grade_point %}
                                            <span class="font-weight-bold">{{ item.grade_point|floatformat:1 }}</span>
                                            {% else %}
                                            <span class="text-muted">-</span>
                                            {% endif %}
                                        </td>
                                        <td class="text-center">
                                            {% if item.has_result and item.position %}
                                            <span class="badge badge-info">{{ item.position|ordinal }}</span>
                                            {% else %}
                                            <span class="text-muted">-</span>
                                            {% endif %}
                                        </td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                                <tfoot class="bg-light">
                                    <tr>
                                        <td colspan="3" class="text-right font-weight-bold">Totals/Averages:</td>
                                        <td class="text-center font-weight-bold">{{ overall_stats.total_marks|floatformat:1 }}</td>
                                        <td class="text-center font-weight-bold">{{ overall_stats.average_marks|floatformat:1 }}</td>
                                        <td class="text-center grade-cell">
                                            {% if metrics and metrics.average_grade %}
                                            <span class="grade-badge grade-{{ metrics.average_grade }}">{{ metrics.average_grade }}</span>
                                            {% else %}
                                            <span class="text-muted">-</span>
                                            {% endif %}
                                        </td>
                                        <td class="text-center font-weight-bold">{{ overall_stats.total_grade_points|floatformat:1 }}</td>
                                        <td class="text-center">
                                            {% if positions and positions.class_position %}
                                            <span class="badge badge-warning">{{ positions.class_position|ordinal }}</span>
                                            {% else %}
                                            <span class="text-muted">-</span>
                                            {% endif %}
                                        </td>
                                    </tr>
                                </tfoot>
                            </table>
                        </div>
                        {% else %}
                        <div class="text-center py-5">
                            <i class="fas fa-exclamation-circle fa-3x text-warning mb-3"></i>
                            <h4>No Results Available</h4>
                            <p class="text-muted">This student has no results recorded for this exam session.</p>
                        </div>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>
    </div>
</section>
{% endblock content %}

{% block extra_js %}
<script>
$(document).ready(function() {
    console.log('Student results page loaded');
    
    // Add tooltips
    $('[data-toggle="tooltip"]').tooltip();
    
    // Highlight grades with colors
    $('.grade-badge').each(function() {
        var grade = $(this).text().trim();
        var colorClass = 'grade-' + grade;
        $(this).addClass(colorClass);
    });
    
    // Add click event for PDF download
    $('.btn-pdf').click(function(e) {
        // Show loading indicator
        var originalText = $(this).html();
        $(this).html('<i class="fas fa-spinner fa-spin"></i> Generating PDF...');
        $(this).prop('disabled', true);
        
        // Restore button after 3 seconds if still on page
        setTimeout(function() {
            $('.btn-pdf').html(originalText);
            $('.btn-pdf').prop('disabled', false);
        }, 3000);
    });
    
    // Keyboard shortcuts
    $(document).keydown(function(e) {
        // Ctrl + P for print (disabled since we removed print button)
        // if (e.ctrlKey && e.keyCode === 80) {
        //     e.preventDefault();
        //     window.print();
        // }
        
        // Escape key to go back
        if (e.keyCode === 27) {
            window.history.back();
        }
    });
});
</script>
{% endblock extra_js %}