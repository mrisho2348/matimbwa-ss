{% extends 'admin/base.html' %}
{% load static %}
{% block title %} Exam Sessions Management {% endblock title %}

{% block breadcrumb %}
    <button type="button" class="btn btn-primary" data-toggle="modal" data-target="#addExamSessionModal">
        <i class="fas fa-plus"></i> Add Exam Session
    </button>
{% endblock breadcrumb %}

{% block extra_css %}
<style>
    .table th {
        font-weight: 600;
        border-bottom-width: 2px;
    }
    .table td {
        vertical-align: middle;
    }
    .badge {
        font-size: 0.85em;
        padding: 0.4em 0.8em;
    }
    .status-badge {
        border-radius: 12px;
        padding: 4px 12px;
        font-weight: 500;
    }
    .status-draft {
        background-color: #6c757d;
        color: white;
    }
    .status-submitted {
        background-color: #ffc107;
        color: #212529;
    }
    .status-verified {
        background-color: #17a2b8;
        color: white;
    }
    .status-published {
        background-color: #28a745;
        color: white;
    }
    .exam-date-cell {
        min-width: 100px;
    }
    .stream-info {
        font-size: 0.9em;
        color: #6c757d;
    }
    .quick-actions {
        display: flex;
        gap: 4px;
        justify-content: center;
        align-items: center;
    }
    .quick-action-btn {
        width: 28px;
        height: 28px;
        padding: 0;
        display: inline-flex;
        align-items: center;
        justify-content: center;
        border-radius: 50%;
        border: none;
        transition: all 0.2s ease;
        box-shadow: 0 1px 3px rgba(0,0,0,0.15);
    }
    .quick-action-btn i {
        font-size: 0.75rem;
        color: #ffffff !important;
    }
    .quick-action-btn:hover {
        transform: scale(1.1);
        box-shadow: 0 2px 5px rgba(0,0,0,0.2);
        filter: brightness(1.05);
    }
    .btn-info.quick-action-btn { background-color: #17a2b8; }
    .btn-primary.quick-action-btn { background-color: #007bff; }
    .btn-warning.quick-action-btn { background-color: #ffc107; }
    .btn-danger.quick-action-btn  { background-color: #dc3545; }
    .btn-success.quick-action-btn { background-color: #28a745; }
    .btn-secondary.quick-action-btn { background-color: #6c757d; }
    .btn-warning.quick-action-btn i {
        color: #212529 !important;
    }
    .filter-panel {
        background-color: #f8f9fa;
        border-radius: 8px;
        padding: 15px;
        margin-bottom: 20px;
        border: 1px solid #dee2e6;
        position: relative;
        z-index: 1 !important;
    }
    .filter-header {
        font-weight: 600;
        color: #495057;
        margin-bottom: 10px;
        padding-bottom: 8px;
        border-bottom: 2px solid #dee2e6;
    }
    .stat-card {
        border-radius: 8px;
        padding: 15px;
        margin-bottom: 15px;
        transition: transform 0.2s;
    }
    .stat-card:hover {
        transform: translateY(-2px);
    }
    .stat-card h5 {
        font-size: 0.9rem;
        text-transform: uppercase;
        letter-spacing: 1px;
        margin-bottom: 8px;
        color: #6c757d;
    }
    .stat-card h3 {
        font-weight: 700;
        margin-bottom: 5px;
    }
    .stat-card .stat-icon {
        font-size: 2rem;
        opacity: 0.8;
    }
    .success-toast, .error-toast {
        position: fixed;
        top: 20px;
        right: 20px;
        z-index: 99999 !important;
        min-width: 300px;
    }
    .modal {
        z-index: 1060 !important;
    }
    .modal-backdrop {
        z-index: 1050 !important;
    }
    .select2-container {
        z-index: 999999 !important;
    }
    .select2-dropdown {
        z-index: 999999 !important;
    }
    .modal .select2-container {
        z-index: 999999 !important;
    }
    #filter-academic-year + .select2-container,
    #filter-term + .select2-container,
    #filter-class-level + .select2-container,
    #filter-status + .select2-container,
    #filter-stream + .select2-container {
        z-index: 2 !important;
    }
    .modal-open #filter-academic-year + .select2-container,
    .modal-open #filter-term + .select2-container,
    .modal-open #filter-class-level + .select2-container,
    .modal-open #filter-status + .select2-container,
    .modal-open #filter-stream + .select2-container {
        z-index: 1 !important;
    }
    #exam_type + .select2-container,
    #academic_year + .select2-container,
    #term + .select2-container,
    #class_level + .select2-container,
    #status + .select2-container,
    #stream_class + .select2-container,
    #edit-exam_type + .select2-container,
    #edit-academic_year + .select2-container,
    #edit-term + .select2-container,
    #edit-class_level + .select2-container,
    #edit-stream_class + .select2-container {
        z-index: 999999 !important;
    }
    .dataTables_filter {
        float: right !important;
        margin-bottom: 15px;
    }
    .dataTables_filter input {
        margin-left: 10px !important;
    }
</style>
{% endblock extra_css %}

{% block content %}
<section class="content">
    <div class="container-fluid"> 
        <!-- Toast Messages -->
        <div id="success-toast" class="alert alert-success alert-dismissible fade success-toast" style="display: none;" role="alert">
            <strong><i class="fas fa-check-circle"></i> Success!</strong> 
            <span id="success-message"></span>
            <button type="button" class="close" onclick="$('#success-toast').fadeOut()" data-dismiss="alert" aria-label="Close">
                <span aria-hidden="true">&times;</span>
            </button>
        </div>

        <div id="error-toast" class="alert alert-danger alert-dismissible fade error-toast" style="display: none;" role="alert">
            <strong><i class="fas fa-exclamation-circle"></i> Error!</strong> 
            <span id="error-message"></span>
            <button type="button" class="close" onclick="$('#error-toast').fadeOut()" data-dismiss="alert" aria-label="Close">
                <span aria-hidden="true">&times;</span>
            </button>
        </div>

        <!-- Statistics Cards -->
        <div class="row mb-4">
            <div class="col-lg-3 col-md-6">
                <div class="stat-card bg-primary text-white">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <h5>Total Sessions</h5>
                            <h3 id="total-sessions">0</h3>
                        </div>
                        <div class="stat-icon">
                            <i class="fas fa-clipboard-list"></i>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-lg-3 col-md-6">
                <div class="stat-card bg-warning text-dark">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <h5>Draft</h5>
                            <h3 id="draft-sessions">0</h3>
                        </div>
                        <div class="stat-icon">
                            <i class="fas fa-edit"></i>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-lg-3 col-md-6">
                <div class="stat-card bg-info text-white">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <h5>Verified</h5>
                            <h3 id="verified-sessions">0</h3>
                        </div>
                        <div class="stat-icon">
                            <i class="fas fa-check-circle"></i>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-lg-3 col-md-6">
                <div class="stat-card bg-success text-white">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <h5>Published</h5>
                            <h3 id="published-sessions">0</h3>
                        </div>
                        <div class="stat-icon">
                            <i class="fas fa-globe"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Filter Panel -->
        <div class="filter-panel">
            <div class="row">
                <div class="col-md-12">
                    <div class="filter-header">
                        <i class="fas fa-filter"></i> Filter Exam Sessions
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="form-group">
                        <label for="filter-academic-year">Academic Year</label>
                        <select class="form-control select2bs4" id="filter-academic-year" style="width: 100%;">
                            <option value="">All Academic Years</option>
                            {% for year in academic_years %}
                                <option value="{{ year.id }}">{{ year.name }}</option>
                            {% endfor %}
                        </select>
                    </div>
                </div>
                <div class="col-md-2">
                    <div class="form-group">
                        <label for="filter-term">Term</label>
                        <select class="form-control select2bs4" id="filter-term" style="width: 100%;" disabled>
                            <option value="">All Terms</option>
                        </select>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="form-group">
                        <label for="filter-class-level">Class Level</label>
                        <select class="form-control select2bs4" id="filter-class-level" style="width: 100%;">
                            <option value="">All Classes</option>
                            {% for class_level in class_levels %}
                                <option value="{{ class_level.id }}">{{ class_level.name }}</option>
                            {% endfor %}
                        </select>
                    </div>
                </div>
                <div class="col-md-2">
                    <div class="form-group">
                        <label for="filter-stream">Stream (Optional)</label>
                        <select class="form-control select2bs4" id="filter-stream" style="width: 100%;" disabled>
                            <option value="">All Streams</option>
                        </select>
                    </div>
                </div>
                <div class="col-md-2">
                    <div class="form-group" style="margin-top: 28px;">
                        <button type="button" class="btn btn-secondary btn-block" id="reset-filters">
                            <i class="fas fa-redo"></i> Reset
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Main Table -->
        <div class="row">
            <div class="col-lg-12">
                <div class="card shadow-lg">
                    <div class="card-header bg-primary text-white d-flex justify-content-between align-items-center">
                        <h6 class="header-title mb-0 text-uppercase">
                            <i class="fas fa-clipboard-list"></i> Exam Sessions Management
                        </h6>
                        <div class="d-flex align-items-center">
                            <span class="badge badge-light mr-2">
                                Showing: <span id="showing-count">0</span> sessions
                            </span>
                        </div>
                    </div>
                    <div class="card-body">
                        <div class="table-responsive">
                            <table class="table table-hover text-nowrap table-responsive-sm table-bordered table-striped table-sm display" id="exam-sessions-table">
                                <thead class="bg-light">
                                    <tr>
                                        <th>Exam Session Name</th>
                                        <th>Type</th>
                                        <th>Academic Year</th>
                                        <th>Term</th>
                                        <th>Class & Stream</th>
                                        <th>Exam Date</th>
                                        <th>Status</th>
                                        <th>Created</th>
                                        <th class="text-center">Actions</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <!-- Data will be populated by DataTable via AJAX -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</section>

<!-- Add Exam Session Modal -->
<div class="modal fade" id="addExamSessionModal" tabindex="-1" role="dialog" aria-labelledby="addModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg" role="document">
        <div class="modal-content">
            <div class="modal-header bg-primary text-white">
                <h5 class="modal-title" id="addModalLabel">
                    <i class="fas fa-plus-circle"></i> Add New Exam Session
                </h5>
                <button type="button" class="close text-white" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <form id="add-form">
                {% csrf_token %}
                <div class="modal-body">
                    <div class="row">
                        <div class="col-md-8">
                            <div class="form-group">
                                <label for="name">Exam Session Name <span class="text-danger">*</span></label>
                                <input type="text" class="form-control" id="name" name="name" required 
                                       placeholder="e.g., Form 2 Midterm Term I 2025" maxlength="200">
                                <small class="form-text text-muted">Descriptive name for the exam session</small>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="form-group">
                                <label for="exam_type">Exam Type <span class="text-danger">*</span></label>
                                <select class="form-control select2bs4" id="exam_type" name="exam_type" required style="width: 100%;">
                                    <option value="">Select Exam Type</option>
                                    {% for exam_type in exam_types %}
                                        <option value="{{ exam_type.id }}">{{ exam_type.name }}</option>
                                    {% endfor %}
                                </select>
                            </div>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-4">
                            <div class="form-group">
                                <label for="academic_year">Academic Year <span class="text-danger">*</span></label>
                                <select class="form-control select2bs4" id="academic_year" name="academic_year" required style="width: 100%;">
                                    <option value="">Select Academic Year</option>
                                    {% for year in academic_years %}
                                        <option value="{{ year.id }}">{{ year.name }}</option>
                                    {% endfor %}
                                </select>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="form-group">
                                <label for="term">Term <span class="text-danger">*</span></label>
                                <select class="form-control select2bs4" id="term" name="term" required style="width: 100%;" disabled>
                                    <option value="">Select Academic Year First</option>
                                </select>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="form-group">
                                <label for="exam_date">Exam Date <span class="text-danger">*</span></label>
                                <input type="date" class="form-control" id="exam_date" name="exam_date" required>
                                <small class="form-text text-muted">Date when exams will be/were conducted</small>
                            </div>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-6">
                            <div class="form-group">
                                <label for="class_level">Class Level <span class="text-danger">*</span></label>
                                <select class="form-control select2bs4" id="class_level" name="class_level" required style="width: 100%;">
                                    <option value="">Select Class Level</option>
                                    {% for class_level in class_levels %}
                                        <option value="{{ class_level.id }}">{{ class_level.name }}</option>
                                    {% endfor %}
                                </select>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="form-group">
                                <label for="stream_class">Stream (Optional)</label>
                                <select class="form-control select2bs4" id="stream_class" name="stream_class" style="width: 100%;" disabled>
                                    <option value="">Select Class Level First</option>
                                </select>
                                <small class="form-text text-muted">Leave empty for all streams in the class</small>
                            </div>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-6">
                            <div class="form-group">
                                <label for="status">Status</label>
                                <select class="form-control select2bs4" id="status" name="status" style="width: 100%;">
                                    {% for status_code, status_name in status_choices %}
                                        <option value="{{ status_code }}" {% if status_code == 'draft' %}selected{% endif %}>
                                            {{ status_name }}
                                        </option>
                                    {% endfor %}
                                </select>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-dismiss="modal" id="cancel-add-btn">Cancel</button>
                    <button type="submit" class="btn btn-primary" id="save-btn">
                        <span class="spinner-border spinner-border-sm" role="status" aria-hidden="true" style="display: none;"></span>
                        Create Exam Session
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Edit Exam Session Modal -->
<div class="modal fade" id="editExamSessionModal" tabindex="-1" role="dialog" aria-labelledby="editModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg" role="document">
        <div class="modal-content">
            <div class="modal-header bg-warning text-dark">
                <h5 class="modal-title" id="editModalLabel">
                    <i class="fas fa-edit"></i> Edit Exam Session
                </h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <form id="edit-form">
                {% csrf_token %}
                <input type="hidden" id="edit-id" name="id">
                <div class="modal-body">
                    <div class="row">
                        <div class="col-md-8">
                            <div class="form-group">
                                <label for="edit-name">Exam Session Name <span class="text-danger">*</span></label>
                                <input type="text" class="form-control" id="edit-name" name="name" required 
                                       placeholder="e.g., Form 2 Midterm Term I 2025" maxlength="200">
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="form-group">
                                <label for="edit-exam_type">Exam Type <span class="text-danger">*</span></label>
                                <select class="form-control select2bs4" id="edit-exam_type" name="exam_type" required style="width: 100%;">
                                    <option value="">Select Exam Type</option>
                                    {% for exam_type in exam_types %}
                                        <option value="{{ exam_type.id }}">{{ exam_type.name }}</option>
                                    {% endfor %}
                                </select>
                            </div>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-4">
                            <div class="form-group">
                                <label for="edit-academic_year">Academic Year <span class="text-danger">*</span></label>
                                <select class="form-control select2bs4" id="edit-academic_year" name="academic_year" required style="width: 100%;">
                                    <option value="">Select Academic Year</option>
                                    {% for year in academic_years %}
                                        <option value="{{ year.id }}">{{ year.name }}</option>
                                    {% endfor %}
                                </select>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="form-group">
                                <label for="edit-term">Term <span class="text-danger">*</span></label>
                                <select class="form-control select2bs4" id="edit-term" name="term" required style="width: 100%;" disabled>
                                    <option value="">Select Academic Year First</option>
                                </select>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="form-group">
                                <label for="edit-exam_date">Exam Date <span class="text-danger">*</span></label>
                                <input type="date" class="form-control" id="edit-exam_date" name="exam_date" required>
                            </div>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-6">
                            <div class="form-group">
                                <label for="edit-class_level">Class Level <span class="text-danger">*</span></label>
                                <select class="form-control select2bs4" id="edit-class_level" name="class_level" required style="width: 100%;">
                                    <option value="">Select Class Level</option>
                                    {% for class_level in class_levels %}
                                        <option value="{{ class_level.id }}">{{ class_level.name }}</option>
                                    {% endfor %}
                                </select>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="form-group">
                                <label for="edit-stream_class">Stream (Optional)</label>
                                <select class="form-control select2bs4" id="edit-stream_class" name="stream_class" style="width: 100%;" disabled>
                                    <option value="">Select Class Level First</option>
                                </select>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-dismiss="modal" id="cancel-edit-btn">Cancel</button>
                    <button type="submit" class="btn btn-warning" id="update-btn">
                        <span class="spinner-border spinner-border-sm" role="status" aria-hidden="true" style="display: none;"></span>
                        Update Exam Session
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Delete Exam Session Modal -->
<div class="modal fade" id="deleteExamSessionModal" tabindex="-1" role="dialog" aria-labelledby="deleteModalLabel" aria-hidden="true">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header bg-danger text-white">
                <h5 class="modal-title" id="deleteModalLabel">
                    <i class="fas fa-exclamation-triangle"></i> Confirm Deletion
                </h5>
                <button type="button" class="close text-white" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <p>Are you sure you want to delete the exam session <strong id="delete-session-name"></strong>?</p>
                <p class="text-danger"><small>This action cannot be undone. All associated papers and results will also be deleted.</small></p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-dismiss="modal" id="cancel-delete-btn">Cancel</button>
                <button type="button" class="btn btn-danger" id="confirm-delete-btn">
                    <span class="spinner-border spinner-border-sm" role="status" aria-hidden="true" style="display: none;"></span>
                    Delete
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Status Change Confirmation Modal -->
<div class="modal fade" id="statusConfirmModal" tabindex="-1" role="dialog" aria-labelledby="statusConfirmLabel" aria-hidden="true">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header bg-info text-white">
                <h5 class="modal-title" id="statusConfirmLabel">
                    <i class="fas fa-exchange-alt"></i> Change Status
                </h5>
                <button type="button" class="close text-white" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <p id="status-confirm-message"></p>
                <p class="text-muted"><small>This action will change the workflow status of the exam session.</small></p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-info" id="confirm-status-btn">
                    <span class="spinner-border spinner-border-sm" role="status" aria-hidden="true" style="display: none;"></span>
                    Confirm
                </button>
            </div>
        </div>
    </div>
</div>
{% endblock content %}

{% block extra_js %}
<script>
$(document).ready(function() {
    // Initialize variables
    let sessionToDelete = null;
    let sessionToChangeStatus = null;
    let today = new Date().toISOString().split('T')[0];
    let table = null;
    
    // Set today as max date for exam date
    $('#exam_date, #edit-exam_date').attr('max', today);

    // CSRF token for AJAX requests
    function getCSRFToken() {
        return $('input[name="csrfmiddlewaretoken"]').val();
    }

    // Show toast message
    function showToast(message, type = 'success') {
        const toastId = type === 'success' ? '#success-toast' : '#error-toast';
        const messageId = type === 'success' ? '#success-message' : '#error-message';
        
        $(messageId).text(message);
        $(toastId).addClass('show').fadeIn();
        
        setTimeout(function() {
            $(toastId).fadeOut(function() {
                $(this).removeClass('show');
            });
        }, type === 'success' ? 3000 : 5000);
    }

    // Update statistics
    function updateStatistics() {
        if (!table) return;
        
        const data = table.rows({ search: 'applied' }).data();
        let total = 0, draft = 0, submitted = 0, verified = 0, published = 0;
        
        data.each(function(value, index) {
            total++;
            const status = value[6]; // Status column index
            if (status === 'draft') draft++;
            else if (status === 'submitted') submitted++;
            else if (status === 'verified') verified++;
            else if (status === 'published') published++;
        });
        
        $('#total-sessions').text(total);
        $('#draft-sessions').text(draft);
        $('#verified-sessions').text(verified);
        $('#published-sessions').text(published);
        $('#showing-count').text(total);
    }

    // Helper function to handle button loading state
    function setButtonLoading(btn, isLoading) {
        const spinner = btn.find('.spinner-border');
        if (isLoading) {
            btn.data('original-text', btn.html());
            btn.prop('disabled', true);
            spinner.show();
            btn.html('<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span>');
        } else {
            btn.prop('disabled', false);
            spinner.hide();
            btn.html(btn.data('original-text'));
        }
    }

    // Initialize Select2 for filter fields
    function initializeFilterSelect2(selector) {
        $(selector).select2({
            theme: 'bootstrap4',
            width: '100%',
            placeholder: 'Select an option',
            allowClear: true,
            dropdownParent: $('body')
        });
    }

    // Initialize filter select2
    initializeFilterSelect2('#filter-academic-year');
    initializeFilterSelect2('#filter-class-level');
    
    $('#filter-term').select2({
        theme: 'bootstrap4',
        width: '100%',
        placeholder: 'All Terms',
        allowClear: true,
        dropdownParent: $('body'),
        disabled: true
    });
    
    $('#filter-stream').select2({
        theme: 'bootstrap4',
        width: '100%',
        placeholder: 'All Streams',
        allowClear: true,
        dropdownParent: $('body'),
        disabled: true
    });

    // Function to load terms for academic year (for filter)
    function loadFilterTerms(academicYearId, targetSelect) {
        if (!academicYearId) {
            targetSelect.empty();
            targetSelect.append('<option value="">All Terms</option>');
            targetSelect.prop('disabled', true).trigger('change');
            return;
        }

        $.ajax({
            url: '{% url "admin_get_terms_for_academic_year" %}',
            method: 'GET',
            data: { 'academic_year_id': academicYearId },
            success: function(data) {
                if (data.success) {
                    targetSelect.empty();
                    targetSelect.append('<option value="">All Terms</option>');
                    $.each(data.terms, function(index, term) {
                        targetSelect.append(
                            $('<option>', {
                                value: term.id,
                                text: term.text
                            })
                        );
                    });
                    targetSelect.prop('disabled', false).trigger('change');
                } else {
                    console.error('Error loading terms:', data.message);
                    showToast('Failed to load terms.', 'danger');
                }
            },
            error: function(xhr, status, error) {
                console.error('AJAX Error:', error);
                showToast('Error loading terms.', 'danger');
            }
        });
    }

    // Function to load streams for class level (for filter)
    function loadFilterStreams(classLevelId, targetSelect) {
        if (!classLevelId) {
            targetSelect.empty();
            targetSelect.append('<option value="">All Streams</option>');
            targetSelect.prop('disabled', true).trigger('change');
            return;
        }

        $.ajax({
            url: '{% url "admin_get_streams_for_exam_session" %}',
            method: 'GET',
            data: { 'class_level_id': classLevelId },
            success: function(data) {
                if (data.success) {
                    targetSelect.empty();
                    targetSelect.append('<option value="">All Streams</option>');
                    $.each(data.streams, function(index, stream) {
                        targetSelect.append(
                            $('<option>', {
                                value: stream.id,
                                text: stream.text
                            })
                        );
                    });
                    targetSelect.prop('disabled', false).trigger('change');
                } else {
                    console.error('Error loading streams:', data.message);
                    showToast('Failed to load streams.', 'danger');
                }
            },
            error: function(xhr, status, error) {
                console.error('AJAX Error:', error);
                showToast('Error loading streams.', 'danger');
            }
        });
    }

    // Function to load terms for academic year (for modal forms)
    function loadModalTerms(academicYearId, targetSelect, selectedTermId = null) {
        if (!academicYearId) {
            targetSelect.empty();
            targetSelect.append('<option value="">Select Academic Year First</option>');
            targetSelect.prop('disabled', true).trigger('change');
            return;
        }

        $.ajax({
            url: '{% url "admin_get_terms_for_academic_year" %}',
            method: 'GET',
            data: { 'academic_year_id': academicYearId },
            success: function(data) {
                if (data.success) {
                    targetSelect.empty();
                    targetSelect.append('<option value="">Select Term</option>');
                    $.each(data.terms, function(index, term) {
                        const isSelected = (term.id == selectedTermId);
                        const option = new Option(term.text, term.id, false, isSelected);
                        targetSelect.append(option);
                    });
                    targetSelect.prop('disabled', false).trigger('change');
                } else {
                    console.error('Error loading terms:', data.message);
                    showToast('Failed to load terms.', 'danger');
                }
            },
            error: function(xhr, status, error) {
                console.error('AJAX Error:', error);
                showToast('Error loading terms.', 'danger');
            }
        });
    }

    // Function to load streams for class level (for modal forms)
    function loadModalStreams(classLevelId, targetSelect, selectedStreamId = null) {
        if (!classLevelId) {
            targetSelect.empty();
            targetSelect.append('<option value="">Select Class Level First</option>');
            targetSelect.prop('disabled', true).trigger('change');
            return;
        }

        $.ajax({
            url: '{% url "admin_get_streams_for_exam_session" %}',
            method: 'GET',
            data: { 'class_level_id': classLevelId },
            success: function(data) {
                if (data.success) {
                    targetSelect.empty();
                    targetSelect.append('<option value="">All Streams</option>');
                    $.each(data.streams, function(index, stream) {
                        const isSelected = (stream.id == selectedStreamId);
                        const option = new Option(stream.text, stream.id, false, isSelected);
                        targetSelect.append(option);
                    });
                    targetSelect.prop('disabled', false).trigger('change');
                } else {
                    console.error('Error loading streams:', data.message);
                    showToast('Failed to load streams.', 'danger');
                }
            },
            error: function(xhr, status, error) {
                console.error('AJAX Error:', error);
                showToast('Error loading streams.', 'danger');
            }
        });
    }

    // Load exam session data for editing
    function loadExamSessionForEdit(id) {
        console.log('Loading exam session for edit, ID:', id);
        
        $.ajax({
            url: '{% url "admin_get_exam_session_by_id" %}',
            method: 'GET',
            data: { 'exam_session_id': id },
            success: function(data) {
                console.log('Edit data received:', data);
                
                if (data.success && data.exam_session) {
                    const session = data.exam_session;
                    
                    // Set form values
                    $('#edit-id').val(session.id);
                    $('#edit-name').val(session.name);
                    $('#edit-exam_date').val(session.exam_date);
                    
                    // Set select values
                    setTimeout(function() {
                        $('#edit-exam_type').val(session.exam_type).trigger('change');
                        $('#edit-academic_year').val(session.academic_year).trigger('change');
                        $('#edit-class_level').val(session.class_level).trigger('change');
                        
                        // Load terms and streams
                        loadModalTerms(session.academic_year, $('#edit-term'), session.term);
                        loadModalStreams(session.class_level, $('#edit-stream_class'), session.stream_class);
                        
                        // Show modal
                        $('#editExamSessionModal').modal('show');
                    }, 100);
                    
                } else {
                    console.error('Failed to load data:', data.message);
                    showToast(data.message || 'Failed to load exam session data.', 'danger');
                }
            },
            error: function(xhr, status, error) {
                console.error('Error loading exam session:', error);
                showToast('Error loading exam session data. Please try again.', 'danger');
            }
        });
    }

    // Initialize DataTable with AJAX
    function initializeDataTable() {
        table = $('#exam-sessions-table').DataTable({
            "processing": true,
            "serverSide": true,
            "ajax": {
                "url": "{% url 'admin_exam_sessions_data' %}",
                "type": "GET",
                "data": function(d) {
                    // Add custom filter parameters
                    d.academic_year = $('#filter-academic-year').val();
                    d.term = $('#filter-term').val();
                    d.class_level = $('#filter-class-level').val();
                    d.stream = $('#filter-stream').val();
                    d.status = $('#filter-status').val();
                }
            },
            "columns": [
                { 
                    "data": "name",
                    "render": function(data, type, row) {
                        return '<strong>' + data + '</strong><br><small class="text-muted">' + row.exam_type_name + '</small>';
                    }
                },
                { 
                    "data": "exam_type_name",
                    "render": function(data) {
                        return '<span class="badge badge-info">' + data + '</span>';
                    }
                },
                { "data": "academic_year_name" },
                { "data": "term_display" },
                { 
                    "data": null,
                    "render": function(data, type, row) {
                        let html = '<strong>' + row.class_level_name + '</strong><br>';
                        if (row.stream_class_stream_letter) {
                            html += '<small class="stream-info"><i class="fas fa-stream"></i> ' + row.stream_class_stream_letter + '</small>';
                        } else {
                            html += '<small class="stream-info"><i class="fas fa-layer-group"></i> All Streams</small>';
                        }
                        return html;
                    }
                },
                { 
                    "data": "exam_date_formatted",
                    "render": function(data, type, row) {
                        let html = data + '<br>';
                        if (row.exam_date_status === 'past') {
                            html += '<small class="text-muted"><i class="fas fa-check text-success"></i> Past</small>';
                        } else if (row.exam_date_status === 'today') {
                            html += '<small class="text-muted"><i class="fas fa-clock text-warning"></i> Today</small>';
                        } else {
                            html += '<small class="text-muted"><i class="fas fa-calendar text-info"></i> Future</small>';
                        }
                        return html;
                    }
                },
                { 
                    "data": "status_display",
                    "render": function(data, type, row) {
                        let statusClass = '';
                        let icon = '';
                        
                        switch(row.status) {
                            case 'draft':
                                statusClass = 'status-draft';
                                icon = 'fas fa-edit';
                                break;
                            case 'submitted':
                                statusClass = 'status-submitted';
                                icon = 'fas fa-paper-plane';
                                break;
                            case 'verified':
                                statusClass = 'status-verified';
                                icon = 'fas fa-check-circle';
                                break;
                            case 'published':
                                statusClass = 'status-published';
                                icon = 'fas fa-globe';
                                break;
                        }
                        
                        return '<span class="status-badge ' + statusClass + '"><i class="' + icon + '"></i> ' + data + '</span>';
                    }
                },
                { 
                    "data": "created_at_formatted",
                    "render": function(data, type, row) {
                        return data + '<br><small class="text-muted">' + row.created_at_relative + ' ago</small>';
                    }
                },
                { 
                    "data": null,
                    "render": function(data, type, row) {
                        let html = '<div class="quick-actions">';
                        
                        // View Details
                        html += '<a href="/result/exam-sessions/' + row.id + '/" class="btn btn-sm btn-info quick-action-btn" title="View Details"><i class="fas fa-eye"></i></a>';
                        
                        // Manage Papers
                        html += '<a href="/result/exam-sessions/' + row.id + '/manage-result/" class="btn btn-sm btn-primary quick-action-btn" title="Manage Result"><i class="fas fa-file-alt"></i></a>';
                        
                        // Edit Button
                        if (row.status === 'draft' || row.status === 'submitted') {
                            html += '<button class="btn btn-sm btn-warning quick-action-btn edit-btn" data-id="' + row.id + '" title="Edit Exam Session"><i class="fas fa-edit"></i></button>';
                        } else {
                            html += '<button class="btn btn-sm btn-secondary quick-action-btn" disabled title="Cannot edit published/verified sessions"><i class="fas fa-edit"></i></button>';
                        }
                        
                        // Status Management
                        if (row.status === 'draft') {
                            html += '<button class="btn btn-sm btn-success quick-action-btn status-btn" data-id="' + row.id + '" data-current-status="draft" data-new-status="submitted" title="Submit for Review"><i class="fas fa-paper-plane"></i></button>';
                        } else if (row.status === 'submitted') {
                            html += '<button class="btn btn-sm btn-info quick-action-btn status-btn" data-id="' + row.id + '" data-current-status="submitted" data-new-status="verified" title="Mark as Verified"><i class="fas fa-check-circle"></i></button>';
                        } else if (row.status === 'verified') {
                            html += '<button class="btn btn-sm btn-success quick-action-btn status-btn" data-id="' + row.id + '" data-current-status="verified" data-new-status="published" title="Publish Results"><i class="fas fa-globe"></i></button>';
                        }
                        
                        // Delete Button
                        if (row.status === 'draft' || row.status === 'submitted') {
                            html += '<button class="btn btn-sm btn-danger quick-action-btn delete-btn" data-id="' + row.id + '" data-name="' + row.name + '" title="Delete Exam Session"><i class="fas fa-trash"></i></button>';
                        } else {
                            html += '<button class="btn btn-sm btn-secondary quick-action-btn" disabled title="Cannot delete published/verified sessions"><i class="fas fa-trash"></i></button>';
                        }
                        
                        html += '</div>';
                        return html;
                    },
                    "orderable": false,
                    "searchable": false
                }
            ],
            "order": [[5, 'desc']], // Sort by exam date descending
            "pageLength": 10,
            "responsive": true,
            "autoWidth": false,
            "destroy": true,
            "retrieve": true,
            "language": {
                "emptyTable": "<div class='text-center py-4'><i class='fas fa-inbox fa-2x mb-2'></i><br>No exam sessions found. Click \"Add Exam Session\" to create one.</div>",
                "search": "_INPUT_",
                "searchPlaceholder": "Search exam sessions...",
                "lengthMenu": "_MENU_ sessions per page",
                "info": "Showing _START_ to _END_ of _TOTAL_ sessions",
                "infoEmpty": "Showing 0 to 0 of 0 sessions",
                "infoFiltered": "(filtered from _MAX_ total sessions)",
                "paginate": {
                    "first": "First",
                    "last": "Last",
                    "next": "Next",
                    "previous": "Previous"
                }
            },
            "drawCallback": function(settings) {
                updateStatistics();
                // Reattach event handlers to dynamically created buttons
                attachEventHandlers();
            }
        });
    }

    // Attach event handlers to dynamically created elements
    function attachEventHandlers() {
        // Edit button
        $(document).off('click', '.edit-btn').on('click', '.edit-btn', function(e) {
            e.preventDefault();
            const id = $(this).data('id');
            if (id) {
                loadExamSessionForEdit(id);
            }
        });
        
        // Status button
        $(document).off('click', '.status-btn').on('click', '.status-btn', function(e) {
            e.preventDefault();
            const btn = $(this);
            sessionToChangeStatus = {
                id: btn.data('id'),
                currentStatus: btn.data('current-status'),
                newStatus: btn.data('new-status')
            };
            
            const statusMessages = {
                'draft': 'Are you sure you want to submit this exam session for review?',
                'submitted': 'Are you sure you want to mark this exam session as verified?',
                'verified': 'Are you sure you want to publish this exam session? Results will be visible to students.'
            };
            
            $('#status-confirm-message').text(statusMessages[sessionToChangeStatus.currentStatus] || 'Change status?');
            $('#statusConfirmModal').modal('show');
        });
        
        // Delete button
        $(document).off('click', '.delete-btn').on('click', '.delete-btn', function(e) {
            e.preventDefault();
            const btn = $(this);
            sessionToDelete = {
                id: btn.data('id'),
                name: btn.data('name')
            };
            
            $('#delete-session-name').text(btn.data('name'));
            $('#deleteExamSessionModal').modal('show');
        });
    }

    // Initialize DataTable
    initializeDataTable();

    // Filter functionality
    $('#filter-academic-year').on('change', function() {
        const academicYearId = $(this).val();
        const termSelect = $('#filter-term');
        
        if (academicYearId) {
            loadFilterTerms(academicYearId, termSelect);
        } else {
            termSelect.empty();
            termSelect.append('<option value="">All Terms</option>');
            termSelect.prop('disabled', true).trigger('change');
            $('#filter-stream').empty();
            $('#filter-stream').append('<option value="">All Streams</option>');
            $('#filter-stream').prop('disabled', true).trigger('change');
        }
        
        // Trigger DataTable reload with new filters
        table.ajax.reload();
    });

    $('#filter-class-level').on('change', function() {
        const classLevelId = $(this).val();
        const streamSelect = $('#filter-stream');
        
        if (classLevelId) {
            loadFilterStreams(classLevelId, streamSelect);
        } else {
            streamSelect.empty();
            streamSelect.append('<option value="">All Streams</option>');
            streamSelect.prop('disabled', true).trigger('change');
        }
        
        table.ajax.reload();
    });

    $('#filter-term, #filter-stream').on('change', function() {
        table.ajax.reload();
    });

    $('#reset-filters').on('click', function() {
        $('#filter-academic-year, #filter-class-level, #filter-term, #filter-stream').val('').trigger('change');
        $('#filter-term, #filter-stream').prop('disabled', true).trigger('change');
        $('#filter-term').empty().append('<option value="">All Terms</option>');
        $('#filter-stream').empty().append('<option value="">All Streams</option>');
        table.ajax.reload();
    });

    // Add Exam Session Modal
    $('#addExamSessionModal').on('shown.bs.modal', function() {
        $('#exam_type, #academic_year, #class_level, #status').select2({
            theme: 'bootstrap4',
            width: '100%',
            dropdownParent: $('#addExamSessionModal')
        });
    });

    // Load terms when academic year changes (add form)
    $('#academic_year').on('change', function() {
        const academicYearId = $(this).val();
        const termSelect = $('#term');
        
        if (academicYearId) {
            loadModalTerms(academicYearId, termSelect);
        } else {
            termSelect.empty();
            termSelect.append('<option value="">Select Academic Year First</option>');
            termSelect.prop('disabled', true).trigger('change');
        }
    });

    // Load streams when class level changes (add form)
    $('#class_level').on('change', function() {
        const classLevelId = $(this).val();
        const streamSelect = $('#stream_class');
        
        if (classLevelId) {
            loadModalStreams(classLevelId, streamSelect);
        } else {
            streamSelect.empty();
            streamSelect.append('<option value="">Select Class Level First</option>');
            streamSelect.prop('disabled', true).trigger('change');
        }
    });

    // Edit Exam Session Modal
    $('#editExamSessionModal').on('shown.bs.modal', function() {
        $('#edit-exam_type, #edit-academic_year, #edit-class_level, #edit-term, #edit-stream_class').select2({
            theme: 'bootstrap4',
            width: '100%',
            dropdownParent: $('#editExamSessionModal')
        });
    });

    // Load terms when academic year changes (edit form)
    $('#edit-academic_year').on('change', function() {
        const academicYearId = $(this).val();
        const termSelect = $('#edit-term');
        
        if (academicYearId) {
            loadModalTerms(academicYearId, termSelect);
        } else {
            termSelect.empty();
            termSelect.append('<option value="">Select Academic Year First</option>');
            termSelect.prop('disabled', true).trigger('change');
        }
    });

    // Load streams when class level changes (edit form)
    $('#edit-class_level').on('change', function() {
        const classLevelId = $(this).val();
        const streamSelect = $('#edit-stream_class');
        
        if (classLevelId) {
            loadModalStreams(classLevelId, streamSelect);
        } else {
            streamSelect.empty();
            streamSelect.append('<option value="">Select Class Level First</option>');
            streamSelect.prop('disabled', true).trigger('change');
        }
    });

    // Handle modal close/cancel buttons
    $(document).on('click', '[data-dismiss="modal"]', function(e) {
        e.preventDefault();
        $(this).closest('.modal').modal('hide');
    });

    // Add Exam Session
    $('#add-form').on('submit', function(e) {
        e.preventDefault();
        
        const saveBtn = $('#save-btn');
        setButtonLoading(saveBtn, true);
        
        const formData = new FormData(this);
        formData.append('action', 'create');
        
        $.ajax({
            url: '{% url "admin_exam_sessions_crud" %}',
            method: 'POST',
            headers: {
                'X-CSRFToken': getCSRFToken(),
                'X-Requested-With': 'XMLHttpRequest'
            },
            data: formData,
            processData: false,
            contentType: false,
            success: function(data) {
                if (data.success) {
                    $('#addExamSessionModal').modal('hide');
                    showToast(data.message, 'success');
                    table.ajax.reload(null, false); // Reload table without resetting pagination
                } else {
                    showToast(data.message, 'danger');
                }
                setButtonLoading(saveBtn, false);
            },
            error: function(xhr, status, error) {
                console.error('Error:', error);
                showToast('An error occurred while saving. Please try again.', 'danger');
                setButtonLoading(saveBtn, false);
            }
        });
    });

    // Edit Exam Session - Submit form
    $('#edit-form').on('submit', function(e) {
        e.preventDefault();
        
        const updateBtn = $('#update-btn');
        setButtonLoading(updateBtn, true);
        
        const formData = new FormData(this);
        formData.append('action', 'update');
        
        $.ajax({
            url: '{% url "admin_exam_sessions_crud" %}',
            method: 'POST',
            headers: {
                'X-CSRFToken': getCSRFToken(),
                'X-Requested-With': 'XMLHttpRequest'
            },
            data: formData,
            processData: false,
            contentType: false,
            success: function(data) {
                if (data.success) {
                    $('#editExamSessionModal').modal('hide');
                    showToast(data.message, 'success');
                    table.ajax.reload(null, false);
                } else {
                    showToast(data.message, 'danger');
                }
                setButtonLoading(updateBtn, false);
            },
            error: function(xhr, status, error) {
                console.error('Error:', error);
                showToast('An error occurred while updating. Please try again.', 'danger');
                setButtonLoading(updateBtn, false);
            }
        });
    });

    // Status Change - Confirm
    $('#confirm-status-btn').on('click', function() {
        if (!sessionToChangeStatus) return;
        
        const confirmBtn = $(this);
        setButtonLoading(confirmBtn, true);
        
        $.ajax({
            url: '{% url "admin_exam_sessions_crud" %}',
            method: 'POST',
            headers: {
                'X-CSRFToken': getCSRFToken(),
                'X-Requested-With': 'XMLHttpRequest'
            },
            data: {
                'action': 'toggle_status',
                'id': sessionToChangeStatus.id,
                'status': sessionToChangeStatus.newStatus,
                'csrfmiddlewaretoken': getCSRFToken()
            },
            success: function(data) {
                if (data.success) {
                    $('#statusConfirmModal').modal('hide');
                    showToast(data.message, 'success');
                    table.ajax.reload(null, false);
                } else {
                    showToast(data.message, 'danger');
                }
                setButtonLoading(confirmBtn, false);
                sessionToChangeStatus = null;
            },
            error: function(xhr, status, error) {
                console.error('Error:', error);
                showToast('An error occurred while changing status. Please try again.', 'danger');
                setButtonLoading(confirmBtn, false);
                sessionToChangeStatus = null;
            }
        });
    });

    // Delete Exam Session - Confirm
    $('#confirm-delete-btn').on('click', function() {
        if (!sessionToDelete) return;
        
        const deleteBtn = $(this);
        setButtonLoading(deleteBtn, true);
        
        $.ajax({
            url: '{% url "admin_exam_sessions_crud" %}',
            method: 'POST',
            headers: {
                'X-CSRFToken': getCSRFToken(),
                'X-Requested-With': 'XMLHttpRequest'
            },
            data: {
                'action': 'delete',
                'id': sessionToDelete.id,
                'csrfmiddlewaretoken': getCSRFToken()
            },
            success: function(data) {
                if (data.success) {
                    $('#deleteExamSessionModal').modal('hide');
                    showToast(data.message, 'success');
                    table.ajax.reload(null, false);
                } else {
                    showToast(data.message, 'danger');
                }
                setButtonLoading(deleteBtn, false);
                sessionToDelete = null;
            },
            error: function(xhr, status, error) {
                console.error('Error:', error);
                showToast('An error occurred while deleting. Please try again.', 'danger');
                setButtonLoading(deleteBtn, false);
                sessionToDelete = null;
            }
        });
    });

    // Clear form and reset button state on modal close
    $('#addExamSessionModal').on('hidden.bs.modal', function() {
        $('#add-form')[0].reset();
        $('#term, #stream_class').empty();
        $('#term').append('<option value="">Select Academic Year First</option>');
        $('#stream_class').append('<option value="">Select Class Level First</option>');
        $('#term, #stream_class').prop('disabled', true).trigger('change');
        setButtonLoading($('#save-btn'), false);
    });
    
    $('#editExamSessionModal').on('hidden.bs.modal', function() {
        $('#edit-form')[0].reset();
        $('#edit-term, #edit-stream_class').empty();
        $('#edit-term').append('<option value="">Select Academic Year First</option>');
        $('#edit-stream_class').append('<option value="">Select Class Level First</option>');
        $('#edit-term, #edit-stream_class').prop('disabled', true).trigger('change');
        setButtonLoading($('#update-btn'), false);
    });
    
    $('#deleteExamSessionModal').on('hidden.bs.modal', function() {
        sessionToDelete = null;
        setButtonLoading($('#confirm-delete-btn'), false);
    });
    
    $('#statusConfirmModal').on('hidden.bs.modal', function() {
        sessionToChangeStatus = null;
        setButtonLoading($('#confirm-status-btn'), false);
    });

    // Form validation
    $('#add-form, #edit-form').on('submit', function(e) {
        const isAddForm = $(this).attr('id') === 'add-form';
        const nameInput = isAddForm ? '#name' : '#edit-name';
        const examDateInput = isAddForm ? '#exam_date' : '#edit-exam_date';
        
        const name = $(nameInput).val().trim();
        const examDate = $(examDateInput).val();
        
        if (name.length < 5) {
            e.preventDefault();
            showToast('Exam session name must be at least 5 characters long.', 'danger');
            $(nameInput).addClass('is-invalid');
            return false;
        }
        
        if (!examDate) {
            e.preventDefault();
            showToast('Exam date is required.', 'danger');
            $(examDateInput).addClass('is-invalid');
            return false;
        }
        
        return true;
    });

    // Remove validation classes on input
    $('#name, #edit-name, #exam_date, #edit-exam_date').on('input', function() {
        $(this).removeClass('is-invalid');
    });
});
</script>
{% endblock extra_js %}