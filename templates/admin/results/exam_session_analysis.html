{% extends 'admin/base.html' %}
{% load static %}
{% load custom_filters %}
{% block title %} Exam Session Analysis {% endblock title %}

{% block breadcrumb %}
    <h5 class="mb-0">
        <i class="fas fa-chart-bar"></i> Exam Session Analysis - {{ exam_session.name }}
    </h5>
    <nav aria-label="breadcrumb">
        <ol class="breadcrumb">
            <li class="breadcrumb-item"><a href="{% url 'admin_exam_sessions_list_view' %}">Exam Sessions</a></li>
            <li class="breadcrumb-item active" aria-current="page">Analysis</li>
        </ol>
    </nav>
{% endblock breadcrumb %}

{% block extra_css %}
<style>
    .stat-card {
        border-radius: 8px;
        padding: 15px;
        margin-bottom: 15px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        transition: transform 0.2s;
        position: relative;
    }
    .stat-card:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 8px rgba(0,0,0,0.15);
    }
    .stat-card h5 {
        font-size: 0.9rem;
        text-transform: uppercase;
        letter-spacing: 1px;
        margin-bottom: 8px;
        color: #6c757d;
    }
    .stat-card h3 {
        font-weight: 700;
        margin-bottom: 5px;
    }
    .stat-card .stat-icon {
        font-size: 2rem;
        opacity: 0.8;
    }
    .stat-card .pdf-download-btn {
        position: absolute;
        top: 10px;
        right: 10px;
        opacity: 0.7;
        transition: opacity 0.2s;
        z-index: 1;
    }
    .stat-card:hover .pdf-download-btn {
        opacity: 1;
    }
    
    .filter-panel {
        background-color: #f8f9fa;
        border-radius: 8px;
        padding: 20px;
        margin-bottom: 25px;
        border: 1px solid #dee2e6;
    }
    .filter-header {
        font-weight: 600;
        color: #495057;
        margin-bottom: 15px;
        padding-bottom: 10px;
        border-bottom: 2px solid #dee2e6;
    }
    
    .analysis-section {
        background: white;
        border-radius: 8px;
        padding: 20px;
        margin-bottom: 25px;
        border: 1px solid #dee2e6;
        box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        position: relative;
    }
    .analysis-section .pdf-download-btn {
        position: absolute;
        top: 15px;
        right: 15px;
        opacity: 0.7;
        transition: opacity 0.2s;
        z-index: 1;
    }
    .analysis-section:hover .pdf-download-btn {
        opacity: 1;
    }
    .section-title {
        font-weight: 600;
        color: #495057;
        margin-bottom: 20px;
        padding-bottom: 10px;
        border-bottom: 2px solid #e9ecef;
        padding-right: 40px;
    }
    
    .distribution-badge {
        padding: 5px 12px;
        border-radius: 20px;
        font-weight: 500;
        margin-right: 8px;
        margin-bottom: 8px;
        display: inline-block;
    }
    
    .table td, .table th {
        vertical-align: middle;
    }
    
    .division-badge {
        padding: 4px 10px;
        border-radius: 12px;
        font-weight: 500;
        font-size: 0.85em;
    }
    .division-I { background-color: #28a745; color: white; }
    .division-II { background-color: #17a2b8; color: white; }
    .division-III { background-color: #ffc107; color: #212529; }
    .division-IV { background-color: #fd7e14; color: white; }
    .division-0 { background-color: #dc3545; color: white; }
    
    .rank-badge {
        display: inline-block;
        width: 30px;
        height: 30px;
        line-height: 30px;
        text-align: center;
        border-radius: 50%;
        font-weight: bold;
        font-size: 0.9em;
    }
    .rank-1 { background-color: #ffd700; color: #000; }
    .rank-2 { background-color: #c0c0c0; color: #000; }
    .rank-3 { background-color: #cd7f32; color: #000; }
    .rank-4-10 { background-color: #e9ecef; color: #495057; }
    
    .gender-icon {
        width: 24px;
        height: 24px;
        display: inline-flex;
        align-items: center;
        justify-content: center;
        border-radius: 50%;
        margin-right: 8px;
    }
    .gender-male { background-color: #d1ecf1; color: #0c5460; }
    .gender-female { background-color: #f8d7da; color: #721c24; }
    .gender-other { background-color: #e2e3e5; color: #383d41; }
    
    .download-btn {
        margin-left: 10px;
    }
    
    .no-data {
        text-align: center;
        padding: 40px 20px;
        color: #6c757d;
    }
    .no-data i {
        font-size: 3rem;
        margin-bottom: 15px;
        opacity: 0.5;
    }
    
    .form-group-sm label {
        font-weight: 500;
        font-size: 0.9em;
        margin-bottom: 5px;
    }
    
    @media print {
        .filter-panel, .download-btn, .no-print, .pdf-download-btn {
            display: none !important;
        }
        .analysis-section {
            break-inside: avoid;
            page-break-inside: avoid;
        }
    }
</style>
{% endblock extra_css %}

{% block content %}
<section class="content">
    <div class="container-fluid">
        <!-- Session Info Header -->
        <div class="row mb-4">
            <div class="col-12">
                <div class="card shadow-sm">
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-8">
                                <h4 class="mb-1">{{ exam_session.name }}</h4>
                                <p class="text-muted mb-1">
                                    <i class="fas fa-calendar-alt"></i> {{ exam_session.exam_date|date:"F d, Y" }} | 
                                    <i class="fas fa-graduation-cap"></i> {{ exam_session.class_level.name }}
                                    {% if exam_session.stream_class %}
                                        <span class="badge badge-info ml-2">{{ exam_session.stream_class.stream_letter }}</span>
                                    {% endif %}
                                </p>
                                <p class="text-muted mb-0">
                                    <i class="fas fa-school"></i> {{ exam_session.academic_year.name }} - 
                                    <i class="fas fa-layer-group"></i> {{ exam_session.term.get_term_number_display }} |
                                    <span class="badge badge-{{ exam_session.status }}">{{ exam_session.get_status_display }}</span>
                                </p>
                            </div>
                            <div class="col-md-4 text-right">
                                <a href="{% url 'admin_exam_sessions_list_view' %}" class="btn btn-outline-secondary">
                                    <i class="fas fa-arrow-left"></i> Back to Sessions
                                </a>
                                <button onclick="window.print()" class="btn btn-outline-primary no-print">
                                    <i class="fas fa-print"></i> Print
                                </button>
                                <!-- Full PDF Download -->
                                <a href="{% url 'exam_session_analysis_pdf' exam_session.id %}?section=full" 
                                   class="btn btn-danger no-print" target="_blank">
                                    <i class="fas fa-file-pdf"></i> Download Full PDF
                                </a>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Statistics Cards -->
        <div class="row mb-4">
            <div class="col-lg-3 col-md-6">
                <div class="stat-card bg-primary text-white">
                    <a href="{% url 'exam_session_analysis_pdf' exam_session.id %}?section=overview" 
                       class="btn btn-sm btn-light pdf-download-btn no-print" target="_blank" title="Download Overview PDF">
                        <i class="fas fa-file-pdf"></i>
                    </a>
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <h5>Total Students</h5>
                            <h3>{{ total_students }}</h3>
                            <small>{{ students_with_division }} with division assigned</small>
                        </div>
                        <div class="stat-icon">
                            <i class="fas fa-users"></i>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-lg-3 col-md-6">
                <div class="stat-card bg-success text-white">
                    <a href="{% url 'exam_session_analysis_pdf' exam_session.id %}?section=divisions" 
                       class="btn btn-sm btn-light pdf-download-btn no-print" target="_blank" title="Download Division Analysis PDF">
                        <i class="fas fa-file-pdf"></i>
                    </a>
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <h5>Unique Divisions</h5>
                            <h3>{{ division_distribution|length }}</h3>
                            <small>{% for division, count in division_distribution.items %}{% if forloop.first %}{{ division }}{% endif %}{% endfor %} most common</small>
                        </div>
                        <div class="stat-icon">
                            <i class="fas fa-chart-pie"></i>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-lg-3 col-md-6">
                <div class="stat-card bg-info text-white">
                    <a href="{% url 'exam_session_analysis_pdf' exam_session.id %}?section=genders" 
                       class="btn btn-sm btn-light pdf-download-btn no-print" target="_blank" title="Download Gender Analysis PDF">
                        <i class="fas fa-file-pdf"></i>
                    </a>
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <h5>Gender Groups</h5>
                            <h3>{{ gender_distribution|length }}</h3>
                            <small>{% for gender, count in gender_distribution.items %}{% if forloop.first %}{{ gender }}{% endif %}{% endfor %} largest group</small>
                        </div>
                        <div class="stat-icon">
                            <i class="fas fa-venus-mars"></i>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-lg-3 col-md-6">
                <div class="stat-card bg-warning text-dark">
                    <a href="{% url 'exam_session_analysis_pdf' exam_session.id %}?section=rankings" 
                       class="btn btn-sm btn-light pdf-download-btn no-print" target="_blank" title="Download Rankings PDF">
                        <i class="fas fa-file-pdf"></i>
                    </a>
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <h5>Ranked Students</h5>
                            <h3>{{ all_student_data|length }}</h3>
                            <small>All students ranked</small>
                        </div>
                        <div class="stat-icon">
                            <i class="fas fa-trophy"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Filter Panel -->
        <div class="filter-panel no-print">
            <div class="filter-header">
                <i class="fas fa-filter"></i> Filter Analysis Data
            </div>
            <form method="get" id="analysis-filters">
                <input type="hidden" name="exam_session_id" value="{{ exam_session.id }}">
                <div class="row">
                    <div class="col-md-3">
                        <div class="form-group form-group-sm">
                            <label for="division">Division</label>
                            <select class="form-control" id="division" name="division">
                                <option value="">All Divisions</option>
                                {% for division in unique_divisions %}
                                    <option value="{{ division }}" {% if division_filter == division %}selected{% endif %}>
                                        {{ division }}
                                    </option>
                                {% endfor %}
                            </select>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="form-group form-group-sm">
                            <label for="gender">Gender</label>
                            <select class="form-control" id="gender" name="gender">
                                <option value="">All Genders</option>
                                {% for gender in unique_genders %}
                                    <option value="{{ gender }}" {% if gender_filter == gender %}selected{% endif %}>
                                        {{ gender }}
                                    </option>
                                {% endfor %}
                            </select>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="form-group form-group-sm">
                            <label for="rank_filter">Rank Filter</label>
                            <select class="form-control" id="rank_filter" name="rank_filter">
                                {% for value, label in rank_filter_options %}
                                    <option value="{{ value }}" {% if rank_filter == value %}selected{% endif %}>
                                        {{ label }}
                                    </option>
                                {% endfor %}
                            </select>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="form-group form-group-sm" id="top_n_container" {% if rank_filter != 'top' %}style="display: none;"{% endif %}>
                            <label for="top_n">Top N Students</label>
                            <input type="number" class="form-control" id="top_n" name="top_n" 
                                   value="{{ top_n }}" min="1" max="100">
                        </div>
                        <div class="form-group form-group-sm" id="bottom_n_container" {% if rank_filter != 'bottom' %}style="display: none;"{% endif %}>
                            <label for="bottom_n">Bottom N Students</label>
                            <input type="number" class="form-control" id="bottom_n" name="bottom_n" 
                                   value="{{ bottom_n }}" min="1" max="100">
                        </div>
                    </div>
                </div>
                <div class="row mt-3">
                    <div class="col-md-12">
                        <div class="d-flex justify-content-between">
                            <div>
                                <button type="submit" class="btn btn-primary">
                                    <i class="fas fa-filter"></i> Apply Filters
                                </button>
                                <a href="?exam_session_id={{ exam_session.id }}" class="btn btn-outline-secondary">
                                    <i class="fas fa-redo"></i> Reset
                                </a>
                            </div>
                            <div>
                                <span class="badge badge-info">
                                    Showing {{ student_data|length }} of {{ total_students }} students
                                </span>
                            </div>
                        </div>
                    </div>
                </div>
            </form>
        </div>

        {% if student_data %}
            <!-- Distribution Analysis -->
            <div class="row">
                <div class="col-lg-6">
                    <div class="analysis-section">
                        <a href="{% url 'exam_session_analysis_pdf' exam_session.id %}?section=divisions_only" 
                           class="btn btn-sm btn-danger pdf-download-btn no-print" target="_blank" title="Download Division Analysis PDF">
                            <i class="fas fa-file-pdf"></i> PDF
                        </a>
                        <h5 class="section-title">
                            <i class="fas fa-chart-pie"></i> Division Distribution
                        </h5>
                        {% if division_distribution %}
                            <div class="mb-4">
                                {% for division, count in division_distribution.items %}
                                    <span class="distribution-badge 
                                        {% if division == 'Division I' %}bg-success text-white
                                        {% elif division == 'Division II' %}bg-info text-white
                                        {% elif division == 'Division III' %}bg-warning text-dark
                                        {% elif division == 'Division IV' %}bg-orange text-white
                                        {% else %}bg-danger text-white{% endif %}">
                                        {{ division }}: {{ count }} students
                                    </span>
                                {% endfor %}
                            </div>
                            <div class="table-responsive">
                                <table class="table table-sm table-hover">
                                    <thead class="bg-light">
                                        <tr>
                                            <th>Division</th>
                                            <th class="text-center">Students</th>
                                            <th class="text-center">Percentage</th>
                                            <th class="text-center">Avg. Marks</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        {% for division, count in division_distribution.items %}
                                        <tr>
                                            <td>
                                                <span class="division-badge division-{{ division|slice:"-1:" }}">
                                                    {{ division }}
                                                </span>
                                            </td>
                                            <td class="text-center">{{ count }}</td>
                                            <td class="text-center">
                                                {% widthratio count total_students 100 as percentage %}
                                                {{ count }}/{{ total_students }}
                                                ({{ percentage|floatformat:1 }}%)
                                            </td>
                                            <td class="text-center">
                                                {% if division_averages and division in division_averages %}
                                                    <strong>{{ division_averages|get_item:division|floatformat:2 }}</strong>
                                                {% else %}
                                                    <span class="text-muted">-</span>
                                                {% endif %}
                                            </td>
                                        </tr>
                                        {% endfor %}
                                    </tbody>
                                </table>
                            </div>
                        {% else %}
                            <div class="no-data">
                                <i class="fas fa-chart-pie"></i>
                                <p>No division data available</p>
                            </div>
                        {% endif %}
                    </div>
                </div>
                
                <div class="col-lg-6">
                    <div class="analysis-section">
                        <a href="{% url 'exam_session_analysis_pdf' exam_session.id %}?section=genders_only" 
                           class="btn btn-sm btn-danger pdf-download-btn no-print" target="_blank" title="Download Gender Analysis PDF">
                            <i class="fas fa-file-pdf"></i> PDF
                        </a>
                        <h5 class="section-title">
                            <i class="fas fa-venus-mars"></i> Gender Distribution
                        </h5>
                        {% if gender_distribution %}
                            <div class="mb-4">
                                {% for gender, count in gender_distribution.items %}
                                    <span class="distribution-badge 
                                        {% if gender == 'Male' %}bg-info text-white
                                        {% elif gender == 'Female' %}bg-pink text-white
                                        {% else %}bg-secondary text-white{% endif %}">
                                        <i class="fas fa-{% if gender == 'Male' %}mars{% elif gender == 'Female' %}venus{% else %}genderless{% endif %}"></i>
                                        {{ gender }}: {{ count }} students
                                    </span>
                                {% endfor %}
                            </div>
                            <div class="table-responsive">
                                <table class="table table-sm table-hover">
                                    <thead class="bg-light">
                                        <tr>
                                            <th>Gender</th>
                                            <th class="text-center">Students</th>
                                            <th class="text-center">Percentage</th>
                                            <th class="text-center">Avg. Marks</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        {% for gender, count in gender_distribution.items %}
                                        <tr>
                                            <td>
                                                <span class="gender-icon gender-{{ gender|lower }}">
                                                    <i class="fas fa-{% if gender == 'Male' %}mars{% elif gender == 'Female' %}venus{% else %}genderless{% endif %}"></i>
                                                </span>
                                                {{ gender }}
                                            </td>
                                            <td class="text-center">{{ count }}</td>
                                            <td class="text-center">
                                                {% widthratio count total_students 100 as percentage %}
                                                {{ count }}/{{ total_students }}
                                                ({{ percentage|floatformat:1 }}%)
                                            </td>
                                            <td class="text-center">
                                                {% if gender_averages and gender in gender_averages %}
                                                    <strong>{{ gender_averages|get_item:gender|floatformat:2 }}</strong>
                                                {% else %}
                                                    <span class="text-muted">-</span>
                                                {% endif %}
                                            </td>
                                        </tr>
                                        {% endfor %}
                                    </tbody>
                                </table>
                            </div>
                        {% else %}
                            <div class="no-data">
                                <i class="fas fa-venus-mars"></i>
                                <p>No gender data available</p>
                            </div>
                        {% endif %}
                    </div>
                </div>
            </div>

            <!-- Top & Bottom Performers -->
            <div class="row">
                <div class="col-lg-6">
                    <div class="analysis-section">
                        <a href="{% url 'exam_session_analysis_pdf' exam_session.id %}?section=top_performers" 
                           class="btn btn-sm btn-danger pdf-download-btn no-print" target="_blank" title="Download Top Performers PDF">
                            <i class="fas fa-file-pdf"></i> PDF
                        </a>
                        <h5 class="section-title">
                            <i class="fas fa-trophy text-warning"></i> Top 10 Performers
                            <small class="text-muted">(Always shows top 10 from all students)</small>
                        </h5>
                        {% if top_performers %}
                            <div class="table-responsive">
                                <table class="table table-sm table-hover">
                                    <thead class="bg-light">
                                        <tr>
                                            <th>Rank</th>
                                            <th>Student</th>
                                            <th class="text-center">Division</th>
                                            <th class="text-center">Avg. Marks</th>
                                            <th class="text-center">Grade Points</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        {% for student in top_performers %}
                                        <tr>
                                            <td>
                                                <span class="rank-badge 
                                                    {% if student.rank == 1 %}rank-1
                                                    {% elif student.rank == 2 %}rank-2
                                                    {% elif student.rank == 3 %}rank-3
                                                    {% else %}rank-4-10{% endif %}">
                                                    {{ student.rank }}
                                                </span>
                                            </td>
                                            <td>
                                                <strong>{{ student.registration_number }}</strong><br>
                                                <small class="text-muted">{{ student.full_name }}</small>
                                            </td>
                                            <td class="text-center">
                                                {% if student.division %}
                                                    <span class="division-badge division-{{ student.division|lower }}">
                                                        {{ student.division_display }}
                                                    </span>
                                                {% else %}
                                                    <span class="text-muted">-</span>
                                                {% endif %}
                                            </td>
                                            <td class="text-center">
                                                <strong>{{ student.average_marks|floatformat:2 }}</strong>
                                            </td>
                                            <td class="text-center">
                                                {{ student.total_grade_points|floatformat:1|default:"-" }}
                                            </td>
                                        </tr>
                                        {% endfor %}
                                    </tbody>
                                </table>
                            </div>
                        {% else %}
                            <div class="no-data">
                                <i class="fas fa-trophy"></i>
                                <p>No top performers data available</p>
                            </div>
                        {% endif %}
                    </div>
                </div>
                
                <div class="col-lg-6">
                    <div class="analysis-section">
                        <a href="{% url 'exam_session_analysis_pdf' exam_session.id %}?section=bottom_performers" 
                           class="btn btn-sm btn-danger pdf-download-btn no-print" target="_blank" title="Download Bottom Performers PDF">
                            <i class="fas fa-file-pdf"></i> PDF
                        </a>
                        <h5 class="section-title">
                            <i class="fas fa-exclamation-triangle text-danger"></i> Bottom 10 Performers
                            <small class="text-muted">(Always shows bottom 10 from all students)</small>
                        </h5>
                        {% if bottom_performers %}
                            <div class="table-responsive">
                                <table class="table table-sm table-hover">
                                    <thead class="bg-light">
                                        <tr>
                                            <th>Rank</th>
                                            <th>Student</th>
                                            <th class="text-center">Division</th>
                                            <th class="text-center">Avg. Marks</th>
                                            <th class="text-center">Grade Points</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        {% for student in bottom_performers %}
                                        <tr>
                                            <td>
                                                <span class="rank-badge rank-4-10">
                                                    {{ student.rank }}
                                                </span>
                                            </td>
                                            <td>
                                                <strong>{{ student.registration_number }}</strong><br>
                                                <small class="text-muted">{{ student.full_name }}</small>
                                            </td>
                                            <td class="text-center">
                                                {% if student.division %}
                                                    <span class="division-badge division-{{ student.division|lower }}">
                                                        {{ student.division_display }}
                                                    </span>
                                                {% else %}
                                                    <span class="text-muted">-</span>
                                                {% endif %}
                                            </td>
                                            <td class="text-center">
                                                <strong>{{ student.average_marks|floatformat:2 }}</strong>
                                            </td>
                                            <td class="text-center">
                                                {{ student.total_grade_points|floatformat:1|default:"-" }}
                                            </td>
                                        </tr>
                                        {% endfor %}
                                    </tbody>
                                </table>
                            </div>
                        {% else %}
                            <div class="no-data">
                                <i class="fas fa-exclamation-triangle"></i>
                                <p>No bottom performers data available</p>
                            </div>
                        {% endif %}
                    </div>
                </div>
            </div>

            <!-- Detailed Student List -->
            <div class="row">
                <div class="col-12">
                    <div class="analysis-section">
                        <a href="{% url 'exam_session_analysis_pdf' exam_session.id %}?section=detailed_list" 
                           class="btn btn-sm btn-danger pdf-download-btn no-print" target="_blank" title="Download Detailed List PDF">
                            <i class="fas fa-file-pdf"></i> PDF
                        </a>
                        <div class="d-flex justify-content-between align-items-center mb-3">
                            <h5 class="section-title mb-0">
                                <i class="fas fa-list"></i> Detailed Student Analysis
                                <span class="badge badge-light ml-2">{{ student_data|length }} students</span>
                            </h5>
                        </div>
                        
                        <div class="table-responsive">
                            <table class="table table-hover table-sm" id="student-analysis-table">
                                <thead class="thead-light">
                                    <tr>
                                        <th>#</th>
                                        <th>Student</th>
                                        <th class="text-center">Gender</th>
                                        <th class="text-center">Rank</th>
                                        <th class="text-center">Division</th>
                                        <th class="text-center">Total Marks</th>
                                        <th class="text-center">Avg. Marks</th>
                                        <th class="text-center">Avg. %</th>
                                        <th class="text-center">Grade Points</th>
                                        <th class="text-center">Avg. Grade</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for student in student_data %}
                                    <tr>
                                        <td>{{ forloop.counter }}</td>
                                        <td>
                                            <strong>{{ student.registration_number }}</strong><br>
                                            <small class="text-muted">{{ student.full_name }}</small>
                                        </td>
                                        <td class="text-center">
                                            <span class="gender-icon gender-{{ student.gender|lower }}">
                                                <i class="fas fa-{% if student.gender == 'Male' %}mars{% elif student.gender == 'Female' %}venus{% else %}genderless{% endif %}"></i>
                                            </span>
                                        </td>
                                        <td class="text-center">
                                            {% if student.rank %}
                                                <span class="badge badge-info">{{ student.rank }}</span>
                                            {% else %}
                                                <span class="text-muted">-</span>
                                            {% endif %}
                                        </td>
                                        <td class="text-center">
                                            {% if student.division %}
                                                <span class="division-badge division-{{ student.division }}">
                                                    {{ student.division_display }}
                                                </span>
                                            {% else %}
                                                <span class="text-muted">Not Assigned</span>
                                            {% endif %}
                                        </td>
                                        <td class="text-center">
                                            <strong>{{ student.total_marks|floatformat:2|default:"-" }}</strong>
                                        </td>
                                        <td class="text-center">
                                            {{ student.average_marks|floatformat:2|default:"-" }}
                                        </td>
                                        <td class="text-center">
                                            {% if student.average_percentage %}
                                                <span class="badge 
                                                    {% if student.average_percentage >= 80 %}badge-success
                                                    {% elif student.average_percentage >= 60 %}badge-info
                                                    {% elif student.average_percentage >= 40 %}badge-warning
                                                    {% else %}badge-danger{% endif %}">
                                                    {{ student.average_percentage|floatformat:1 }}%
                                                </span>
                                            {% else %}
                                                <span class="text-muted">-</span>
                                            {% endif %}
                                        </td>
                                        <td class="text-center">
                                            {{ student.total_grade_points|floatformat:1|default:"-" }}
                                        </td>
                                        <td class="text-center">
                                            {% if student.average_grade %}
                                                <span class="badge badge-secondary">{{ student.average_grade }}</span>
                                            {% else %}
                                                <span class="text-muted">-</span>
                                            {% endif %}
                                        </td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                        
                        {% if not student_data %}
                        <div class="no-data">
                            <i class="fas fa-search"></i>
                            <p>No students match the current filters</p>
                            <a href="?exam_session_id={{ exam_session.id }}" class="btn btn-outline-primary mt-2">
                                Clear Filters
                            </a>
                        </div>
                        {% endif %}
                    </div>
                </div>
            </div>
        {% else %}
            <!-- No Data Message -->
            <div class="row">
                <div class="col-12">
                    <div class="analysis-section">
                        <div class="no-data">
                            <i class="fas fa-chart-bar fa-3x mb-3"></i>
                            <h4>No Analysis Data Available</h4>
                            <p class="text-muted">There are no student metrics available for this exam session.</p>
                            <a href="{% url 'manage_results' exam_session.id %}" class="btn btn-primary">
                                <i class="fas fa-edit"></i> Enter Results
                            </a>
                        </div>
                    </div>
                </div>
            </div>
        {% endif %}
    </div>
</section>
{% endblock content %}

{% block extra_js %}
<script>
$(document).ready(function() {
    // Show/hide top_n/bottom_n inputs based on rank filter
    $('#rank_filter').change(function() {
        var value = $(this).val();
        if (value === 'top') {
            $('#top_n_container').show();
            $('#bottom_n_container').hide();
        } else if (value === 'bottom') {
            $('#top_n_container').hide();
            $('#bottom_n_container').show();
        } else {
            $('#top_n_container').hide();
            $('#bottom_n_container').hide();
        }
    });

    // Initialize DataTable for student analysis table
    $('#student-analysis-table').DataTable({
        "pageLength": 25,
        "lengthMenu": [[10, 25, 50, 100, -1], [10, 25, 50, 100, "All"]],
        "order": [[3, 'asc']], // Sort by rank by default
        "language": {
            "search": "_INPUT_",
            "searchPlaceholder": "Search students...",
            "lengthMenu": "_MENU_ records per page",
            "info": "Showing _START_ to _END_ of _TOTAL_ students",
            "infoEmpty": "Showing 0 to 0 of 0 students",
            "infoFiltered": "(filtered from _MAX_ total students)",
            "zeroRecords": "No matching students found"
        },
        "dom": '<"row"<"col-md-6"l><"col-md-6"f>>rt<"row"<"col-md-6"i><"col-md-6"p>>',
        "responsive": true
    });

    // Keyboard shortcuts
    $(document).keydown(function(e) {
        // Ctrl + F to focus search
        if (e.ctrlKey && e.keyCode === 70) {
            e.preventDefault();
            $('.dataTables_filter input').focus();
        }
        // Escape to clear search
        if (e.keyCode === 27) {
            $('.dataTables_filter input').val('').keyup();
        }
    });
});
</script>
{% endblock extra_js %}