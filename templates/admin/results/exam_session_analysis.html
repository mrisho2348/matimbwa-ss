{% extends 'admin/base.html' %}
{% load static %}
{% load custom_filters %}
{% block title %} Exam Session Analysis {% endblock title %}

{% block breadcrumb %}
    <h5 class="mb-0">
        <i class="fas fa-chart-bar"></i> Exam Session Analysis - {{ exam_session.name }}
    </h5>
    <nav aria-label="breadcrumb">
        <ol class="breadcrumb">
            <li class="breadcrumb-item"><a href="{% url 'admin_exam_sessions_list_view' %}">Exam Sessions</a></li>
            <li class="breadcrumb-item active" aria-current="page">Analysis</li>
        </ol>
    </nav>
{% endblock breadcrumb %}

{% block extra_css %}
<style>
    /* Statistics Cards */
    .stat-card {
        border-radius: 8px;
        padding: 15px;
        margin-bottom: 15px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        transition: transform 0.2s;
        position: relative;
    }
    .stat-card:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 8px rgba(0,0,0,0.15);
    }
    .stat-card h5 {
        font-size: 0.9rem;
        text-transform: uppercase;
        letter-spacing: 1px;
        margin-bottom: 8px;
        color: #6c757d;
    }
    .stat-card h3 {
        font-weight: 700;
        margin-bottom: 5px;
    }
    .stat-card .stat-icon {
        font-size: 2rem;
        opacity: 0.8;
    }
    .stat-card .pdf-download-btn {
        position: absolute;
        top: 10px;
        right: 10px;
        opacity: 0.7;
        transition: opacity 0.2s;
        z-index: 1;
    }
    .stat-card:hover .pdf-download-btn {
        opacity: 1;
    }
    
    /* Filter Panel */
    .filter-panel {
        background-color: #f8f9fa;
        border-radius: 8px;
        padding: 20px;
        margin-bottom: 25px;
        border: 1px solid #dee2e6;
    }
    .filter-header {
        font-weight: 600;
        color: #495057;
        margin-bottom: 15px;
        padding-bottom: 10px;
        border-bottom: 2px solid #dee2e6;
    }
    
    /* Analysis Sections */
    .analysis-section {
        background: white;
        border-radius: 8px;
        padding: 20px;
        margin-bottom: 25px;
        border: 1px solid #dee2e6;
        box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        position: relative;
    }
    .analysis-section .pdf-download-btn {
        position: absolute;
        top: 15px;
        right: 15px;
        opacity: 0.7;
        transition: opacity 0.2s;
        z-index: 1;
    }
    .analysis-section:hover .pdf-download-btn {
        opacity: 1;
    }
    .section-title {
        font-weight: 600;
        color: #495057;
        margin-bottom: 20px;
        padding-bottom: 10px;
        border-bottom: 2px solid #e9ecef;
        padding-right: 40px;
    }
    
    /* Badges and Indicators */
    .distribution-badge {
        padding: 5px 12px;
        border-radius: 20px;
        font-weight: 500;
        margin-right: 8px;
        margin-bottom: 8px;
        display: inline-block;
    }
    
    .division-badge {
        padding: 4px 10px;
        border-radius: 12px;
        font-weight: 500;
        font-size: 0.85em;
    }
    .division-I { background-color: #28a745; color: white; }
    .division-II { background-color: #17a2b8; color: white; }
    .division-III { background-color: #ffc107; color: #212529; }
    .division-IV { background-color: #fd7e14; color: white; }
    .division-0 { background-color: #dc3545; color: white; }
    .division-Not-Assigned { background-color: #6c757d; color: white; }
    
    .grade-badge {
        display: inline-block;
        padding: 4px 10px;
        border-radius: 12px;
        font-weight: 500;
        font-size: 0.85em;
        color: white;
    }
    .grade-A { background-color: #28a745; color: white; }
    .grade-B { background-color: #17a2b8; color: white; }
    .grade-C { background-color: #ffc107; color: #212529; }
    .grade-D { background-color: #fd7e14; color: white; }
    .grade-E { background-color: #6c757d; color: white; }
    .grade-F { background-color: #dc3545; color: white; }
    .grade-S { background-color: #6610f2; color: white; }
    
    .rank-badge {
        display: inline-block;
        width: 30px;
        height: 30px;
        line-height: 30px;
        text-align: center;
        border-radius: 50%;
        font-weight: bold;
        font-size: 0.9em;
    }
    .rank-1 { background-color: #ffd700; color: #000; }
    .rank-2 { background-color: #c0c0c0; color: #000; }
    .rank-3 { background-color: #cd7f32; color: #000; }
    .rank-4-10 { background-color: #e9ecef; color: #495057; }
    
    .gender-icon {
        width: 24px;
        height: 24px;
        display: inline-flex;
        align-items: center;
        justify-content: center;
        border-radius: 50%;
        margin-right: 8px;
    }
    .gender-male { background-color: #d1ecf1; color: #0c5460; }
    .gender-female { background-color: #f8d7da; color: #721c24; }
    .gender-other { background-color: #e2e3e5; color: #383d41; }
    
    .gender-badge {
        display: inline-block;
        padding: 4px 10px;
        border-radius: 12px;
        font-size: 0.85em;
        font-weight: 500;
        color: white;
    }
    .gender-male-badge { background-color: #007bff; }
    .gender-female-badge { background-color: #e83e8c; }
    .gender-other-badge { background-color: #6c757d; }
    
    /* Matrix Table Styles */
    .matrix-section {
        margin-top: 20px;
        margin-bottom: 30px;
    }
    
    .matrix-table {
        width: 100%;
        border-collapse: collapse;
        font-size: 0.9rem;
        box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        border-radius: 8px;
        overflow: hidden;
    }
    
    .matrix-table th {
        background: linear-gradient(135deg, #495057, #343a40);
        color: white;
        padding: 12px 8px;
        text-align: center;
        font-weight: 600;
        font-size: 0.85rem;
    }
    
    .matrix-table td {
        padding: 10px 6px;
        border: 1px solid #dee2e6;
        text-align: center;
        vertical-align: middle;
    }
    
    .matrix-table tr:nth-child(even) {
        background-color: #f8f9fa;
    }
    
    .matrix-table tr:hover {
        background-color: #e9ecef;
    }
    
    .matrix-table td:first-child {
        font-weight: 600;
        background: linear-gradient(to right, #f8f9fa, #e9ecef);
        text-align: left;
        padding-left: 12px;
    }
    
    .total-row {
        background: linear-gradient(135deg, #e9ecef, #dee2e6) !important;
        font-weight: bold;
        border-top: 2px solid #495057;
    }
    
    .total-row td {
        font-weight: 700;
    }
    
    .gender-total {
        background-color: #cce5ff !important;
        font-weight: 700;
        border-left: 2px solid #004085;
    }
    
    .grand-total {
        background: linear-gradient(135deg, #ffd54f, #ffb300) !important;
        font-weight: 700;
        color: #212529;
    }
    
    .zero-value {
        color: #6c757d;
        font-style: italic;
    }
    
    .matrix-caption {
        margin-top: 8px;
        font-size: 0.8rem;
        color: #6c757d;
        text-align: center;
        font-style: italic;
        padding: 8px;
        background-color: #f8f9fa;
        border-radius: 4px;
    }
    
    /* Table Styles */
    .table td, .table th {
        vertical-align: middle;
    }
    
    /* No Data Placeholder */
    .no-data {
        text-align: center;
        padding: 40px 20px;
        color: #6c757d;
    }
    .no-data i {
        font-size: 3rem;
        margin-bottom: 15px;
        opacity: 0.5;
    }
    
    /* Form Styles */
    .form-group-sm label {
        font-weight: 500;
        font-size: 0.9em;
        margin-bottom: 5px;
    }
    
    .download-btn {
        margin-left: 10px;
    }
    
    /* Print Styles */
    @media print {
        .filter-panel, .download-btn, .no-print, .pdf-download-btn {
            display: none !important;
        }
        .analysis-section {
            break-inside: avoid;
            page-break-inside: avoid;
        }
        .matrix-table {
            break-inside: avoid;
        }
    }
    
    /* Background Colors */
    .bg-pink {
        background-color: #e83e8c !important;
    }
    .bg-orange {
        background-color: #fd7e14 !important;
    }
</style>
{% endblock extra_css %}

{% block content %}
<section class="content">
    <div class="container-fluid">
        <!-- Session Info Header -->
        <div class="row mb-4">
            <div class="col-12">
                <div class="card shadow-sm">
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-8">
                                <h4 class="mb-1">{{ exam_session.name }}</h4>
                                <p class="text-muted mb-1">
                                    <i class="fas fa-calendar-alt"></i> {{ exam_session.exam_date|date:"F d, Y" }} | 
                                    <i class="fas fa-graduation-cap"></i> {{ exam_session.class_level.name }}
                                    {% if exam_session.stream_class %}
                                        <span class="badge badge-info ml-2">{{ exam_session.stream_class.stream_letter }}</span>
                                    {% endif %}
                                </p>
                                <p class="text-muted mb-0">
                                    <i class="fas fa-school"></i> {{ exam_session.academic_year.name }} - 
                                    <i class="fas fa-layer-group"></i> {{ exam_session.term.get_term_number_display }} |
                                    <span class="badge badge-{{ exam_session.status }}">{{ exam_session.get_status_display }}</span>
                                    <span class="badge badge-dark ml-2">{{ exam_session.class_level.educational_level.name }}</span>
                                </p>
                            </div>
                            <div class="col-md-4 text-right">
                                <a href="{% url 'admin_exam_sessions_list_view' %}" class="btn btn-outline-secondary">
                                    <i class="fas fa-arrow-left"></i> Back to Sessions
                                </a>
                                <button onclick="window.print()" class="btn btn-outline-primary no-print">
                                    <i class="fas fa-print"></i> Print
                                </button>
                                <a href="{% url 'exam_session_analysis_pdf' exam_session.id %}?section=full&{% if not is_primary_nursery %}division={{ division_filter|urlencode }}&{% endif %}{% if is_primary_nursery %}grade={{ grade_filter|urlencode }}&{% endif %}gender={{ gender_filter|urlencode }}&rank_filter={{ rank_filter|urlencode }}&top_n={{ top_n }}&bottom_n={{ bottom_n }}" 
                                   class="btn btn-danger no-print" target="_blank">
                                    <i class="fas fa-file-pdf"></i> Download Full PDF
                                </a>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Filter Panel -->
        <div class="filter-panel no-print">
            <div class="filter-header">
                <i class="fas fa-filter"></i> Filter Analysis Data
            </div>
            <form method="get" id="analysis-filters">
                <input type="hidden" name="exam_session_id" value="{{ exam_session.id }}">
                <div class="row">
                    <!-- Division Filter - Only show for non-Primary/Nursery -->
                    {% if not is_primary_nursery %}
                    <div class="col-md-3">
                        <div class="form-group form-group-sm">
                            <label for="division">Division</label>
                            <select class="form-control" id="division" name="division">
                                <option value="">All divisions</option>
                                {% for division in division_columns %}
                                    <option value="{{ division }}" {% if division_filter == division %}selected{% endif %}>
                                        {{ division }}
                                    </option>
                                {% endfor %}
                                <option value="Not Assigned" {% if division_filter == 'Not Assigned' %}selected{% endif %}>Not Assigned</option>
                            </select>
                        </div>
                    </div>
                    {% endif %}
                    
                    <!-- Grade Filter - Only show for Primary/Nursery -->
                    {% if is_primary_nursery %}
                    <div class="col-md-3">
                        <div class="form-group form-group-sm">
                            <label for="grade">Grade</label>
                            <select class="form-control" id="grade" name="grade">
                                <option value="">All grades</option>
                                {% for grade in grade_columns %}
                                    <option value="{{ grade }}" {% if grade_filter == grade %}selected{% endif %}>
                                        Grade {{ grade }}
                                    </option>
                                {% endfor %}
                                <option value="No Grade" {% if grade_filter == 'No Grade' %}selected{% endif %}>No Grade</option>
                            </select>
                        </div>
                    </div>
                    {% endif %}
                    
                    <!-- Gender Filter - Always show -->
                    <div class="col-md-3">
                        <div class="form-group form-group-sm">
                            <label for="gender">Gender</label>
                            <select class="form-control" id="gender" name="gender">
                                <option value="">All Genders</option>
                                {% for gender in unique_genders %}
                                    <option value="{{ gender }}" {% if gender_filter == gender %}selected{% endif %}>
                                        {{ gender }}
                                    </option>
                                {% endfor %}
                            </select>
                        </div>
                    </div>
                    
                    <!-- Rank Filter - Always show -->
                    <div class="col-md-3">
                        <div class="form-group form-group-sm">
                            <label for="rank_filter">Rank Filter</label>
                            <select class="form-control" id="rank_filter" name="rank_filter">
                                {% for value, label in rank_filter_options %}
                                    <option value="{{ value }}" {% if rank_filter == value %}selected{% endif %}>
                                        {{ label }}
                                    </option>
                                {% endfor %}
                            </select>
                        </div>
                    </div>
                    
                    <!-- N Filter Inputs -->
                    <div class="col-md-3">
                        <div class="form-group form-group-sm" id="top_n_container" {% if rank_filter != 'top' %}style="display: none;"{% endif %}>
                            <label for="top_n">Top N Students</label>
                            <input type="number" class="form-control" id="top_n" name="top_n" 
                                   value="{{ top_n }}" min="1" max="100">
                        </div>
                        <div class="form-group form-group-sm" id="bottom_n_container" {% if rank_filter != 'bottom' %}style="display: none;"{% endif %}>
                            <label for="bottom_n">Bottom N Students</label>
                            <input type="number" class="form-control" id="bottom_n" name="bottom_n" 
                                   value="{{ bottom_n }}" min="1" max="100">
                        </div>
                    </div>
                </div>
                <div class="row mt-3">
                    <div class="col-md-12">
                        <div class="d-flex justify-content-between">
                            <div>
                                <button type="submit" class="btn btn-primary">
                                    <i class="fas fa-filter"></i> Apply Filters
                                </button>
                                <a href="?exam_session_id={{ exam_session.id }}" class="btn btn-outline-secondary">
                                    <i class="fas fa-redo"></i> Reset
                                </a>
                            </div>
                            <div>
                                <span class="badge badge-info">
                                    Showing {{ student_data|length }} of {{ total_students_all }} students
                                </span>
                            </div>
                        </div>
                    </div>
                </div>
            </form>
        </div>

        <!-- Current Active Filters Display -->
        {% if division_filter or grade_filter or gender_filter or rank_filter %}
        <div class="row mb-3">
            <div class="col-12">
                <div class="alert alert-info no-print">
                    <i class="fas fa-filter"></i> <strong>Active Filters:</strong>
                    {% if not is_primary_nursery %}
                        {% if division_filter %} Division: <span class="badge badge-primary">{{ division_filter }}</span> {% endif %}
                    {% endif %}
                    {% if is_primary_nursery %}
                        {% if grade_filter %} Grade: <span class="badge badge-primary">{{ grade_filter }}</span> {% endif %}
                    {% endif %}
                    {% if gender_filter %} Gender: <span class="badge badge-primary">{{ gender_filter }}</span> {% endif %}
                    {% if rank_filter == 'top' %} Rank: <span class="badge badge-primary">Top {{ top_n }} Students</span> {% endif %}
                    {% if rank_filter == 'bottom' %} Rank: <span class="badge badge-primary">Bottom {{ bottom_n }} Students</span> {% endif %}
                    <a href="?exam_session_id={{ exam_session.id }}" class="float-right text-danger">
                        <i class="fas fa-times-circle"></i> Clear All Filters
                    </a>
                </div>
            </div>
        </div>
        {% endif %}

        {% if student_data %}
            <!-- Cross-Analysis Matrix - Conditional based on Education Level -->
            {% if is_primary_nursery %}
                <!-- Grade × Gender Cross-Analysis Matrix for Primary/Nursery -->
                <div class="matrix-section">
                    <div class="analysis-section">
                        <a href="{% url 'exam_session_analysis_pdf' exam_session.id %}?section=grades_only&grade={{ grade_filter|urlencode }}&gender={{ gender_filter|urlencode }}&rank_filter={{ rank_filter|urlencode }}&top_n={{ top_n }}&bottom_n={{ bottom_n }}" 
                           class="btn btn-sm btn-danger pdf-download-btn no-print" target="_blank" title="Download Grade × Gender Analysis PDF">
                            <i class="fas fa-file-pdf"></i> PDF
                        </a>
                        <h5 class="section-title">
                            <i class="fas fa-table"></i> Grade × Gender Cross-Analysis Matrix
                            <small class="text-muted">(All students - unfiltered)</small>
                        </h5>
                        <div class="alert alert-info">
                            <i class="fas fa-info-circle"></i> Division analysis is not applicable for {{ exam_session.class_level.educational_level.name }} level. Showing grade distribution instead.
                        </div>
                        <div class="table-responsive">
                            <table class="matrix-table table table-hover text-nowrap table-responsive-sm table-bordered table-striped table-sm result-table">
                                <thead>
                                    <tr>
                                        <th>Gender \ Grade</th>
                                        {% for grade in grade_columns %}
                                            <th>{{ grade }}</th>
                                        {% endfor %}
                                        <th>Total (Gender)</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for gender, row in grade_gender_matrix.items %}
                                        <tr>
                                            <td>
                                                <span class="gender-badge gender-{{ gender|lower }}-badge">
                                                    <i class="fas fa-{% if gender == 'Male' %}mars{% elif gender == 'Female' %}venus{% else %}genderless{% endif %} mr-1"></i>
                                                    {{ gender }}
                                                </span>
                                            </td>
                                            {% for grade in grade_columns %}
                                                <td>
                                                    {% with count=row|get_item:grade %}
                                                        {% if count > 0 %}
                                                            <span class="text-bold">{{ count }}</span>
                                                        {% else %}
                                                            <span class="zero-value">-</span>
                                                        {% endif %}
                                                    {% endwith %}
                                                </td>
                                            {% endfor %}
                                            <td class="gender-total">
                                                <strong>{{ gender_totals|get_item:gender|default:0 }}</strong>
                                            </td>
                                        </tr>
                                    {% endfor %}

                                    <tr class="total-row">
                                        <td>
                                            <span style="background-color: #495057; color: white; padding: 5px 12px; border-radius: 20px;">
                                                <strong>TOTAL</strong>
                                            </span>
                                        </td>
                                        {% for grade in grade_columns %}
                                            <td>
                                                {% with total=grade_totals|get_item:grade|default:0 %}
                                                    {% if total > 0 %}
                                                        <span style="background-color: #ffd54f; color: #212529; padding: 4px 10px; border-radius: 20px; font-weight: 700;">
                                                            {{ total }}
                                                        </span>
                                                    {% else %}
                                                        <span class="zero-value">{{ total }}</span>
                                                    {% endif %}
                                                {% endwith %}
                                            </td>
                                        {% endfor %}
                                        <td class="grand-total">
                                            <span style="background-color: #ffb300; color: #212529; padding: 4px 12px; border-radius: 20px; font-weight: 700;">
                                                {{ grand_total }}
                                            </span>
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                        <div class="matrix-caption">
                            <i class="fas fa-info-circle"></i> Cross-analysis showing student distribution by gender and grade. 
                            <strong>Zero values (-)</strong> indicate no students in that category. 
                            <strong>Total students with grade assigned: {{ grand_total }}</strong>
                        </div>
                    </div>
                </div>
            {% else %}
                <!-- Division × Gender Cross-Analysis Matrix for Secondary levels -->
                {% if division_columns %}
                <div class="matrix-section">
                    <div class="analysis-section">
                        <a href="{% url 'exam_session_analysis_pdf' exam_session.id %}?section=divisions_only&division={{ division_filter|urlencode }}&gender={{ gender_filter|urlencode }}&rank_filter={{ rank_filter|urlencode }}&top_n={{ top_n }}&bottom_n={{ bottom_n }}" 
                           class="btn btn-sm btn-danger pdf-download-btn no-print" target="_blank" title="Download Division × Gender Analysis PDF">
                            <i class="fas fa-file-pdf"></i> PDF
                        </a>
                        <h5 class="section-title">
                            <i class="fas fa-table"></i> Division × Gender Cross-Analysis Matrix
                            <small class="text-muted">(All students - unfiltered)</small>
                        </h5>
                        <div class="table-responsive">
                            <table class="matrix-table table table-hover text-nowrap table-responsive-sm table-bordered table-striped table-sm result-table">
                                <thead>
                                    <tr>
                                        <th>Gender \ Division</th>
                                        {% for division in division_columns %}
                                            <th>{{ division }}</th>
                                        {% endfor %}
                                        <th>Total (Gender)</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for gender, row in division_gender_matrix.items %}
                                        <tr>
                                            <td>
                                                <span class="gender-badge gender-{{ gender|lower }}-badge">
                                                    <i class="fas fa-{% if gender == 'Male' %}mars{% elif gender == 'Female' %}venus{% else %}genderless{% endif %} mr-1"></i>
                                                    {{ gender }}
                                                </span>
                                            </td>
                                            {% for division in division_columns %}
                                                <td>
                                                    {% with count=row|get_item:division %}
                                                        {% if count > 0 %}
                                                            <span class="text-bold">{{ count }}</span>
                                                        {% else %}
                                                            <span class="zero-value">-</span>
                                                        {% endif %}
                                                    {% endwith %}
                                                </td>
                                            {% endfor %}
                                            <td class="gender-total">
                                                <strong>{{ gender_totals|get_item:gender|default:0 }}</strong>
                                            </td>
                                        </tr>
                                    {% endfor %}

                                    <tr class="total-row">
                                        <td>
                                            <span style="background-color: #495057; color: white; padding: 5px 12px; border-radius: 20px;">
                                                <strong>TOTAL</strong>
                                            </span>
                                        </td>
                                        {% for division in division_columns %}
                                            <td>
                                                {% with total=division_totals|get_item:division|default:0 %}
                                                    {% if total > 0 %}
                                                        <span style="background-color: #ffd54f; color: #212529; padding: 4px 10px; border-radius: 20px; font-weight: 700;">
                                                            {{ total }}
                                                        </span>
                                                    {% else %}
                                                        <span class="zero-value">{{ total }}</span>
                                                    {% endif %}
                                                {% endwith %}
                                            </td>
                                        {% endfor %}
                                        <td class="grand-total">
                                            <span style="background-color: #ffb300; color: #212529; padding: 4px 12px; border-radius: 20px; font-weight: 700;">
                                                {{ grand_total }}
                                            </span>
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                        <div class="matrix-caption">
                            <i class="fas fa-info-circle"></i> Cross-analysis showing student distribution by gender and division. 
                            <strong>Zero values (-)</strong> indicate no students in that category. 
                            <strong>Total students with division assigned: {{ grand_total }}</strong>
                        </div>
                    </div>
                </div>
                {% endif %}
            {% endif %}

            <!-- Top & Bottom Performers -->
            <div class="row">
                <div class="col-lg-6">
                    <div class="analysis-section">
                        <a href="{% url 'exam_session_analysis_pdf' exam_session.id %}?section=top_performers&{% if not is_primary_nursery %}division={{ division_filter|urlencode }}&{% endif %}{% if is_primary_nursery %}grade={{ grade_filter|urlencode }}&{% endif %}gender={{ gender_filter|urlencode }}&rank_filter={{ rank_filter|urlencode }}&top_n={{ top_n }}&bottom_n={{ bottom_n }}" 
                           class="btn btn-sm btn-danger pdf-download-btn no-print" target="_blank" title="Download Top Performers PDF">
                            <i class="fas fa-file-pdf"></i> PDF
                        </a>
                        <h5 class="section-title">
                            <i class="fas fa-trophy text-warning"></i> Top 10 Performers
                            <small class="text-muted">(All students - unfiltered)</small>
                        </h5>
                        {% if top_performers %}
                            <div class="table-responsive">
                                <table class="table table-hover text-nowrap table-responsive-sm table-bordered table-striped table-sm result-table">
                                    <thead class="bg-light">
                                        <tr>
                                            <th>Rank</th>
                                            <th>Student</th>
                                            <th class="text-center">Gender</th>
                                            <th class="text-center">
                                                {% if is_primary_nursery %}Total Marks{% else %}Division{% endif %}
                                            </th>
                                            <th class="text-center">Avg. Marks</th>
                                            <th class="text-center">
                                                {% if is_primary_nursery %}Grade{% else %}Grade Points{% endif %}
                                            </th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        {% for student in top_performers %}
                                        <tr>
                                            <td>
                                                <span class="rank-badge 
                                                    {% if student.rank == 1 %}rank-1
                                                    {% elif student.rank == 2 %}rank-2
                                                    {% elif student.rank == 3 %}rank-3
                                                    {% else %}rank-4-10{% endif %}">
                                                    {{ student.rank }}
                                                </span>
                                            </td>
                                            <td>
                                                <strong>{{ student.registration_number }}</strong><br>
                                                <small class="text-muted">{{ student.full_name|truncatechars:20 }}</small>
                                            </td>
                                            <td class="text-center">
                                                <span class="gender-icon gender-{{ student.gender|lower }}">
                                                    <i class="fas fa-{% if student.gender == 'Male' %}mars{% elif student.gender == 'Female' %}venus{% else %}genderless{% endif %}"></i>
                                                </span>
                                            </td>
                                            <td class="text-center">
                                                {% if not is_primary_nursery and student.division %}
                                                    <span class="division-badge division-{{ student.division }}">
                                                        {{ student.division_display }}
                                                    </span>
                                                {% elif is_primary_nursery %}
                                                    <strong>{{ student.total_marks|floatformat:2|default:"-" }}</strong>
                                                {% else %}
                                                    <span class="badge badge-secondary">Not Assigned</span>
                                                {% endif %}
                                            </td>
                                            <td class="text-center">
                                                <strong>{{ student.average_marks|floatformat:2 }}</strong>
                                            </td>
                                            <td class="text-center">
                                                {% if is_primary_nursery %}
                                                    <span class="grade-badge grade-{{ student.average_grade }}">
                                                        {{ student.average_grade }}
                                                    </span>
                                                {% else %}
                                                    <strong>{{ student.total_grade_points|floatformat:1|default:"-" }}</strong>
                                                {% endif %}
                                            </td>
                                        </tr>
                                        {% endfor %}
                                    </tbody>
                                </table>
                            </div>
                        {% else %}
                            <div class="no-data">
                                <i class="fas fa-trophy"></i>
                                <p>No top performers data available</p>
                            </div>
                        {% endif %}
                    </div>
                </div>
                
                <div class="col-lg-6">
                    <div class="analysis-section">
                        <a href="{% url 'exam_session_analysis_pdf' exam_session.id %}?section=bottom_performers&{% if not is_primary_nursery %}division={{ division_filter|urlencode }}&{% endif %}{% if is_primary_nursery %}grade={{ grade_filter|urlencode }}&{% endif %}gender={{ gender_filter|urlencode }}&rank_filter={{ rank_filter|urlencode }}&top_n={{ top_n }}&bottom_n={{ bottom_n }}" 
                           class="btn btn-sm btn-danger pdf-download-btn no-print" target="_blank" title="Download Bottom Performers PDF">
                            <i class="fas fa-file-pdf"></i> PDF
                        </a>
                        <h5 class="section-title">
                            <i class="fas fa-exclamation-triangle text-danger"></i> Bottom 10 Performers
                            <small class="text-muted">(All students - unfiltered)</small>
                        </h5>
                        {% if bottom_performers %}
                            <div class="table-responsive">
                                <table class="table table-hover text-nowrap table-responsive-sm table-bordered table-striped table-sm result-table">
                                    <thead class="bg-light">
                                        <tr>
                                            <th>Rank</th>
                                            <th>Student</th>
                                            <th class="text-center">Gender</th>
                                            <th class="text-center">
                                                {% if is_primary_nursery %}Total Marks{% else %}Division{% endif %}
                                            </th>
                                            <th class="text-center">Avg. Marks</th>
                                            <th class="text-center">
                                                {% if is_primary_nursery %}Grade{% else %}Grade Points{% endif %}
                                            </th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        {% for student in bottom_performers %}
                                        <tr>
                                            <td>
                                                <span class="rank-badge rank-4-10">
                                                    {{ student.rank }}
                                                </span>
                                            </td>
                                            <td>
                                                <strong>{{ student.registration_number }}</strong><br>
                                                <small class="text-muted">{{ student.full_name|truncatechars:20 }}</small>
                                            </td>
                                            <td class="text-center">
                                                <span class="gender-icon gender-{{ student.gender|lower }}">
                                                    <i class="fas fa-{% if student.gender == 'Male' %}mars{% elif student.gender == 'Female' %}venus{% else %}genderless{% endif %}"></i>
                                                </span>
                                            </td>
                                            <td class="text-center">
                                                {% if not is_primary_nursery and student.division %}
                                                    <span class="division-badge division-{{ student.division }}">
                                                        {{ student.division_display }}
                                                    </span>
                                                {% elif is_primary_nursery %}
                                                    <strong>{{ student.total_marks|floatformat:2 }}</strong>
                                                {% else %}
                                                    <span class="badge badge-secondary">Not Assigned</span>
                                                {% endif %}
                                            </td>
                                            <td class="text-center">
                                                <strong>{{ student.average_marks|floatformat:2 }}</strong>
                                            </td>
                                            <td class="text-center">
                                                {% if is_primary_nursery %}
                                                    <span class="grade-badge grade-{{ student.average_grade }}">
                                                        {{ student.average_grade }}
                                                    </span>
                                                {% else %}
                                                    <strong>{{ student.total_grade_points|floatformat:1|default:"-" }}</strong>
                                                {% endif %}
                                            </td>
                                        </tr>
                                        {% endfor %}
                                    </tbody>
                                </table>
                            </div>
                        {% else %}
                            <div class="no-data">
                                <i class="fas fa-exclamation-triangle"></i>
                                <p>No bottom performers data available</p>
                            </div>
                        {% endif %}
                    </div>
                </div>
            </div>

            <!-- Detailed Student List (Filtered) -->
            <div class="row">
                <div class="col-12">
                    <div class="analysis-section">
                        <a href="{% url 'exam_session_analysis_pdf' exam_session.id %}?section=detailed_list&{% if not is_primary_nursery %}division={{ division_filter|urlencode }}&{% endif %}{% if is_primary_nursery %}grade={{ grade_filter|urlencode }}&{% endif %}gender={{ gender_filter|urlencode }}&rank_filter={{ rank_filter|urlencode }}&top_n={{ top_n }}&bottom_n={{ bottom_n }}" 
                           class="btn btn-sm btn-danger pdf-download-btn no-print" target="_blank" title="Download Detailed List PDF">
                            <i class="fas fa-file-pdf"></i> PDF
                        </a>
                        <div class="d-flex justify-content-between align-items-center mb-3">
                            <h5 class="section-title mb-0">
                                <i class="fas fa-list"></i> Detailed Student Analysis
                                <span class="badge badge-light ml-2">{{ student_data|length }} students (filtered)</span>
                                <small class="text-muted ml-2">Total: {{ total_students_all }} students</small>
                            </h5>
                        </div>
                        
                        <div class="table-responsive">
                            <table class="table table-hover text-nowrap table-responsive-sm table-bordered table-striped table-sm result-table" id="student-analysis-table">
                                <thead class="thead-light">
                                    <tr>
                                        <th>#</th>
                                        <th>Student</th>
                                        <th class="text-center">Gender</th>
                                        <th class="text-center">Rank</th>
                                        {% if not is_primary_nursery %}
                                            <th class="text-center">Division</th>
                                        {% endif %}
                                        {% if is_primary_nursery %}
                                            <th class="text-center">Grade</th>
                                        {% endif %}
                                        <th class="text-center">Total Marks</th>
                                        <th class="text-center">Avg. Marks</th>
                                        <th class="text-center">Avg. %</th>
                                        {% if not is_primary_nursery %}
                                            <th class="text-center">Grade Points</th>
                                        {% endif %}
                                        <th class="text-center">Avg. Grade</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for student in student_data %}
                                    <tr>
                                        <td>{{ forloop.counter }}</td>
                                        <td>
                                            <strong>{{ student.registration_number }}</strong><br>
                                            <small class="text-muted">{{ student.full_name|truncatechars:25 }}</small>
                                        </td>
                                        <td class="text-center">
                                            <span class="gender-icon gender-{{ student.gender|lower }}">
                                                <i class="fas fa-{% if student.gender == 'Male' %}mars{% elif student.gender == 'Female' %}venus{% else %}genderless{% endif %}"></i>
                                            </span>
                                        </td>
                                        <td class="text-center">
                                            {% if student.rank %}
                                                <span class="badge badge-info">{{ student.rank }}</span>
                                            {% else %}
                                                <span class="badge badge-secondary">NR</span>
                                            {% endif %}
                                        </td>
                                        {% if not is_primary_nursery %}
                                        <td class="text-center">
                                            {% if student.division %}
                                                <span class="division-badge division-{{ student.division }}">
                                                    {{ student.division_display }}
                                                </span>
                                            {% else %}
                                                <span class="badge badge-secondary">Not Assigned</span>
                                            {% endif %}
                                        </td>
                                        {% endif %}
                                        {% if is_primary_nursery %}
                                        <td class="text-center">
                                            {% if student.average_grade %}
                                                <span class="grade-badge grade-{{ student.average_grade }}">
                                                    {{ student.average_grade }}
                                                </span>
                                            {% else %}
                                                <span class="badge badge-secondary">No Grade</span>
                                            {% endif %}
                                        </td>
                                        {% endif %}
                                        <td class="text-center">
                                            <strong>{{ student.total_marks|floatformat:2|default:"-" }}</strong>
                                        </td>
                                        <td class="text-center">
                                            {{ student.average_marks|floatformat:2|default:"-" }}
                                        </td>
                                        <td class="text-center">
                                            {% if student.average_percentage %}
                                                <span class="badge 
                                                    {% if student.average_percentage >= 80 %}badge-success
                                                    {% elif student.average_percentage >= 60 %}badge-info
                                                    {% elif student.average_percentage >= 50 %}badge-warning
                                                    {% elif student.average_percentage >= 40 %}badge-primary
                                                    {% else %}badge-danger{% endif %}">
                                                    {{ student.average_percentage|floatformat:1 }}%
                                                </span>
                                            {% else %}
                                                <span class="badge badge-secondary">-</span>
                                            {% endif %}
                                        </td>
                                        {% if not is_primary_nursery %}
                                        <td class="text-center">
                                            {{ student.total_grade_points|floatformat:1|default:"-" }}
                                        </td>
                                        {% endif %}
                                        <td class="text-center">
                                            {% if student.average_grade %}
                                                <span class="badge badge-secondary">{{ student.average_grade }}</span>
                                            {% else %}
                                                <span class="badge badge-light">-</span>
                                            {% endif %}
                                        </td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                        
                        {% if not student_data %}
                        <div class="no-data">
                            <i class="fas fa-search"></i>
                            <p>No students match the current filters</p>
                            <a href="?exam_session_id={{ exam_session.id }}" class="btn btn-outline-primary mt-2">
                                Clear Filters
                            </a>
                        </div>
                        {% endif %}
                    </div>
                </div>
            </div>
        {% else %}
            <!-- No Data Message -->
            <div class="row">
                <div class="col-12">
                    <div class="analysis-section">
                        <div class="no-data">
                            <i class="fas fa-chart-bar fa-3x mb-3"></i>
                            <h4>No Analysis Data Available</h4>
                            <p class="text-muted">There are no student metrics available for this exam session.</p>
                            <a href="{% url 'manage_results' exam_session.id %}" class="btn btn-primary">
                                <i class="fas fa-edit"></i> Enter Results
                            </a>
                        </div>
                    </div>
                </div>
            </div>
        {% endif %}
    </div>
</section>
{% endblock content %}

{% block extra_js %}
<script>
$(document).ready(function() {
    // Show/hide top_n/bottom_n inputs based on rank filter
    $('#rank_filter').change(function() {
        var value = $(this).val();
        if (value === 'top') {
            $('#top_n_container').show();
            $('#bottom_n_container').hide();
        } else if (value === 'bottom') {
            $('#top_n_container').hide();
            $('#bottom_n_container').show();
        } else {
            $('#top_n_container').hide();
            $('#bottom_n_container').hide();
        }
    });

    // Initialize DataTable for student analysis table
    $('#student-analysis-table').DataTable({
        "pageLength": 25,
        "lengthMenu": [[10, 25, 50, 100, -1], [10, 25, 50, 100, "All"]],
        "order": [[3, 'asc']], // Sort by rank by default
        "language": {
            "search": "_INPUT_",
            "searchPlaceholder": "Search students...",
            "lengthMenu": "_MENU_ records per page",
            "info": "Showing _START_ to _END_ of _TOTAL_ students",
            "infoEmpty": "Showing 0 to 0 of 0 students",
            "infoFiltered": "(filtered from _MAX_ total students)",
            "zeroRecords": "No matching students found"
        },
        "dom": '<"row"<"col-md-6"l><"col-md-6"f>>rt<"row"<"col-md-6"i><"col-md-6"p>>',
        "responsive": true,
        "columnDefs": [
            { "orderable": false, "targets": [0] }
        ]
    });

    // Keyboard shortcuts
    $(document).keydown(function(e) {
        // Ctrl + F to focus search
        if (e.ctrlKey && e.keyCode === 70) {
            e.preventDefault();
            $('.dataTables_filter input').focus();
        }
        // Escape to clear search
        if (e.keyCode === 27) {
            $('.dataTables_filter input').val('').keyup();
        }
    });
    
    // Tooltip initialization
    $('[data-toggle="tooltip"]').tooltip();
});
</script>
{% endblock extra_js %}