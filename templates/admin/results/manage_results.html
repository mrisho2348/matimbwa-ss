{% extends 'admin/base.html' %}
{% load static %}
{% load custom_filters %}
{% block title %}Manage Student Results - {{ exam_session.name }}{% endblock title %}

{% block breadcrumb %}
    <nav aria-label="breadcrumb">
        <ol class="breadcrumb">
            <li class="breadcrumb-item"><a href="{% url 'admin_dashboard' %}">Dashboard</a></li>
            <li class="breadcrumb-item"><a href="{% url 'admin_exam_sessions_list' %}">Exam Sessions</a></li>
            <li class="breadcrumb-item active">Manage Results</li>
        </ol>
    </nav>
{% endblock breadcrumb %}

{% block extra_css %}
<style>
    :root {
        --primary-color: #4361ee;
        --success-color: #06d6a0;
        --warning-color: #ffd166;
        --danger-color: #ef476f;
        --info-color: #118ab2;
        --light-bg: #f8f9fa;
        --border-color: #dee2e6;
    }

    .student-info-column {
        position: sticky;
        left: 0;
        z-index: 900;
        background: white;
        box-shadow: 2px 0 5px rgba(0,0,0,0.1);
    }

    .result-table thead {
        position: sticky;
        top: 0;
        z-index: 1000;
        background: white;
    }

    .subject-header {
        background: var(--light-bg);
        font-weight: 600;
        white-space: nowrap;
        text-align: center;
        min-width: 80px;
    }

    .table-wrapper {
        overflow-x: auto;
        position: relative;
        border: 1px solid var(--border-color);
        border-radius: 8px;
        margin-top: 20px;
    }

    .result-table th,
    .result-table td {
        vertical-align: middle;
        padding: 8px;
        border: 1px solid var(--border-color);
    }

    .result-table th {
        background-color: var(--light-bg);
        font-weight: 600;
        white-space: nowrap;
        text-align: center;
    }

    .result-table td {
        text-align: center;
    }

    .student-name-cell {
        position: sticky;
        left: 0;
        background: white;
        z-index: 500;
        box-shadow: 2px 0 5px rgba(0,0,0,0.1);
        text-align: left !important;
        min-width: 200px;
    }

    .marks-display {
        font-weight: 500;
        padding: 4px 8px;
        border-radius: 4px;
        display: inline-block;
        min-width: 40px;
    }

    .marks-display.has-marks {
        background-color: rgba(6, 214, 160, 0.1);
        color: var(--success-color);
        font-weight: 600;
    }

    .marks-display.no-marks {
        color: #6c757d;
        font-style: italic;
    }

    .grade-badge {
        display: inline-block;
        padding: 2px 8px;
        border-radius: 12px;
        font-size: 0.75rem;
        font-weight: 600;
        text-align: center;
        min-width: 30px;
    }

    .grade-A { background-color: #28a745; color: white; }
    .grade-B { background-color: #17a2b8; color: white; }
    .grade-C { background-color: #ffc107; color: #212529; }
    .grade-D { background-color: #fd7e14; color: white; }
    .grade-E { background-color: #6f42c1; color: white; }
    .grade-F { background-color: #dc3545; color: white; }
    .grade-S { background-color: #6c757d; color: white; }

    .loading-overlay {
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(255, 255, 255, 0.9);
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 9999;
        display: none;
    }

    .loading-spinner {
        width: 50px;
        height: 50px;
        border: 5px solid var(--border-color);
        border-top-color: var(--primary-color);
        border-radius: 50%;
        animation: spin 1s linear infinite;
    }

    @keyframes spin {
        to { transform: rotate(360deg); }
    }

    .calculated-cell {
        font-weight: 600;
        background-color: #f8f9fa;
    }
    
    .position-cell {
        font-weight: bold;
        color: var(--primary-color);
    }
    
    .remark-cell {
        font-style: italic;
    }

    .card-header.bg-gradient-primary {
        background: linear-gradient(135deg, #4361ee 0%, #3a56d4 100%);
    }

    .text-white-80 {
        color: rgba(255, 255, 255, 0.85) !important;
    }

    .select2-subject-selector {
        border: 2px solid #e9ecef;
        border-radius: 0.375rem;
        transition: all 0.3s ease;
    }

    .select2-subject-selector:focus {
        border-color: #4361ee;
        box-shadow: 0 0 0 0.2rem rgba(67, 97, 238, 0.25);
    }

    .quick-subject-btn {
        border-radius: 20px;
        padding: 0.375rem 1rem;
        transition: all 0.2s ease;
        border-width: 2px;
    }

    .quick-subject-btn:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 8px rgba(67, 97, 238, 0.15);
    }

    .btn-lg {
        min-width: 160px;
        transition: all 0.3s ease;
    }

    .btn-lg:hover:not(:disabled) {
        transform: translateY(-2px);
        box-shadow: 0 6px 12px rgba(40, 167, 69, 0.25);
    }

    .btn-lg:disabled {
        opacity: 0.6;
        cursor: not-allowed;
    }

    .badge-light {
        background-color: #f8f9fa;
        border: 1px solid #dee2e6;
    }

    /* Action Buttons Styles */
    .action-buttons-container {
        display: flex;
        gap: 10px;
        align-items: center;
        flex-wrap: wrap;
        margin-top: 15px;
    }

    .file-upload-wrapper {
        position: relative;
        overflow: hidden;
        display: inline-block;
    }

    .file-upload-wrapper input[type=file] {
        position: absolute;
        left: 0;
        top: 0;
        opacity: 0;
        cursor: pointer;
        height: 100%;
        width: 100%;
    }

    .file-upload-button {
        padding: 8px 16px;
        border-radius: 6px;
        background-color: #6c757d;
        color: white;
        border: none;
        cursor: pointer;
        display: inline-flex;
        align-items: center;
        gap: 8px;
    }

    .file-upload-button:hover {
        background-color: #5a6268;
    }

    .file-upload-button i {
        font-size: 14px;
    }

    .modal-backdrop {
        z-index: 1040 !important;
    }

    .modal {
        z-index: 1050 !important;
    }

    .progress-bar {
        transition: width 0.3s ease;
    }

    .template-info {
        background-color: #e8f4fd;
        border-left: 4px solid #17a2b8;
        padding: 15px;
        border-radius: 4px;
        margin-bottom: 20px;
    }

    .template-info h6 {
        color: #17a2b8;
        font-weight: 600;
        margin-bottom: 10px;
    }

    .template-info ul {
        margin-bottom: 0;
        padding-left: 20px;
    }

    .template-info li {
        margin-bottom: 5px;
        color: #495057;
    }

    .published-badge {
        font-size: 0.75rem;
        padding: 0.25rem 0.75rem;
    }

    .view-only-message {
        background-color: #fff3cd;
        border-color: #ffeaa7;
    }

    .session-export-card {
        border: 2px solid #e9ecef;
        border-radius: 10px;
        transition: all 0.3s ease;
    }

    .session-export-card:hover {
        border-color: var(--primary-color);
        box-shadow: 0 0 15px rgba(67, 97, 238, 0.1);
    }

    .session-export-header {
        background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
        border-bottom: 1px solid #dee2e6;
    }

    @media (max-width: 768px) {
        .subject-stats {
            margin-bottom: 15px !important;
        }
        
        .btn-lg {
            width: 100%;
            margin-top: 10px;
        }
        
        .quick-subject-btn {
            margin-bottom: 5px;
        }

        .action-buttons-container {
            flex-direction: column;
            align-items: stretch;
        }

        .file-upload-button {
            width: 100%;
            justify-content: center;
        }

        .subject-header {
            min-width: 60px;
            font-size: 0.8rem;
        }

        .student-name-cell {
            min-width: 150px;
        }
    }
</style>
{% endblock extra_css %}

{% block content %}
<!-- Loading Overlay -->
<div class="loading-overlay" id="loading-overlay">
    <div class="loading-spinner"></div>
</div>

<!-- Excel Upload Modal (for entire session) -->
<div class="modal fade" id="sessionExcelUploadModal" tabindex="-1" role="dialog" aria-labelledby="sessionExcelUploadModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg" role="document">
        <div class="modal-content">
            <div class="modal-header bg-primary text-white">
                <h5 class="modal-title" id="sessionExcelUploadModalLabel">
                    <i class="fas fa-file-upload mr-2"></i>Upload Session Results (Excel)
                </h5>
                <button type="button" class="close text-white" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <div class="template-info">
                    <h6><i class="fas fa-info-circle mr-2"></i>Instructions for Session Upload:</h6>
                    <ul>
                        <li>Download the session template first using the "Download Excel Template" button</li>
                        <li>Template includes all subjects for this exam session</li>
                        <li>Fill marks for multiple students across all subjects</li>
                        <li>Leave cells blank for absent students</li>
                        <li>Zero (0) is treated as a valid mark</li>
                        <li>Do not modify Student ID or Registration Number columns</li>
                        <li>Maximum file size: 10MB</li>
                        <li>Supported formats: .xlsx, .xls</li>
                    </ul>
                </div>

                <div class="form-group">
                    <label for="sessionExcelFile">Select Excel File:</label>
                    <div class="file-upload-wrapper">
                        <button type="button" class="file-upload-button" id="sessionFileUploadButton">
                            <i class="fas fa-file-excel"></i> Choose Excel File
                        </button>
                        <input type="file" id="sessionExcelFile" name="sessionExcelFile" accept=".xlsx,.xls" style="display: none;">
                    </div>
                    <small class="form-text text-muted" id="sessionFileName"></small>
                </div>

                <div class="form-group">
                    <label>Upload Progress:</label>
                    <div class="progress">
                        <div class="progress-bar progress-bar-striped progress-bar-animated" 
                             id="sessionUploadProgressBar" 
                             role="progressbar" 
                             style="width: 0%">
                            0%
                        </div>
                    </div>
                </div>

                <div id="sessionUploadPreview" style="display: none;">
                    <h6><i class="fas fa-eye mr-2"></i>File Preview:</h6>
                    <div class="table-responsive">
                        <table class="table table-sm table-bordered" id="sessionPreviewTable">
                            <thead class="thead-light">
                                <tr>
                                    <th>Student ID</th>
                                    <th>Registration No.</th>
                                    <th>Student Name</th>
                                    <th>Subject 1</th>
                                    <th>Subject 2</th>
                                    <th>...</th>
                                </tr>
                            </thead>
                            <tbody id="sessionPreviewTableBody">
                                <tr>
                                    <td colspan="6" class="text-center text-muted py-3">
                                        <i class="fas fa-file-excel fa-2x mb-2"></i><br>
                                        File ready for upload. Preview will show first few rows after selection.
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>

                <div class="alert alert-danger" id="sessionUploadError" style="display: none;">
                    <i class="fas fa-exclamation-triangle mr-2"></i>
                    <span id="sessionErrorMessage"></span>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" id="btnUploadSessionExcel" disabled onclick="uploadSessionExcelFile()">
                    <i class="fas fa-upload mr-1"></i> Upload & Process Session
                </button>
            </div>
        </div>
    </div>
</div>

<section class="content">
    <div class="container-fluid">
        <!-- Session Header Card -->
        <div class="row mb-4">
            <div class="col-12">
                <div class="card">
                    <div class="card-header {% if exam_session.status == 'published' %}bg-success text-white{% else %}bg-primary text-white{% endif %}">
                        <div class="d-flex justify-content-between align-items-center">
                            <h3 class="card-title mb-0">
                                <i class="fas fa-file-alt mr-2"></i>Manage Student Results - {{ exam_session.name }}
                            </h3>
                            <div>
                                <span class="badge badge-light mr-2">
                                    <i class="fas fa-calendar mr-1"></i>{{ exam_session.exam_date|date:"M d, Y" }}
                                </span>
                                <span class="badge badge-{{ exam_session.status }}">
                                    {{ exam_session.get_status_display }}
                                </span>
                            </div>
                        </div>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-3">
                                <p class="mb-1"><strong>Academic Year:</strong> {{ exam_session.academic_year.name }}</p>
                            </div>
                            <div class="col-md-2">
                                <p class="mb-1"><strong>Term:</strong> {{ exam_session.term.get_term_number_display }}</p>
                            </div>
                            <div class="col-md-3">
                                <p class="mb-1"><strong>Class:</strong> {{ exam_session.class_level.name }}</p>
                            </div>
                            <div class="col-md-2">
                                <p class="mb-1"><strong>Stream:</strong> 
                                    {% if exam_session.stream_class %}
                                        {{ exam_session.stream_class.stream_letter }}
                                    {% else %}
                                        All Streams
                                    {% endif %}
                                </p>
                            </div>
                            <div class="col-md-2">
                                <p class="mb-1"><strong>Students:</strong> {{ student_results_data|length }}</p>
                            </div>
                        </div>
                        <div class="row mt-2">
                            <div class="col-md-4">
                                <p class="mb-1"><strong>Exam Type:</strong> {{ exam_session.exam_type.name }}</p>
                            </div>
                            <div class="col-md-4">
                                <p class="mb-1"><strong>Subjects:</strong> {{ subjects.count }}</p>
                            </div>
                            <div class="col-md-4">
                                <p class="mb-1"><strong>Max Score:</strong> {{ exam_session.exam_type.max_score }}</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Session Export Card -->
        <div class="row mb-4">
            <div class="col-12">
                <div class="card session-export-card">
                    <div class="card-header session-export-header">
                        <h4 class="card-title mb-0">
                            <i class="fas fa-download mr-2"></i>Session Export & Import Tools
                        </h4>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-6">
                                <h5><i class="fas fa-upload mr-2"></i>Bulk Import</h5>
                                <p class="text-muted">Upload Excel file with marks for all students and subjects in this session.</p>
                                {% if exam_session.status != 'published' %}
                                    <button type="button" class="btn btn-primary" 
                                            data-toggle="modal" data-target="#sessionExcelUploadModal">
                                        <i class="fas fa-file-upload mr-1"></i> Upload Session Excel
                                    </button>
                                {% else %}
                                    <div class="alert alert-warning view-only-message">
                                        <i class="fas fa-lock mr-2"></i>
                                        Session is published. Upload disabled.
                                    </div>
                                {% endif %}
                            </div>
                            <div class="col-md-6">
                                <h5><i class="fas fa-download mr-2"></i>Bulk Export</h5>
                                <p class="text-muted">Download results in various formats for reporting and analysis.</p>
                                <div class="action-buttons-container">
                                    <button type="button" class="btn btn-warning" 
                                            onclick="downloadSessionExcelTemplate()">
                                        <i class="fas fa-file-excel mr-1"></i> Excel Template
                                    </button>
                                    <button type="button" class="btn btn-danger" 
                                            onclick="downloadSessionExcelReport()">
                                        <i class="fas fa-file-pdf mr-1"></i> Excel Report
                                    </button>
                                    <button type="button" class="btn btn-info" 
                                            onclick="downloadSessionSummary()">
                                        <i class="fas fa-chart-bar mr-1"></i> Summary
                                    </button>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Quick Stats -->
                        <div class="row mt-4">
                            <div class="col-md-3">
                                <div class="card bg-light">
                                    <div class="card-body text-center py-2">
                                        <h5 class="mb-0">{{ subjects.count }}</h5>
                                        <small class="text-muted">Subjects</small>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="card bg-light">
                                    <div class="card-body text-center py-2">
                                        <h5 class="mb-0">{{ student_results_data|length }}</h5>
                                        <small class="text-muted">Students</small>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="card bg-light">
                                    <div class="card-body text-center py-2">
                                        <h5 class="mb-0" id="total-results-count">0</h5>
                                        <small class="text-muted">Results Entered</small>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="card bg-light">
                                    <div class="card-body text-center py-2">
                                        <h5 class="mb-0" id="completion-percentage">0%</h5>
                                        <small class="text-muted">Completion</small>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Subject Selection Card -->
        <div class="row mb-4">
            <div class="col-12">
                <div class="card shadow-sm border-0">
                    <div class="card-header bg-gradient-primary text-white py-3">
                        <h4 class="card-title mb-0 d-flex align-items-center">
                            <i class="fas fa-clipboard-check mr-2"></i>
                            Select a Subject to Enter Marks
                        </h4>
                    </div>
                    <div class="card-body">
                        <div class="row align-items-center">
                            <div class="col-md-8 mb-3 mb-md-0">
                                <div class="form-group mb-0">
                                    <label for="subject-selector" class="font-weight-bold mb-2">
                                        <i class="fas fa-book mr-1"></i>Select Subject
                                    </label>
                                    <div class="input-group">
                                        <select id="subject-selector" 
                                                class="form-control select2-subject-selector border-left-0" 
                                                style="width: 100%;">
                                            <option value="">-- Select a subject from the list --</option>
                                            {% for subject in subjects %}
                                                <option value="{{ subject.id }}">
                                                    {{ subject.code }} - {{ subject.name }}
                                                    {% if subject.is_core %}
                                                        <span class="badge badge-info ml-2">Core</span>
                                                    {% endif %}
                                                </option>
                                            {% endfor %}
                                        </select>
                                    </div>
                                    <small class="form-text text-muted mt-2">
                                        <i class="fas fa-info-circle mr-1"></i>
                                        Choose one subject at a time to enter marks for all students
                                    </small>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="text-md-right">
                                    <div class="subject-stats mb-3">
                                        <div class="d-inline-block mr-3">
                                            <span class="badge badge-light px-3 py-2">
                                                <i class="fas fa-book-open mr-1"></i>
                                                {{ subjects.count }} Subjects
                                            </span>
                                        </div>
                                        <div class="d-inline-block">
                                            <span class="badge badge-light px-3 py-2">
                                                <i class="fas fa-users mr-1"></i>
                                                {{ student_results_data|length }} Students
                                            </span>
                                        </div>
                                    </div>
                                    <button type="button" 
                                            class="btn btn-success btn-lg px-4 py-3 font-weight-bold"
                                            id="btn-go-to-subject"
                                            onclick="goToSubjectEntry()"
                                            disabled>
                                        <i class="fas fa-pencil-alt mr-2"></i>
                                        Enter Marks
                                        <i class="fas fa-arrow-right ml-2"></i>
                                    </button>
                                </div>
                            </div>
                        </div>
                        
                        <div class="row mt-4">
                            <div class="col-12">
                                <h6 class="text-muted mb-3">
                                    <i class="fas fa-bolt mr-1"></i>Quick Access - Recent Subjects:
                                </h6>
                                <div class="d-flex flex-wrap gap-2">
                                    {% for subject in subjects|slice:":6" %}
                                    <button type="button" 
                                            class="btn btn-outline-primary btn-sm quick-subject-btn"
                                            data-subject-id="{{ subject.id }}"
                                            onclick="quickSelectSubject('{{ subject.id }}')">
                                        <i class="fas fa-book mr-1"></i>
                                        {{ subject.code }}
                                    </button>
                                    {% endfor %}
                                    {% if subjects.count > 6 %}
                                    <span class="align-self-center text-muted ml-2">
                                        +{{ subjects.count|add:"-6" }} more subjects
                                    </span>
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Student Results Table -->
        <div class="row">
            <div class="col-12">
                <div class="card">
                    <div class="card-header">
                        <div class="d-flex justify-content-between align-items-center">
                            <h4 class="card-title mb-0">Student Results Overview</h4>
                            <div class="input-group input-group-sm" style="width: 300px;">
                                <input type="text" class="form-control" placeholder="Search students..." id="search-students">
                                <div class="input-group-append">
                                    <button class="btn btn-primary">
                                        <i class="fas fa-search"></i>
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="card-body p-0">
                        <div class="table-wrapper">
                            <table class="table table-hover text-nowrap table-responsive-sm table-bordered table-striped table-sm result-table" id="results-table">
                                <thead>
                                    <tr>
                                        <th class="student-name-cell">Reg/Exam No.</th>
                                        <th class="student-name-cell">Candidate Name</th>
                                        <th>Sex</th>
                                        <th>Point</th>
                                        <th>Div</th>
                                        {% for subject in subjects %}
                                            <th class="subject-header" title="{{ subject.name }}">
                                                {{ subject.code }}
                                            </th>
                                        {% endfor %}
                                        <th>Total</th>
                                        <th>Avg</th>
                                        <th>GRD</th>
                                        <th>POS</th>
                                        <th>Remark</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for student_data in student_results_data %}
                                    <tr data-student-id="{{ student_data.student_id }}" data-student-name="{{ student_data.full_name|lower }}">
                                        <td class="student-name-cell">{{ student_data.registration_number }}</td>
                                        <td class="student-name-cell">{{ student_data.full_name }}</td>
                                        <td>{{ student_data.gender|slice:":1" }}</td>
                                        <td class="calculated-cell" id="points-{{ student_data.student_id }}">
                                            {% if student_data.total_grade_points %}
                                                {{ student_data.total_grade_points|floatformat:1 }}
                                            {% else %}
                                                -
                                            {% endif %}
                                        </td>
                                        <td class="calculated-cell" id="division-{{ student_data.student_id }}">
                                            {{ student_data.division|default:"-" }}
                                        </td>
                                        
                                        {% for subject in subjects %}
                                        <td>
                                            {% with subject_result=student_data.subject_results|get_item:subject.id %}
                                                {% if subject_result.marks is not None %}
                                                    <div class="marks-display has-marks" 
                                                         title="{{ subject.name }}: {{ subject_result.marks|floatformat:1 }} marks">
                                                        {{ subject_result.grade }}-{{ subject_result.marks|floatformat:1 }}
                                                    </div>
                                                {% else %}
                                                    <div class="marks-display no-marks">
                                                        -
                                                    </div>
                                                {% endif %}
                                            {% endwith %}
                                        </td>
                                        {% endfor %}
                                        
                                        <td class="calculated-cell" id="total-{{ student_data.student_id }}">
                                            {% if student_data.total_marks %}
                                                {{ student_data.total_marks|floatformat:1 }}
                                            {% else %}
                                                -
                                            {% endif %}
                                        </td>
                                        <td class="calculated-cell" id="average-{{ student_data.student_id }}">
                                            {% if student_data.average_marks %}
                                                {{ student_data.average_marks|floatformat:1 }}
                                            {% else %}
                                                -
                                            {% endif %}
                                        </td>
                                        <td class="calculated-cell" id="grade-{{ student_data.student_id }}">
                                            {{ student_data.average_grade|default:"-" }}
                                        </td>
                                        <td class="position-cell" id="position-{{ student_data.student_id }}">
                                            {% if student_data.class_position %}
                                                {{ student_data.class_position }}
                                            {% else %}
                                                -
                                            {% endif %}
                                        </td>
                                        <td class="remark-cell" id="remark-{{ student_data.student_id }}">
                                            {{ student_data.average_remark|default:"-" }}
                                        </td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</section>

<!-- Hidden inputs -->
<input type="hidden" id="csrf-token" value="{{ csrf_token }}">
<input type="hidden" id="exam-session-status" value="{{ exam_session.status }}">
<input type="hidden" id="exam-session-id" value="{{ exam_session.id }}">
<input type="hidden" id="exam-session-name" value="{{ exam_session.name|slugify }}">
{% endblock content %}

{% block extra_js %}
<script>
    // Global variables
    let selectedSessionFile = null;

    // ============================================
    // UTILITY FUNCTIONS
    // ============================================
    function getCSRFToken() {
        return document.getElementById('csrf-token').value;
    }

    function showLoading(show) {
        if (show) {
            $('#loading-overlay').fadeIn();
        } else {
            $('#loading-overlay').fadeOut();
        }
    }

    function showToast(message, type = 'success') {
        const toast = $(`
            <div class="alert alert-${type} alert-dismissible fade show position-fixed" 
                 style="top: 20px; right: 20px; z-index: 9999; min-width: 300px;">
                <div class="d-flex align-items-center">
                    <i class="fas ${type === 'success' ? 'fa-check-circle' : type === 'warning' ? 'fa-exclamation-triangle' : 'fa-times-circle'} mr-2"></i>
                    <div>${message}</div>
                </div>
                <button type="button" class="close" data-dismiss="alert">
                    <span>&times;</span>
                </button>
            </div>
        `);
        
        $('body').append(toast);
        
        setTimeout(() => {
            toast.alert('close');
        }, 5000);
    }

    function formatFileSize(bytes) {
        if (bytes === 0) return '0 Bytes';
        const k = 1024;
        const sizes = ['Bytes', 'KB', 'MB', 'GB'];
        const i = Math.floor(Math.log(bytes) / Math.log(k));
        return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
    }

    function calculateCompletionStats() {
        const totalStudents = {{ student_results_data|length }};
        const totalSubjects = {{ subjects.count }};
        const totalPossibleResults = totalStudents * totalSubjects;
        
        let resultsEntered = 0;
        
        // Count entered results
        $('.marks-display.has-marks').each(function() {
            resultsEntered++;
        });
        
        // Update UI
        $('#total-results-count').text(resultsEntered);
        
        if (totalPossibleResults > 0) {
            const percentage = Math.round((resultsEntered / totalPossibleResults) * 100);
            $('#completion-percentage').text(percentage + '%');
        }
    }

    // ============================================
    // SESSION EXPORT FUNCTIONS
    // ============================================
    function downloadSessionExcelTemplate() {
        showLoading(true);
        
        const examSessionId = document.getElementById('exam-session-id').value;
        const examSessionName = document.getElementById('exam-session-name').value;
        
        // Create download URL - You'll need to create this view in Django
        const downloadUrl = `/result/exam-sessions/${examSessionId}/download-excel-template/`;
        
        // Create hidden iframe for download
        const iframe = document.createElement('iframe');
        iframe.style.display = 'none';
        iframe.src = downloadUrl;
        document.body.appendChild(iframe);
        
        // Remove iframe after download
        setTimeout(() => {
            document.body.removeChild(iframe);
            showLoading(false);
            showToast('Session Excel template download started!', 'success');
        }, 2000);
    }

         // ============================================
        // EXCEL REPORT DOWNLOAD FUNCTION
        // ============================================
        function downloadSessionExcelReport() {
            showLoading(true);
            
            const examSessionId = document.getElementById('exam-session-id').value;
            const examSessionName = document.getElementById('exam-session-name').value;
            const timestamp = new Date().toISOString().slice(0, 10).replace(/-/g, '');
            
            // Create download URL for Excel report
            const downloadUrl = `/result/exam-sessions/${examSessionId}/download-excel-report/`;
            
            // Use fetch to trigger the download
            fetch(downloadUrl, {
                method: 'GET',
                headers: {
                    'X-CSRFToken': getCSRFToken(),
                    'Accept': 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet'
                }
            })
            .then(response => {
                if (response.ok) {
                    return response.blob();
                }
                throw new Error('Failed to generate Excel report');
            })
            .then(blob => {
                // Create download link
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `Session_Excel_Report_${examSessionName}_${timestamp}.xlsx`;
                document.body.appendChild(a);
                a.click();
                window.URL.revokeObjectURL(url);
                document.body.removeChild(a);
                
                showToast('Excel report downloaded successfully!', 'success');
                showLoading(false);
            })
            .catch(error => {
                console.error('Error downloading Excel:', error);
                showToast('Error downloading Excel: ' + error.message, 'danger');
                showLoading(false);
                
                // Fallback to direct link
                window.location.href = downloadUrl;
            });
        }

    function downloadSessionSummary() {
        showLoading(true);
        
        const examSessionId = document.getElementById('exam-session-id').value;
        const examSessionName = document.getElementById('exam-session-name').value;
        
        // Create download URL - You'll need to create this view in Django
        const downloadUrl = `/result/exam-sessions/${examSessionId}/download-summary/`;
        
        // Simple download via iframe
        const iframe = document.createElement('iframe');
        iframe.style.display = 'none';
        iframe.src = downloadUrl;
        document.body.appendChild(iframe);
        
        setTimeout(() => {
            document.body.removeChild(iframe);
            showLoading(false);
            showToast('Session summary download started!', 'success');
        }, 2000);
    }

    // ============================================
    // SESSION EXCEL UPLOAD FUNCTIONS
    // ============================================
    document.addEventListener('DOMContentLoaded', function() {
        // File input change handler for session upload
        document.getElementById('sessionExcelFile').addEventListener('change', function(e) {
            selectedSessionFile = e.target.files[0];
            
            if (selectedSessionFile) {
                // Validate file
                if (!validateExcelFile(selectedSessionFile)) {
                    return;
                }
                
                // Show file name
                document.getElementById('sessionFileName').textContent = 
                    `Selected: ${selectedSessionFile.name} (${formatFileSize(selectedSessionFile.size)})`;
                document.getElementById('btnUploadSessionExcel').disabled = false;
                
                // Show basic preview
                previewSessionExcelFile(selectedSessionFile);
            }
        });

        // File upload button click handler
        document.getElementById('sessionFileUploadButton').addEventListener('click', function() {
            document.getElementById('sessionExcelFile').click();
        });

        // Modal show/hide handlers
        $('#sessionExcelUploadModal').on('show.bs.modal', function() {
            resetSessionUploadModal();
        });

        $('#sessionExcelUploadModal').on('hidden.bs.modal', function() {
            resetSessionUploadModal();
        });
    });

    function validateExcelFile(file) {
        const validExtensions = ['.xlsx', '.xls'];
        const maxSize = 10 * 1024 * 1024; // 10MB
        
        // Check extension
        const fileName = file.name.toLowerCase();
        const isValidExtension = validExtensions.some(ext => fileName.endsWith(ext));
        
        if (!isValidExtension) {
            showSessionUploadError('Please select a valid Excel file (.xlsx or .xls)');
            return false;
        }
        
        // Check size
        if (file.size > maxSize) {
            showSessionUploadError('File size must be less than 10MB');
            return false;
        }
        
        return true;
    }

    function previewSessionExcelFile(file) {
        // Basic preview
        document.getElementById('sessionPreviewTableBody').innerHTML = `
            <tr>
                <td colspan="6" class="text-center">
                    <div class="py-3">
                        <i class="fas fa-file-excel fa-3x text-success mb-3"></i>
                        <h6>Session File Ready</h6>
                        <p class="mb-0 text-muted">
                            ${file.name}<br>
                            ${formatFileSize(file.size)}
                        </p>
                        <small class="text-muted">
                            File will be processed on upload. Expected format: Student ID, Registration No., Student Name, followed by subject columns.
                        </small>
                    </div>
                </td>
            </tr>
        `;
        
        document.getElementById('sessionUploadPreview').style.display = 'block';
    }

    function showSessionUploadError(message) {
        const errorDiv = document.getElementById('sessionUploadError');
        const errorMessage = document.getElementById('sessionErrorMessage');
        
        errorMessage.textContent = message;
        errorDiv.style.display = 'block';
        
        // Hide error after 5 seconds
        setTimeout(() => {
            errorDiv.style.display = 'none';
        }, 5000);
    }

    function resetSessionUploadModal() {
        document.getElementById('sessionExcelFile').value = '';
        document.getElementById('sessionFileName').textContent = '';
        document.getElementById('btnUploadSessionExcel').disabled = true;
        document.getElementById('sessionUploadPreview').style.display = 'none';
        document.getElementById('sessionUploadError').style.display = 'none';
        document.getElementById('sessionUploadProgressBar').style.width = '0%';
        document.getElementById('sessionUploadProgressBar').textContent = '0%';
        selectedSessionFile = null;
    }

    function updateSessionUploadProgress(percentage) {
        const progressBar = document.getElementById('sessionUploadProgressBar');
        progressBar.style.width = percentage + '%';
        progressBar.textContent = percentage + '%';
    }

    async function uploadSessionExcelFile() {
        // Check if session is published
        const examSessionStatus = document.getElementById('exam-session-status').value;
        if (examSessionStatus === 'published') {
            showSessionUploadError('Cannot upload to a published session. Please unpublish first.');
            return;
        }
        
        if (!selectedSessionFile) {
            showSessionUploadError('Please select a file first');
            return;
        }
        
        showLoading(true);
        
        const formData = new FormData();
        formData.append('excel_file', selectedSessionFile);
        formData.append('exam_session_id', document.getElementById('exam-session-id').value);
        
        try {
            // Update upload progress
            updateSessionUploadProgress(0);
            
            // You'll need to create this endpoint in Django
            const uploadUrl = '/result/exam-sessions/upload-session-excel/';
            
            const response = await fetch(uploadUrl, {
                method: 'POST',
                headers: {
                    'X-CSRFToken': getCSRFToken(),
                },
                body: formData
            });
            
            // Update progress to simulate upload
            updateSessionUploadProgress(100);
            
            const result = await response.json();
            
            if (result.success) {
                showToast(`Successfully uploaded ${result.processed_count} results across ${result.subjects_processed || 'multiple'} subjects!`, 'success');
                
                // Close modal after delay
                setTimeout(() => {
                    $('#sessionExcelUploadModal').modal('hide');
                    // Refresh the page to show updated marks
                    window.location.reload();
                }, 2000);
            } else {
                throw new Error(result.message || 'Upload failed');
            }
        } catch (error) {
            showSessionUploadError('Upload failed: ' + error.message);
        } finally {
            showLoading(false);
        }
    }

    // ============================================
    // SUBJECT ENTRY FUNCTIONS
    // ============================================
    function goToSubjectEntry() {
        const subjectId = $('#subject-selector').val();
        
        if (!subjectId) {
            showToast('Please select a subject first.', 'warning');
            $('#subject-selector').focus();
            return;
        }
        
        const subjectName = $('#subject-selector option:selected').text();
        
        // Store in session storage for continuity
        sessionStorage.setItem('selectedSubject', JSON.stringify({
            subjectId: subjectId,
            subjectName: subjectName,
            examSessionId: '{{ exam_session.id }}',
            timestamp: new Date().toISOString()
        }));
        
        showLoading(true);
        
        // Redirect to subject entry page
        let urlTemplate = "{% url 'admin_subject_results_entry' exam_session.id 0 %}";
        let finalUrl = urlTemplate.replace('/0/', '/' + subjectId + '/');
        
        setTimeout(() => {
            window.location.href = finalUrl;
        }, 500);
    }

    function quickSelectSubject(subjectId) {
        $('#subject-selector').val(subjectId).trigger('change');
        
        $('html, body').animate({
            scrollTop: $('#subject-selector').offset().top - 100
        }, 300);
        
        setTimeout(() => {
            $('#btn-go-to-subject').focus();
        }, 400);
    }

    // ============================================
    // SEARCH FUNCTIONALITY
    // ============================================
    function initSearch() {
        $('#search-students').on('keyup', function() {
            const searchTerm = $(this).val().toLowerCase();
            $('#results-table tbody tr').each(function() {
                const studentName = $(this).data('student-name') || '';
                const registrationNumber = $(this).find('.student-name-cell:first').text().toLowerCase();
                
                if (studentName.includes(searchTerm) || registrationNumber.includes(searchTerm)) {
                    $(this).show();
                } else {
                    $(this).hide();
                }
            });
        });
    }

    // ============================================
    // INITIALIZATION
    // ============================================
    $(document).ready(function() {
        // Initialize Select2 for subject selector
        $('.select2-subject-selector').select2({
            placeholder: '-- Choose a Subject to Enter Marks --',
            allowClear: true,
            width: '100%',
            theme: 'bootstrap-5',
            language: {
                "noResults": function () {
                    return "No subjects found";
                }
            },
            templateResult: function(data) {
                if (!data.id) return data.text;
                return $('<span><i class="fas fa-book mr-2"></i>' + data.text + '</span>');
            },
            templateSelection: function(data) {
                if (!data.id) return data.text;
                return $('<span><i class="fas fa-book mr-2"></i>' + data.text + '</span>');
            }
        });

        // Enable/disable subject entry button based on selection
        $('#subject-selector').on('change', function() {
            const btn = $('#btn-go-to-subject');
            if ($(this).val()) {
                btn.prop('disabled', false);
                btn.removeClass('btn-secondary').addClass('btn-success');
            } else {
                btn.prop('disabled', true);
                btn.removeClass('btn-success').addClass('btn-secondary');
            }
        }).trigger('change');

        // Initialize search
        initSearch();

        // Calculate completion stats
        calculateCompletionStats();

        // Add keyboard shortcuts
        $(document).on('keydown', function(e) {
            // Ctrl+F for search
            if ((e.ctrlKey || e.metaKey) && e.key === 'f') {
                e.preventDefault();
                $('#search-students').focus();
                showToast('Use Ctrl+F to quickly search for students', 'info');
            }
            
            // Ctrl+T for template download
            if ((e.ctrlKey || e.metaKey) && e.key === 't') {
                e.preventDefault();
                downloadSessionExcelTemplate();
            }
            
            // Ctrl+P for PDF report
            if ((e.ctrlKey || e.metaKey) && e.key === 'p') {
                e.preventDefault();
                downloadSessionExcelReport();
            }
        });

        // Show tooltips for subject headers
        $('.subject-header').tooltip({
            placement: 'top',
            trigger: 'hover'
        });

        // Show tooltips for marks
        $('.marks-display.has-marks').tooltip({
            placement: 'top',
            trigger: 'hover'
        });
    });
</script>
{% endblock extra_js %}