{% load custom_filters %}
<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<title>{{ student.full_name }} - {{ exam_session.name }}</title>

<style>

/* ================= PAGE SETUP ================= */
@page {
    size: A4;
    margin: 2cm;

    @top-center {
        content: "{{ school_name }}";
        font-size: 10pt;
        font-weight: bold;
    }

    @bottom-center {
        content: "Page " counter(page) " of " counter(pages);
        font-size: 9pt;
    }
}

body {
    font-family: "Times New Roman", serif;
    font-size: 11pt;
    line-height: 1.5;
    color: #000;
}

/* ================= WATERMARK ================= */
.watermark {
    position: fixed;
    top: 45%;
    left: 25%;
    font-size: 50pt;
    color: rgba(0,0,0,0.07);
}

/* ================= HEADER ================= */
.header {
    text-align: center;
    margin-bottom: 20px;
    border-bottom: 2px solid #000;
    padding-bottom: 10px;
}

.school-name {
    font-size: 18pt;
    font-weight: bold;
}

.report-title {
    font-size: 14pt;
    font-weight: bold;
    text-transform: uppercase;
    margin-top: 8px;
}

/* ================= INFO BOXES ================= */
.info-box {
    border: 1px solid #000;
    padding: 10px;
    margin-bottom: 15px;
    page-break-inside: avoid;
}

.info-table {
    width: 100%;
    border-collapse: collapse;
}

.info-table td {
    padding: 4px 8px;
    vertical-align: top;
    font-size: 10pt;
}

.label {
    font-weight: bold;
    width: 150px;
}

/* ================= SUMMARY TABLE ================= */
.summary-table {
    width: 100%;
    border-collapse: collapse;
    margin-bottom: 15px;
    page-break-inside: avoid;
}

.summary-table td {
    border: 1px solid #000;
    text-align: center;
    padding: 10px;
}

.summary-title {
    font-size: 9pt;
    text-transform: uppercase;
}

.summary-value {
    font-size: 14pt;
    font-weight: bold;
}

/* ================= RANKING SECTION ================= */
.ranking-box {
    border: 1px solid #000;
    padding: 10px;
    margin-bottom: 15px;
    text-align: center;
    page-break-inside: avoid;
}

.ranking-title {
    font-weight: bold;
    margin-bottom: 5px;
}

.ranking-value {
    font-size: 14pt;
    font-weight: bold;
}

/* ================= RESULTS TABLE ================= */
.results-table {
    width: 100%;
    border-collapse: collapse;
    margin-top: 10px;
}

.results-table th,
.results-table td {
    border: 1px solid #000;
    padding: 6px;
    font-size: 10pt;
}

.results-table th {
    background: #e6e6e6;
    text-align: center;
    font-weight: bold;
}

.center { text-align: center; }

.grade-badge {
    padding: 2px 6px;
    border: 1px solid #000;
    font-weight: bold;
}

/* ================= SIGNATURE ================= */
.signature-table {
    width: 100%;
    margin-top: 40px;
    border-collapse: collapse;
    page-break-inside: avoid;
}

.signature-table td {
    width: 33%;
    text-align: center;
    padding-top: 40px;
}

.signature-line {
    border-top: 1px solid #000;
    margin-top: 30px;
}

/* ================= FOOTER ================= */
.footer {
    margin-top: 25px;
    border-top: 1px solid #000;
    padding-top: 10px;
    font-size: 9pt;
    text-align: center;
}

</style>
</head>

<body>

<div class="watermark">{{ school_name }}</div>

<!-- HEADER -->
<div class="header">
    <div class="school-name">{{ school_name }}</div>
    <div>Official Academic Transcript</div>
    <div class="report-title">Individual Student Performance Report</div>
</div>

<!-- STUDENT INFO -->
<div class="info-box">
    <table class="info-table">
        <tr>
            <td class="label">Student Name:</td>
            <td>{{ student.full_name }}</td>
            <td class="label">Registration No:</td>
            <td>{{ student.registration_number }}</td>
        </tr>
        <tr>
            <td class="label">Gender:</td>
            <td>{{ student.get_gender_display }}</td>
            <td class="label">Class:</td>
            <td>{{ student.class_level.name }} {{ student.stream_class.stream_letter|default:"" }}</td>
        </tr>
        <tr>
            <td class="label">Academic Year:</td>
            <td>{{ exam_session.academic_year.name }}</td>
            <td class="label">Status:</td>
            <td>{{ student.get_status_display }}</td>
        </tr>
    </table>
</div>

<!-- EXAM INFO -->
<div class="info-box">
    <table class="info-table">
        <tr>
            <td class="label">Exam Session:</td>
            <td>{{ exam_session.name }}</td>
            <td class="label">Exam Type:</td>
            <td>{{ exam_session.exam_type.name }}</td>
        </tr>
        <tr>
            <td class="label">Exam Date:</td>
            <td>{{ exam_session.exam_date|date:"F d, Y" }}</td>
            <td class="label">Term:</td>
            <td>{{ exam_session.term.get_term_number_display }}</td>
        </tr>
    </table>
</div>

<!-- PERFORMANCE SUMMARY -->
<table class="summary-table">
<tr>
    <td>
        <div class="summary-title">Total Marks</div>
        <div class="summary-value">{{ overall_stats.total_marks|floatformat:1 }}</div>
    </td>
    <td>
        <div class="summary-title">Average Marks</div>
        <div class="summary-value">{{ overall_stats.average_marks|floatformat:1 }}</div>
    </td>
    <td>
        <div class="summary-title">Average Grade</div>
        <div class="summary-value">{{ metrics.average_grade|default:"-" }}</div>
    </td>
    <td>
        <div class="summary-title">Division</div>
        <div class="summary-value">
            {% if metrics and metrics.division %}
                {{ metrics.division.division }}-{{ metrics.total_grade_points }}
            {% else %}-{% endif %}
        </div>
    </td>
</tr>
</table>

<!-- RANKING -->
{% if positions and positions.class_position %}
<div class="ranking-box">
    <div class="ranking-title">Class Position</div>
    <div class="ranking-value">
        {{ positions.class_position|ordinal }}/{{ total_students_count|default:"-" }}
    </div>
</div>
{% endif %}

<!-- SUBJECT RESULTS -->
<h3 style="margin-top:20px;">Subject-wise Performance</h3>

<table class="results-table">
<thead>
<tr>
    <th>#</th>
    <th>Subject</th>
    <th>Code</th>
    <th>Marks</th>
    <th>%</th>
    <th>Grade</th>
    <th>Points</th>
    <th>Position</th>
</tr>
</thead>
<tbody>
{% for item in subject_results %}
<tr>
    <td class="center">{{ forloop.counter }}</td>
    <td>{{ item.subject.name }}</td>
    <td class="center">{{ item.subject.code }}</td>
    <td class="center">{{ item.marks|floatformat:1|default:"-" }}</td>
    <td class="center">{{ item.percentage|floatformat:1|default:"-" }}</td>
    <td class="center">
        {% if item.grade %}
        <span class="grade-badge">{{ item.grade }}</span>
        {% else %}-{% endif %}
    </td>
    <td class="center">{{ item.grade_point|floatformat:1|default:"-" }}</td>
    <td class="center">{{ item.position|ordinal|default:"-" }}/{{ item.total_students_in_subject|default:"-" }}</td>
</tr>
{% endfor %}
</tbody>

<tfoot>
<tr>
    <td colspan="3" class="center"><strong>Totals / Average</strong></td>
    <td class="center"><strong>{{ overall_stats.total_marks|floatformat:1 }}</strong></td>
    <td class="center"><strong>{{ overall_stats.average_marks|floatformat:1 }}</strong></td>
    <td class="center"><strong>{{ metrics.average_grade|default:"-" }}</strong></td>
    <td class="center"><strong>{{ overall_stats.total_grade_points|floatformat:1 }}</strong></td>
    <td class="center">
        <strong>{{ positions.class_position|ordinal|default:"-" }}/{{ total_students_count|default:"-" }}</strong>
    </td>
</tr>
</tfoot>
</table>

<!-- SIGNATURES -->
<table class="signature-table">
<tr>
    <td>
        <div class="signature-line"></div>
        Class Teacher
    </td>
    <td>
        <div class="signature-line"></div>
        Head of Department
    </td>
    <td>
        <div class="signature-line"></div>
        School Principal
    </td>
</tr>
</table>

<!-- FOOTER -->
<div class="footer">
    Generated on {{ generated_date|date:"F d, Y H:i" }} |
    Generated by {{ generated_by }} <br>
    This is an official academic document.
</div>

</body>
</html>
