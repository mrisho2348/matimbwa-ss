{% extends 'admin/base.html' %}
{% load static %}

{% block title %}Teaching Assignments Management{% endblock %}

{% block breadcrumb %}
    <button type="button" class="btn btn-primary" data-toggle="modal" data-target="#createAssignmentModal">
        <i class="fas fa-plus-circle"></i> New Assignment
    </button>
    <button type="button" class="btn btn-outline-primary" data-toggle="modal" data-target="#bulkAssignmentModal">
        <i class="fas fa-copy"></i> Clone Assignments
    </button>
{% endblock breadcrumb %}

{% block extra_css %}
<style>
    /* Custom Styles for Teaching Assignments */
    .assignment-card {
        border-left: 4px solid;
        border-radius: 5px;
        transition: all 0.3s ease;
    }
    
    .assignment-class { border-left-color: #17a2b8; }
    .assignment-stream { border-left-color: #28a745; }
    .assignment-both { border-left-color: #6f42c1; }
    
    .assignment-type-badge {
        padding: 3px 8px;
        border-radius: 12px;
        font-size: 10px;
        font-weight: 600;
        text-transform: uppercase;
    }
    
    .type-class { background-color: #17a2b8; color: white; }
    .type-stream { background-color: #28a745; color: white; }
    .type-both { background-color: #6f42c1; color: white; }
    
    .subject-badge {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        padding: 5px 10px;
        border-radius: 15px;
        font-size: 12px;
    }
    
    .class-teacher-badge {
        background-color: #ffc107;
        color: #212529;
        padding: 5px 10px;
        border-radius: 15px;
        font-size: 12px;
        font-weight: 600;
    }
    
    .period-count-badge {
        background-color: #e9ecef;
        color: #495057;
        padding: 3px 8px;
        border-radius: 10px;
        font-size: 11px;
        font-weight: 600;
    }
    
    .academic-year-selector {
        margin-bottom: 20px;
        padding: 15px;
        background-color: #f8f9fa;
        border-radius: 5px;
    }
    
    .quick-actions {
        display: flex;
        gap: 4px;
    }
    
    .quick-action-btn {
        width: 28px;
        height: 28px;
        padding: 0;
        border-radius: 50%;
        border: none;
        display: inline-flex;
        align-items: center;
        justify-content: center;
        transition: all 0.2s ease;
    }
    
    .quick-action-btn i {
        font-size: 0.75rem;
        color: #ffffff !important;
    }
    
    .btn-warning.quick-action-btn i {
        color: #212529 !important;
    }
    
    .modal-lg-custom {
        max-width: 900px;
    }
    
    /* Select2 Custom Styling */
    .select2-container--bootstrap4 .select2-selection--single {
        height: calc(2.25rem + 2px) !important;
        padding: 0.375rem 0.75rem !important;
    }
    
    .select2-container--bootstrap4 .select2-selection--multiple {
        min-height: calc(2.25rem + 2px) !important;
        padding: 0.375rem 0.75rem !important;
    }
    
    /* DataTable Custom Styles */
    .dataTables_wrapper .dataTables_filter {
        float: right;
    }
    
    .dataTables_wrapper .dataTables_length {
        float: left;
    }
    
    .dataTables_wrapper .dataTables_paginate {
        margin-top: 10px;
    }
    
    .dataTables_wrapper .dataTables_info {
        padding-top: 10px;
    }
    
    .dt-buttons {
        margin-bottom: 10px;
    }
    
    /* Filter Dropdown */
    .filter-dropdown {
        margin-right: 10px;
    }
    
    .dataTables_filter input {
        border-radius: 20px;
        padding: 5px 15px;
        border: 1px solid #ced4da;
    }
    
    .dataTables_length select {
        border-radius: 20px;
        padding: 5px 15px;
        border: 1px solid #ced4da;
    }
</style>
{% endblock %}

{% block content %}
<section class="content">
    <div class="container-fluid">
        <!-- Toast Notifications -->
        <div id="success-toast" class="alert alert-success alert-dismissible fade success-toast" style="display: none; position: fixed; top: 20px; right: 20px; z-index: 1060;">
            <strong><i class="fas fa-check-circle"></i> Success!</strong> 
            <span id="success-message"></span>
            <button type="button" class="close" onclick="$('#success-toast').fadeOut()">
                <span aria-hidden="true">&times;</span>
            </button>
        </div>

        <div id="error-toast" class="alert alert-danger alert-dismissible fade error-toast" style="display: none; position: fixed; top: 20px; right: 20px; z-index: 1060;">
            <strong><i class="fas fa-exclamation-circle"></i> Error!</strong> 
            <span id="error-message"></span>
            <button type="button" class="close" onclick="$('#error-toast').fadeOut()">
                <span aria-hidden="true">&times;</span>
            </button>
        </div>

        <!-- Academic Year Selector -->
        <div class="academic-year-selector">
            <div class="row align-items-center">
                <div class="col-md-6">
                    <h5 class="mb-0">
                        <i class="fas fa-calendar-alt text-primary"></i>
                        Academic Year: 
                        <strong id="current-academic-year">{{ current_academic_year.name }}</strong>
                    </h5>
                    <small class="text-muted">Viewing assignments for selected academic year</small>
                </div>
                <div class="col-md-6 text-right">
                    <div class="dropdown">
                        <button class="btn btn-outline-primary dropdown-toggle" type="button" 
                                id="academicYearDropdown" data-toggle="dropdown">
                            Change Academic Year
                        </button>
                        <div class="dropdown-menu dropdown-menu-right">
                            {% for ay in academic_years %}
                            <a class="dropdown-item select-academic-year" href="#" data-id="{{ ay.id }}">
                                {{ ay.name }}
                                {% if ay.is_active %}<span class="badge badge-success ml-2">Active</span>{% endif %}
                            </a>
                            {% endfor %}
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Main Assignments Table with DataTable -->
        <div class="card shadow-lg">
            <div class="card-header bg-primary text-white d-flex justify-content-between align-items-center">
                <h6 class="header-title mb-0 text-uppercase">
                    <i class="fas fa-tasks"></i> Teaching Assignments
                </h6>
                <div class="d-flex align-items-center">
                    <!-- Assignment Type Filter -->
                    <div class="dropdown filter-dropdown">
                        <button class="btn btn-outline-light dropdown-toggle" type="button" 
                                id="assignmentTypeFilter" data-toggle="dropdown">
                            <i class="fas fa-filter"></i> Type
                        </button>
                        <div class="dropdown-menu dropdown-menu-right">
                            <a class="dropdown-item filter-type" data-type="">All Types</a>
                            <a class="dropdown-item filter-type" data-type="class">Class Level</a>
                            <a class="dropdown-item filter-type" data-type="stream">Stream Specific</a>
                        </div>
                    </div>
                    
                    <!-- Status Filter -->
                    <div class="dropdown filter-dropdown">
                        <button class="btn btn-outline-light dropdown-toggle" type="button" 
                                id="statusFilter" data-toggle="dropdown">
                            <i class="fas fa-toggle-on"></i> Status
                        </button>
                        <div class="dropdown-menu dropdown-menu-right">
                            <a class="dropdown-item filter-status" data-status="">All Status</a>
                            <a class="dropdown-item filter-status" data-status="active">Active</a>
                            <a class="dropdown-item filter-status" data-status="inactive">Inactive</a>
                        </div>
                    </div>
                    
                    <!-- Class Teacher Filter -->
                    <div class="dropdown filter-dropdown">
                        <button class="btn btn-outline-light dropdown-toggle" type="button" 
                                id="classTeacherFilter" data-toggle="dropdown">
                            <i class="fas fa-user-tie"></i> Role
                        </button>
                        <div class="dropdown-menu dropdown-menu-right">
                            <a class="dropdown-item filter-role" data-role="">All Roles</a>
                            <a class="dropdown-item filter-role" data-role="class_teacher">Class Teachers</a>
                            <a class="dropdown-item filter-role" data-role="subject_teacher">Subject Teachers</a>
                        </div>
                    </div>
                </div>
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-hover table-bordered table-striped" id="assignments-table">
                        <thead class="bg-light">
                            <tr>
                                <th>#</th>
                                <th>Teacher</th>
                                <th>Subject/Class Teacher</th>
                                <th>Class Level</th>
                                <th>Stream</th>
                                <th>Periods/Week</th>
                                <th>Type</th>
                                <th>Status</th>
                                <th class="text-center">Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for assignment in assignments %}
                            <tr>
                                <td>{{ forloop.counter }}</td>
                                <td>
                                    <div class="d-flex align-items-center">
                                        {% if assignment.staff.profile_picture %}
                                        <img src="{{ assignment.staff.profile_picture.url }}" 
                                             class="avatar me-2" style="width: 40px; height: 40px; border-radius: 50%; object-fit: cover;">
                                        {% else %}
                                        <div class="avatar-placeholder me-2" style="width: 40px; height: 40px; border-radius: 50%; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); display: flex; align-items: center; justify-content: center; color: white; font-weight: 600;">
                                            {{ assignment.staff.get_full_name|slice:":1" }}
                                        </div>
                                        {% endif %}
                                        <div>
                                            <strong>{{ assignment.staff.get_full_name }}</strong>
                                            <div class="small text-muted">
                                                {{ assignment.staff.department.name|default:"No Department" }}
                                            </div>
                                        </div>
                                    </div>
                                </td>
                                <td>
                                    {% if assignment.is_class_teacher %}
                                    <span class="class-teacher-badge">
                                        <i class="fas fa-user-tie"></i> Class Teacher
                                    </span>
                                    {% else %}
                                    <span class="subject-badge">
                                        <i class="fas fa-book"></i> {{ assignment.subject.name }}
                                    </span>
                                    <div class="small text-muted mt-1">
                                        {{ assignment.subject.educational_level.code }}
                                    </div>
                                    {% endif %}
                                </td>
                                <td>
                                    <strong>{{ assignment.class_level.name }}</strong>
                                    <div class="small text-muted">
                                        {{ assignment.class_level.educational_level.name }}
                                    </div>
                                </td>
                                <td>
                                    {% if assignment.stream_class %}
                                    <span class="badge badge-info">
                                        {{ assignment.stream_class.stream_letter }}
                                    </span>
                                    {% else %}
                                    <span class="text-muted">All Streams</span>
                                    {% endif %}
                                </td>
                                <td class="text-center">
                                    {% if not assignment.is_class_teacher %}
                                    <span class="period-count-badge">
                                        {{ assignment.period_count }} periods
                                    </span>
                                    {% else %}
                                    <span class="text-muted">-</span>
                                    {% endif %}
                                </td>
                                <td>
                                    <span class="assignment-type-badge type-{{ assignment.assignment_type }}">
                                        {{ assignment.get_assignment_type_display }}
                                    </span>
                                </td>
                                <td>
                                    {% if assignment.is_active %}
                                    <span class="badge badge-success">Active</span>
                                    {% else %}
                                    <span class="badge badge-secondary">Inactive</span>
                                    {% endif %}
                                    {% if assignment.start_date %}
                                    <div class="small text-muted">
                                        From {{ assignment.start_date|date:"d M Y" }}
                                    </div>
                                    {% endif %}
                                </td>
                                <td class="text-center">
                                    <div class="quick-actions">
                                        <button class="btn btn-sm btn-primary quick-action-btn edit-assignment-btn"
                                                data-id="{{ assignment.id }}"
                                                title="Edit Assignment">
                                            <i class="fas fa-edit"></i>
                                        </button>
                                        <button class="btn btn-sm btn-warning quick-action-btn toggle-assignment-btn"
                                                data-id="{{ assignment.id }}"
                                                data-active="{{ assignment.is_active|yesno:'true,false' }}"
                                                title="{% if assignment.is_active %}Deactivate{% else %}Activate{% endif %}">
                                            <i class="fas {% if assignment.is_active %}fa-toggle-on{% else %}fa-toggle-off{% endif %}"></i>
                                        </button>
                                        <button class="btn btn-sm btn-danger quick-action-btn delete-assignment-btn"
                                                data-id="{{ assignment.id }}"
                                                title="Delete Assignment">
                                            <i class="fas fa-trash"></i>
                                        </button>
                                    </div>
                                </td>
                            </tr>                            
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</section>

<!-- Create Assignment Modal -->
<div class="modal fade" id="createAssignmentModal" tabindex="-1" role="dialog" aria-labelledby="createAssignmentModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg-custom" role="document">
        <div class="modal-content">
            <div class="modal-header bg-primary text-white">
                <h5 class="modal-title" id="createAssignmentModalLabel">
                    <i class="fas fa-plus-circle"></i> Create Teaching Assignment
                </h5>
                <button type="button" class="close text-white" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <form id="create-assignment-form">
                {% csrf_token %}
                <input type="hidden" name="action" value="create_assignment">
                <input type="hidden" name="academic_year" value="{{ current_academic_year.id }}">
                <div class="modal-body">
                    <div class="row">
                        <div class="col-md-6">
                            <div class="form-group">
                                <label for="staff">Teacher *</label>
                                <select class="form-control select2bs4 select2-create" id="staff" name="staff" required>
                                    <option value="">Select Teacher</option>
                                    {% for staff in all_staff %}
                                    <option value="{{ staff.id }}">
                                        {{ staff.get_full_name }}
                                        {% if staff.department %}
                                        - {{ staff.department.name }}
                                        {% endif %}
                                    </option>
                                    {% endfor %}
                                </select>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="form-group">
                                <label for="assignment_type">Assignment Type *</label>
                                <select class="form-control select2bs4 select2-create" id="assignment_type" name="assignment_type" required>
                                    <option value="">Select Type</option>
                                    <option value="class">Class Level (All Streams)</option>
                                    <option value="stream">Stream Specific</option>
                                </select>
                            </div>
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-md-6">
                            <div class="form-group">
                                <label for="class_level">Class Level *</label>
                                <select class="form-control select2bs4 select2-create" id="class_level" name="class_level" required>
                                    <option value="">Select Class Level</option>
                                    {% for class_level in class_levels %}
                                    <option value="{{ class_level.id }}">
                                        {{ class_level.name }} ({{ class_level.educational_level.name }})
                                    </option>
                                    {% endfor %}
                                </select>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="form-group" id="stream-group" style="display: none;">
                                <label for="stream_class">Stream (Optional for Stream Type)</label>
                                <select class="form-control select2bs4 select2-create" id="stream_class" name="stream_class">
                                    <option value="">Select Stream</option>
                                    <!-- Streams will be populated based on class level -->
                                </select>
                            </div>
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-md-6">
                            <div class="form-group">
                                <div class="form-check">
                                    <input type="checkbox" class="form-check-input" id="is_class_teacher" name="is_class_teacher">
                                    <label class="form-check-label" for="is_class_teacher">
                                        This is a Class Teacher Assignment
                                    </label>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="form-group" id="subject-group">
                                <label for="subject">Subject *</label>
                                <select class="form-control select2bs4 select2-create" id="subject" name="subject">
                                    <option value="">Select Subject</option>
                                    <!-- Subjects will be populated based on class level's educational level -->
                                </select>
                            </div>
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-md-6">
                            <div class="form-group">
                                <label for="period_count">Periods per Week</label>
                                <input type="number" class="form-control" id="period_count" name="period_count" 
                                       min="0" max="40" value="0" required>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="form-group">
                                <label for="start_date">Start Date (Optional)</label>
                                <input type="date" class="form-control" id="start_date" name="start_date">
                            </div>
                        </div>
                    </div>

                    <div class="alert alert-info">
                        <i class="fas fa-info-circle"></i>
                        <strong>Note:</strong> 
                        <ul class="mb-0">
                            <li>Class Teacher assignments should not have subjects assigned</li>
                            <li>Stream selection is optional for stream type assignments</li>
                            <li>Period count is only for subject teaching assignments</li>
                        </ul>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-primary" id="create-assignment-btn">
                        <span class="spinner-border spinner-border-sm" role="status" style="display: none;"></span>
                        Create Assignment
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Edit Assignment Modal -->
<div class="modal fade" id="editAssignmentModal" tabindex="-1" role="dialog" aria-labelledby="editAssignmentModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg-custom" role="document">
        <div class="modal-content">
            <div class="modal-header bg-warning text-white">
                <h5 class="modal-title" id="editAssignmentModalLabel">
                    <i class="fas fa-edit"></i> Edit Teaching Assignment
                </h5>
                <button type="button" class="close text-white" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <form id="edit-assignment-form">
                {% csrf_token %}
                <input type="hidden" name="action" value="edit_assignment">
                <input type="hidden" id="edit-assignment-id" name="assignment_id">
                <div class="modal-body">
                    <!-- Content will be loaded via AJAX -->
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-warning" id="update-assignment-btn">
                        <span class="spinner-border spinner-border-sm" role="status" style="display: none;"></span>
                        Update Assignment
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Delete Confirmation Modal -->
<div class="modal fade" id="deleteAssignmentModal" tabindex="-1" role="dialog" aria-labelledby="deleteAssignmentModalLabel" aria-hidden="true">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header bg-danger text-white">
                <h5 class="modal-title" id="deleteAssignmentModalLabel">
                    <i class="fas fa-trash"></i> Delete Assignment
                </h5>
                <button type="button" class="close text-white" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <p>Are you sure you want to delete this teaching assignment?</p>
                <div class="alert alert-warning">
                    <i class="fas fa-exclamation-triangle"></i>
                    This action cannot be undone. All associated data will be permanently removed.
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-danger" id="confirm-delete-btn">
                    <span class="spinner-border spinner-border-sm" role="status" style="display: none;"></span>
                    Delete Assignment
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Clone Assignments Modal -->
<div class="modal fade" id="bulkAssignmentModal" tabindex="-1" role="dialog" aria-labelledby="bulkAssignmentModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg" role="document">
        <div class="modal-content">
            <div class="modal-header bg-info text-white">
                <h5 class="modal-title" id="bulkAssignmentModalLabel">
                    <i class="fas fa-copy"></i> Clone Assignments
                </h5>
                <button type="button" class="close text-white" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <form id="clone-assignments-form">
                {% csrf_token %}
                <input type="hidden" name="action" value="clone_assignments">
                <div class="modal-body">
                    <div class="row">
                        <div class="col-md-6">
                            <div class="form-group">
                                <label for="source_academic_year">Source Academic Year *</label>
                                <select class="form-control select2bs4 select2-bulk" id="source_academic_year" name="source_academic_year" required>
                                    <option value="">Select Source Year</option>
                                    {% for ay in academic_years %}
                                    <option value="{{ ay.id }}" {% if ay.id == current_academic_year.id %}selected{% endif %}>
                                        {{ ay.name }}
                                    </option>
                                    {% endfor %}
                                </select>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="form-group">
                                <label for="target_academic_year">Target Academic Year *</label>
                                <select class="form-control select2bs4 select2-bulk" id="target_academic_year" name="target_academic_year" required>
                                    <option value="">Select Target Year</option>
                                    {% for ay in academic_years %}
                                    <option value="{{ ay.id }}">
                                        {{ ay.name }}
                                    </option>
                                    {% endfor %}
                                </select>
                            </div>
                        </div>
                    </div>
                    
                    <div class="alert alert-warning">
                        <i class="fas fa-exclamation-triangle"></i>
                        <strong>Warning:</strong> This will copy all active teaching assignments from the source 
                        academic year to the target academic year. Any existing assignments in the target year 
                        for the same teachers will be preserved (not overwritten).
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-info" id="clone-assignments-btn">
                        <span class="spinner-border spinner-border-sm" role="status" style="display: none;"></span>
                        Clone Assignments
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>
{% endblock content %}

{% block extra_js %}
<script>
$(document).ready(function() {
    // Global variables
    let currentAcademicYearId = {{ current_academic_year.id }};
    let assignmentToDelete = null;
    let dataTable = null;

    // Initialize DataTable
    function initializeDataTable() {
        dataTable = $('#assignments-table').DataTable({
            "dom": "<'row'<'col-sm-12 col-md-6'l><'col-sm-12 col-md-6'f>>" +
                   "<'row'<'col-sm-12'tr>>" +
                   "<'row'<'col-sm-12 col-md-5'i><'col-sm-12 col-md-7'p>>",
            "lengthMenu": [[10, 25, 50, 100, -1], [10, 25, 50, 100, "All"]],
            "pageLength": 25,
            "responsive": true,
            "autoWidth": false,
            "ordering": true,
            "order": [[0, 'asc']],
            "language": {
                "emptyTable": "<div class='text-center py-4'><i class='fas fa-tasks fa-2x mb-2'></i><br>No teaching assignments found.</div>",
                "search": "_INPUT_",
                "searchPlaceholder": "Search assignments...",
                "lengthMenu": "_MENU_ records per page",
                "info": "Showing _START_ to _END_ of _TOTAL_ assignments",
                "infoEmpty": "Showing 0 to 0 of 0 assignments",
                "infoFiltered": "(filtered from _MAX_ total assignments)",
                "paginate": {
                    "first": "First",
                    "last": "Last",
                    "next": "Next",
                    "previous": "Previous"
                }
            },
            "columnDefs": [
                {
                    "targets": 0,
                    "orderable": false,
                    "searchable": false,
                    "width": "50px"
                },
                {
                    "targets": 8,
                    "orderable": false,
                    "searchable": false,
                    "width": "100px"
                }
            ],
            "initComplete": function() {
                setupCustomFilters();
            }
        });
    }

    // Setup custom filters for DataTable
    function setupCustomFilters() {
        // Filter by assignment type
        $('.filter-type').click(function(e) {
            e.preventDefault();
            const type = $(this).data('type');
            const buttonText = type ? $(this).text() : 'Type';
            $('#assignmentTypeFilter').html(`<i class="fas fa-filter"></i> ${buttonText}`);
            
            if (type) {
                dataTable.column(6).search(type, true, false).draw();
            } else {
                dataTable.column(6).search('').draw();
            }
        });

        // Filter by status
        $('.filter-status').click(function(e) {
            e.preventDefault();
            const status = $(this).data('status');
            const buttonText = status ? $(this).text() : 'Status';
            $('#statusFilter').html(`<i class="fas fa-toggle-on"></i> ${buttonText}`);
            
            if (status === 'active') {
                dataTable.column(7).search('Active', true, false).draw();
            } else if (status === 'inactive') {
                dataTable.column(7).search('Inactive', true, false).draw();
            } else {
                dataTable.column(7).search('').draw();
            }
        });

        // Filter by role
        $('.filter-role').click(function(e) {
            e.preventDefault();
            const role = $(this).data('role');
            const buttonText = role ? $(this).text() : 'Role';
            $('#classTeacherFilter').html(`<i class="fas fa-user-tie"></i> ${buttonText}`);
            
            if (role === 'class_teacher') {
                dataTable.column(2).search('Class Teacher', true, false).draw();
            } else if (role === 'subject_teacher') {
                $.fn.dataTable.ext.search.push(function(settings, data, dataIndex) {
                    const cellData = data[2];
                    return !cellData.includes('Class Teacher');
                });
                dataTable.draw();
                $.fn.dataTable.ext.search.pop();
            } else {
                dataTable.column(2).search('').draw();
            }
        });
    }

    // Initialize Select2
    function initializeSelect2(selector, modalSelector) {
        $(selector).select2({
            theme: 'bootstrap4',
            dropdownParent: $(modalSelector),
            width: '100%'
        });
    }

    // Load subjects based on class level
    function loadSubjectsForClass(classId, targetSelect, selectedSubjectId = null) {
        if (!classId) {
            $(targetSelect).empty().append('<option value="">Select Subject</option>').trigger('change');
            return;
        }

        $.ajax({
            url: '{% url "admin_get_subjects_by_class" %}',
            method: 'GET',
            data: { class_id: classId },
            success: function(data) {
                if (data.success) {
                    $(targetSelect).empty().append('<option value="">Select Subject</option>');
                    $.each(data.subjects, function(index, subject) {
                        const option = new Option(subject.name, subject.id, false, false);
                        if (selectedSubjectId && subject.id == selectedSubjectId) {
                            option.selected = true;
                        }
                        $(targetSelect).append(option);
                    });
                    $(targetSelect).trigger('change');
                } else {
                    $(targetSelect).empty().append('<option value="">No subjects available</option>').trigger('change');
                }
            },
            error: function() {
                $(targetSelect).empty().append('<option value="">Error loading subjects</option>').trigger('change');
            }
        });
    }

    // Load streams for class level
    function loadStreamsForClass(classLevelId, targetSelect, selectedStreamId = null) {
        if (!classLevelId) {
            $(targetSelect).empty().append('<option value="">Select Stream</option>').trigger('change');
            return;
        }

        $.ajax({
            url: '{% url "admin_get_streams_for_class" %}',
            method: 'GET',
            data: { class_level_id: classLevelId },
            success: function(data) {
                $(targetSelect).empty().append('<option value="">Select Stream</option>');
                $.each(data.streams, function(index, stream) {
                    const option = new Option(stream.name, stream.id, false, false);
                    if (selectedStreamId && stream.id == selectedStreamId) {
                        option.selected = true;
                    }
                    $(targetSelect).append(option);
                });
                $(targetSelect).trigger('change');
            }
        });
    }

    // Show toast messages
    function showToast(message, type = 'success') {
        const toastId = type === 'success' ? '#success-toast' : '#error-toast';
        const messageId = type === 'success' ? '#success-message' : '#error-message';
        
        $(messageId).text(message);
        $(toastId).addClass('show').fadeIn();
        
        setTimeout(function() {
            $(toastId).fadeOut(function() {
                $(this).removeClass('show');
            });
        }, type === 'success' ? 3000 : 5000);
    }

    // Set button loading state
    function setButtonLoading(btn, isLoading) {
        const spinner = btn.find('.spinner-border');
        if (isLoading) {
            btn.data('original-text', btn.html());
            btn.prop('disabled', true);
            spinner.show();
        } else {
            btn.prop('disabled', false);
            spinner.hide();
            btn.html(btn.data('original-text'));
        }
    }

    // Get CSRF token
    function getCSRFToken() {
        return $('input[name="csrfmiddlewaretoken"]').val();
    }

    // ============ INITIALIZATION ============
    initializeDataTable();

    // Initialize Select2 for modals when they open
    $('#createAssignmentModal').on('shown.bs.modal', function() {
        $(this).find('.select2bs4').each(function() {
            if (!$(this).hasClass('select2-hidden-accessible')) {
                initializeSelect2($(this), '#createAssignmentModal');
            }
        });
    });

    $('#bulkAssignmentModal').on('shown.bs.modal', function() {
        $(this).find('.select2bs4').each(function() {
            if (!$(this).hasClass('select2-hidden-accessible')) {
                initializeSelect2($(this), '#bulkAssignmentModal');
            }
        });
    });

    // ============ CREATE MODAL HANDLERS ============
    
    // Academic year selection
    $('.select-academic-year').click(function(e) {
        e.preventDefault();
        const yearId = $(this).data('id');
        window.location.href = `?academic_year=${yearId}`;
    });

    // Assignment type change
    $('#createAssignmentModal').on('change', '#assignment_type', function() {
        const type = $(this).val();
        const classLevelId = $('#createAssignmentModal #class_level').val();
        
        if (type === 'stream' && classLevelId) {
            $('#stream-group').show();
            loadStreamsForClass(classLevelId, '#stream_class');
        } else {
            $('#stream-group').hide();
            $('#stream_class').val('').trigger('change');
        }
    });

    // Class teacher checkbox
    $('#createAssignmentModal').on('change', '#is_class_teacher', function() {
        if ($(this).is(':checked')) {
            $('#subject-group').hide();
            $('#subject').prop('required', false);
        } else {
            $('#subject-group').show();
            $('#subject').prop('required', true);
        }
    });

    // Class level change
    $('#createAssignmentModal').on('change', '#class_level', function() {
        const classLevelId = $(this).val();
        const assignmentType = $('#assignment_type').val();
        
        loadSubjectsForClass(classLevelId, '#subject');
        
        if (classLevelId && assignmentType === 'stream') {
            loadStreamsForClass(classLevelId, '#stream_class');
            $('#stream-group').show();
        } else {
            $('#stream-group').hide();
        }
    });

    // Create form submission
    $('#create-assignment-form').submit(function(e) {
        e.preventDefault();
        const btn = $('#create-assignment-btn');
        setButtonLoading(btn, true);
        
        $.ajax({
            url: '{% url "admin_teaching_assignments_crud" %}',
            method: 'POST',
            headers: { 'X-CSRFToken': getCSRFToken() },
            data: new FormData(this),
            processData: false,
            contentType: false,
            success: function(data) {
                if (data.success) {
                    $('#createAssignmentModal').modal('hide');
                    showToast(data.message, 'success');
                    setTimeout(() => location.reload(), 1500);
                } else {
                    showToast(data.message, 'danger');
                }
                setButtonLoading(btn, false);
            },
            error: function(xhr) {
                showToast('An error occurred: ' + xhr.responseText, 'danger');
                setButtonLoading(btn, false);
            }
        });
    });

    // ============ EDIT MODAL HANDLERS ============
    
    // Edit assignment button click
    $(document).on('click', '.edit-assignment-btn', function() {
        const assignmentId = $(this).data('id');
        
        $.ajax({
            url: '{% url "admin_get_assignment_details" %}',
            method: 'GET',
            data: { assignment_id: assignmentId },
            success: function(data) {
                if (data.success) {
                    $('#edit-assignment-form').find('.modal-body').html(data.html);
                    $('#edit-assignment-id').val(assignmentId);
                    $('#editAssignmentModal').modal('show');
                    
                    // Initialize Select2 for the edit modal
                    setTimeout(() => {
                        $('#editAssignmentModal').find('.select2bs4').each(function() {
                            if (!$(this).hasClass('select2-hidden-accessible')) {
                                initializeSelect2($(this), '#editAssignmentModal');
                            }
                        });
                        
                        // Load initial subjects if class level exists
                        const initialClassId = $('#editAssignmentModal #class_level').val();
                        if (initialClassId) {
                            loadSubjectsForClass(
                                initialClassId, 
                                '#editAssignmentModal #subject',
                                $('#editAssignmentModal #subject').val()
                            );
                        }
                    }, 100);
                } else {
                    showToast(data.message, 'danger');
                }
            }
        });
    });

    // Handle edit modal close/cancel buttons - FIXED
    $(document).on('click', '#editAssignmentModal .close, #editAssignmentModal .btn-secondary', function(e) {
        e.preventDefault();
        e.stopPropagation();
        $('#editAssignmentModal').modal('hide');
    });

    // Handle class level change in edit modal
    $(document).on('change', '#editAssignmentModal #class_level', function() {
        const classLevelId = $(this).val();
        const assignmentType = $('#editAssignmentModal #assignment_type').val();
        const currentSubjectId = $('#editAssignmentModal #subject').val();
        
        loadSubjectsForClass(classLevelId, '#editAssignmentModal #subject', currentSubjectId);
        
        if (classLevelId && assignmentType === 'stream') {
            const currentStreamId = $('#editAssignmentModal #stream_class').val();
            loadStreamsForClass(classLevelId, '#editAssignmentModal #stream_class', currentStreamId);
            $('#editAssignmentModal #stream-group').show();
        } else {
            $('#editAssignmentModal #stream-group').hide();
        }
    });

    // Handle assignment type change in edit modal
    $(document).on('change', '#editAssignmentModal #assignment_type', function() {
        const type = $(this).val();
        const classLevelId = $('#editAssignmentModal #class_level').val();
        
        if (type === 'stream' && classLevelId) {
            const currentStreamId = $('#editAssignmentModal #stream_class').val();
            $('#editAssignmentModal #stream-group').show();
            loadStreamsForClass(classLevelId, '#editAssignmentModal #stream_class', currentStreamId);
        } else {
            $('#editAssignmentModal #stream-group').hide();
            $('#editAssignmentModal #stream_class').val('').trigger('change');
        }
    });

    // Handle class teacher checkbox in edit modal
    $(document).on('change', '#editAssignmentModal #is_class_teacher', function() {
        if ($(this).is(':checked')) {
            $('#editAssignmentModal #subject-group').hide();
            $('#editAssignmentModal #subject').prop('required', false);
        } else {
            $('#editAssignmentModal #subject-group').show();
            $('#editAssignmentModal #subject').prop('required', true);
        }
    });

    // Edit form submission
    $(document).on('submit', '#edit-assignment-form', function(e) {
        e.preventDefault();
        const btn = $('#update-assignment-btn');
        setButtonLoading(btn, true);
        
        $.ajax({
            url: '{% url "admin_teaching_assignments_crud" %}',
            method: 'POST',
            headers: { 'X-CSRFToken': getCSRFToken() },
            data: new FormData(this),
            processData: false,
            contentType: false,
            success: function(data) {
                if (data.success) {
                    $('#editAssignmentModal').modal('hide');
                    showToast(data.message, 'success');
                    setTimeout(() => location.reload(), 1500);
                } else {
                    showToast(data.message, 'danger');
                }
                setButtonLoading(btn, false);
            },
            error: function(xhr) {
                showToast('An error occurred: ' + xhr.responseText, 'danger');
                setButtonLoading(btn, false);
            }
        });
    });

    // ============ DELETE MODAL HANDLERS ============
    
    // Delete assignment button click
    $(document).on('click', '.delete-assignment-btn', function() {
        assignmentToDelete = $(this).data('id');
        $('#deleteAssignmentModal').modal('show');
    });

    // Handle delete modal close/cancel buttons - FIXED
    $(document).on('click', '#deleteAssignmentModal .close, #deleteAssignmentModal .btn-secondary', function(e) {
        e.preventDefault();
        e.stopPropagation();
        $('#deleteAssignmentModal').modal('hide');
    });

    // Confirm delete assignment
    $('#confirm-delete-btn').click(function() {
        const btn = $(this);
        setButtonLoading(btn, true);
        
        $.ajax({
            url: '{% url "admin_teaching_assignments_crud" %}',
            method: 'POST',
            headers: { 'X-CSRFToken': getCSRFToken() },
            data: {
                action: 'delete_assignment',
                assignment_id: assignmentToDelete,
                csrfmiddlewaretoken: getCSRFToken()
            },
            success: function(data) {
                if (data.success) {
                    $('#deleteAssignmentModal').modal('hide');
                    setTimeout(() => location.reload(), 500);
                    showToast(data.message, 'success');
                } else {
                    showToast(data.message, 'danger');
                }
                setButtonLoading(btn, false);
                assignmentToDelete = null;
            },
            error: function() {
                showToast('An error occurred during deletion', 'danger');
                setButtonLoading(btn, false);
            }
        });
    });

    // ============ TOGGLE STATUS HANDLERS ============
    
    // Toggle assignment status
    $(document).on('click', '.toggle-assignment-btn', function() {
        const btn = $(this);
        const assignmentId = btn.data('id');
        setButtonLoading(btn, true);
        
        $.ajax({
            url: '{% url "admin_teaching_assignments_crud" %}',
            method: 'POST',
            headers: { 'X-CSRFToken': getCSRFToken() },
            data: {
                action: 'toggle_assignment',
                assignment_id: assignmentId,
                csrfmiddlewaretoken: getCSRFToken()
            },
            success: function(data) {
                if (data.success) {
                    setTimeout(() => location.reload(), 500);
                    showToast(data.message, 'success');
                } else {
                    showToast(data.message, 'danger');
                }
                setButtonLoading(btn, false);
            },
            error: function() {
                showToast('An error occurred while toggling status', 'danger');
                setButtonLoading(btn, false);
            }
        });
    });

    // ============ CLONE ASSIGNMENTS HANDLERS ============
    
    // Clone assignments form submission
    $('#clone-assignments-form').submit(function(e) {
        e.preventDefault();
        const btn = $('#clone-assignments-btn');
        setButtonLoading(btn, true);
        
        $.ajax({
            url: '{% url "admin_teaching_assignments_crud" %}',
            method: 'POST',
            headers: { 'X-CSRFToken': getCSRFToken() },
            data: new FormData(this),
            processData: false,
            contentType: false,
            success: function(data) {
                if (data.success) {
                    $('#bulkAssignmentModal').modal('hide');
                    showToast(data.message, 'success');
                    setTimeout(() => location.reload(), 1500);
                } else {
                    showToast(data.message, 'danger');
                }
                setButtonLoading(btn, false);
            },
            error: function(xhr) {
                showToast('An error occurred: ' + xhr.responseText, 'danger');
                setButtonLoading(btn, false);
            }
        });
    });

    // ============ MODAL CLEANUP ============
    
    // Clean up create modal
    $('#createAssignmentModal').on('hidden.bs.modal', function() {
        $('#create-assignment-form')[0].reset();
        $('#stream-group').hide();
        $('#subject-group').show();
        $('#subject').prop('required', true);
        $('#is_class_teacher').prop('checked', false);
        $(this).find('.select2bs4').select2('destroy');
    });

    // Clean up edit modal
    $('#editAssignmentModal').on('hidden.bs.modal', function() {
        $('#edit-assignment-form')[0].reset();
        $(this).find('.select2bs4').select2('destroy');
    });

    // Clean up delete modal
    $('#deleteAssignmentModal').on('hidden.bs.modal', function() {
        const deleteBtn = $('#confirm-delete-btn');
        deleteBtn.prop('disabled', false);
        deleteBtn.find('.spinner-border').hide();
        deleteBtn.html('Delete Assignment');
        assignmentToDelete = null;
    });

    // Clean up bulk modal
    $('#bulkAssignmentModal').on('hidden.bs.modal', function() {
        $('#clone-assignments-form')[0].reset();
        $(this).find('.select2bs4').select2('destroy');
    });
});
</script>
{% endblock extra_js %}