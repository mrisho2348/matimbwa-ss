{% extends 'admin/base.html' %}
{% load static %}
{% load custom_filters %}
{% block title %} Student Combination Assignment {% endblock title %}

{% block breadcrumb %}
    <button type="button" class="btn btn-info" onclick="location.reload()">
        <i class="fas fa-sync-alt"></i> Refresh
    </button>
{% endblock breadcrumb %}

{% block extra_css %}
<style>
    /* Status badges */
    .status-badge {
        padding: 4px 8px;
        border-radius: 12px;
        font-size: 12px;
        font-weight: 600;
    }
    .status-active {
        background-color: #d1fae5;
        color: #065f46;
        border: 1px solid #a7f3d0;
    }
    .status-pending {
        background-color: #fef3c7;
        color: #92400e;
        border: 1px solid #fde68a;
    }
    .status-inactive {
        background-color: #f3f4f6;
        color: #374151;
        border: 1px solid #d1d5db;
    }

    /* Combination cards */
    .combination-card {
        border: 2px solid #e5e7eb;
        border-radius: 8px;
        transition: all 0.3s ease;
        background: white;
        position: relative;
        overflow: hidden;
    }
    .combination-card:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        border-color: #3b82f6;
    }
    .combination-card.selected {
        border-color: #10b981;
        background-color: #f0fdf4;
    }
    .combination-card.disabled {
        opacity: 0.6;
        cursor: not-allowed;
    }

    /* Subject chips */
    .subject-chip {
        display: inline-block;
        padding: 2px 8px;
        border-radius: 12px;
        font-size: 11px;
        font-weight: 500;
        margin-right: 4px;
        margin-bottom: 4px;
    }
    .subject-core {
        background-color: #dbeafe;
        color: #1e40af;
        border: 1px solid #bfdbfe;
    }
    .subject-subsidiary {
        background-color: #fce7f3;
        color: #9d174d;
        border: 1px solid #fbcfe8;
    }

    /* Student info panel */
    .student-info-panel {
        background: linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%);
        border: 1px solid #e2e8f0;
        border-radius: 8px;
        padding: 20px;
        position: sticky;
        top: 20px;
    }
    .student-avatar {
        width: 80px;
        height: 80px;
        border-radius: 50%;
        object-fit: cover;
        border: 3px solid white;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
    }

    /* Statistics cards */
    .stat-card {
        border-radius: 8px;
        padding: 16px;
        margin-bottom: 16px;
    }
    .stat-card-primary {
        background-color: #eff6ff;
        border-left: 4px solid #3b82f6;
    }
    .stat-card-success {
        background-color: #f0fdf4;
        border-left: 4px solid #10b981;
    }
    .stat-card-warning {
        background-color: #fef3c7;
        border-left: 4px solid #f59e0b;
    }

    /* Action buttons */
    .action-btn {
        padding: 8px 20px;
        border-radius: 6px;
        font-weight: 600;
        transition: all 0.2s ease;
        border: none;
        cursor: pointer;
    }
    .action-btn-primary {
        background-color: #3b82f6;
        color: white;
    }
    .action-btn-primary:hover {
        background-color: #2563eb;
        transform: translateY(-1px);
    }
    .action-btn-success {
        background-color: #10b981;
        color: white;
    }
    .action-btn-success:hover {
        background-color: #059669;
        transform: translateY(-1px);
    }
    .action-btn-secondary {
        background-color: #6b7280;
        color: white;
    }
    .action-btn-secondary:hover {
        background-color: #4b5563;
    }

    /* Loading state */
    .loading-overlay {
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background-color: rgba(255, 255, 255, 0.9);
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 1000;
        border-radius: 8px;
    }
    .loading-spinner {
        width: 40px;
        height: 40px;
        border: 3px solid #f3f4f6;
        border-top: 3px solid #3b82f6;
        border-radius: 50%;
        animation: spin 1s linear infinite;
    }
    @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
    }

    /* Responsive adjustments */
    @media (max-width: 768px) {
        .student-info-panel {
            position: static;
            margin-bottom: 20px;
        }
        .combination-card {
            margin-bottom: 15px;
        }
    }
</style>
{% endblock extra_css %}

{% block content %}
<section class="content">
    <div class="container-fluid">
        <!-- Success/Error Toasts -->
        <div id="success-toast" class="alert alert-success alert-dismissible fade success-toast" style="display: none;" role="alert">
            <strong><i class="fas fa-check-circle"></i> Success!</strong> 
            <span id="success-message"></span>
            <button type="button" class="close" onclick="$('#success-toast').fadeOut()" aria-label="Close">
                <span aria-hidden="true">&times;</span>
            </button>
        </div>

        <div id="error-toast" class="alert alert-danger alert-dismissible fade error-toast" style="display: none;" role="alert">
            <strong><i class="fas fa-exclamation-circle"></i> Error!</strong> 
            <span id="error-message"></span>
            <button type="button" class="close" onclick="$('#error-toast').fadeOut()" aria-label="Close">
                <span aria-hidden="true">&times;</span>
            </button>
        </div>

        <!-- Page Header -->
        <div class="row mb-4">
            <div class="col-12">
                <div class="card bg-gradient-primary">
                    <div class="card-body py-4">
                        <div class="row align-items-center">
                            <div class="col-md-8">
                                <h2 class="text-white mb-2">
                                    <i class="fas fa-users-cog"></i> Student Combination Assignment
                                </h2>
                                <p class="text-white mb-0">
                                    Assign A-Level students to subject combinations based on their academic interests and performance.
                                </p>
                            </div>
                            <div class="col-md-4 text-right">
                                <span class="badge badge-light badge-pill px-3 py-2">
                                    <i class="fas fa-user-graduate"></i> A-Level Students Only
                                </span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Main Content -->
        <div class="row">
            <!-- Student Information Panel -->
            <div class="col-lg-4 mb-4">
                <div class="student-info-panel">
                    <div class="text-center mb-4">
                        {% if student.profile_pic %}
                            <img src="{{ student.profile_pic.url }}" alt="Student Photo" class="student-avatar mb-3">
                        {% else %}
                            <div class="student-avatar mb-3 bg-primary d-flex align-items-center justify-content-center mx-auto">
                                <span class="text-white font-weight-bold" style="font-size: 2rem;">
                                    {{ student.first_name|first }}{{ student.last_name|first }}
                                </span>
                            </div>
                        {% endif %}
                        <h4 class="font-weight-bold mb-1">{{ student.full_name }}</h4>
                        <p class="text-muted mb-2">
                            <i class="fas fa-id-card"></i> {{ student.registration_number }}
                        </p>
                        <div class="mb-3">
                            <span class="badge badge-pill bg-info text-white px-3 py-1">
                                {{ student.class_level.name }}
                            </span>
                            {% if student.stream_class %}
                            <span class="badge badge-pill bg-secondary text-white px-3 py-1">
                                Stream {{ student.stream_class.stream_letter }}
                            </span>
                            {% endif %}
                        </div>
                    </div>

                    <!-- Student Details -->
                    <div class="mb-4">
                        <h6 class="font-weight-bold text-uppercase text-muted mb-3">
                            <i class="fas fa-info-circle"></i> Student Details
                        </h6>
                        <table class="table table-sm table-borderless">
                            <tr>
                                <td width="40%"><small class="text-muted">Date of Birth:</small></td>
                                <td><strong>{{ student.date_of_birth|date:"M d, Y" }}</strong></td>
                            </tr>
                            <tr>
                                <td><small class="text-muted">Age:</small></td>
                                <td><strong>{{ student.age }} years</strong></td>
                            </tr>
                            <tr>
                                <td><small class="text-muted">Gender:</small></td>
                                <td><strong>{{ student.get_gender_display }}</strong></td>
                            </tr>
                            <tr>
                                <td><small class="text-muted">Status:</small></td>
                                <td>
                                    <span class="status-badge {% if student.status == 'active' %}status-active{% else %}status-inactive{% endif %}">
                                        {{ student.get_status_display }}
                                    </span>
                                </td>
                            </tr>
                            <tr>
                                <td><small class="text-muted">Admission Year:</small></td>
                                <td><strong>{{ student.admission_year }}</strong></td>
                            </tr>
                        </table>
                    </div>

                    <!-- Current Assignment -->
                    <div class="mb-4">
                        <h6 class="font-weight-bold text-uppercase text-muted mb-3">
                            <i class="fas fa-tasks"></i> Current Assignment
                        </h6>
                        {% if student.combination %}
                            <div class="alert alert-success">
                                <div class="d-flex align-items-center">
                                    <div class="flex-grow-1">
                                        <h6 class="mb-1">
                                            <i class="fas fa-check-circle text-success"></i> 
                                            {{ student.combination.code }}
                                        </h6>
                                        <p class="mb-0 text-muted">{{ student.combination.name }}</p>
                                        <small class="text-muted">Assigned on {{ student.updated_at|date:"M d, Y" }}</small>
                                    </div>
                                    <div>
                                        <button class="btn btn-sm btn-outline-danger" onclick="showRemoveConfirmation()">
                                            <i class="fas fa-times"></i>
                                        </button>
                                    </div>
                                </div>
                            </div>
                        {% else %}
                            <div class="alert alert-warning">
                                <div class="d-flex align-items-center">
                                    <i class="fas fa-exclamation-triangle text-warning mr-2"></i>
                                    <span>No combination assigned</span>
                                </div>
                            </div>
                        {% endif %}
                    </div>

                    <!-- Action Buttons -->
                    <div class="mt-4">
                        <button class="btn btn-block action-btn action-btn-primary mb-2" id="assign-btn" disabled>
                            <i class="fas fa-check"></i> Assign Selected Combination
                        </button>
                        <button class="btn btn-block action-btn action-btn-secondary" onclick="window.history.back()">
                            <i class="fas fa-arrow-left"></i> Back to Students List
                        </button>
                    </div>
                </div>
            </div>

            <!-- Available Combinations -->
            <div class="col-lg-8">
                <div class="row">
                    <div class="col-12 mb-4">
                        <div class="card">
                            <div class="card-header bg-light">
                                <h5 class="card-title mb-0">
                                    <i class="fas fa-layer-group"></i> Available A-Level Combinations
                                </h5>
                            </div>
                            <div class="card-body">
                                <!-- Search and Filter -->
                                <div class="row mb-4">
                                    <div class="col-md-6">
                                        <div class="input-group">
                                            <div class="input-group-prepend">
                                                <span class="input-group-text"><i class="fas fa-search"></i></span>
                                            </div>
                                            <input type="text" class="form-control" id="search-input" placeholder="Search combinations...">
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="form-group">
                                            <select class="form-control" id="status-filter">
                                                <option value="all">All Status</option>
                                                <option value="active">Active Only</option>
                                                <option value="inactive">Inactive Only</option>
                                            </select>
                                        </div>
                                    </div>
                                </div>

                                <!-- Combination Statistics -->
                                <div class="row mb-4">
                                    <div class="col-md-4">
                                        <div class="stat-card stat-card-primary">
                                            <div class="d-flex align-items-center">
                                                <div>
                                                    <h4 class="font-weight-bold mb-0">{{ active_combinations_count }}</h4>
                                                    <small class="text-muted">Active Combinations</small>
                                                </div>
                                                <div class="ml-auto">
                                                    <i class="fas fa-check-circle fa-2x text-primary"></i>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="col-md-4">
                                        <div class="stat-card stat-card-success">
                                            <div class="d-flex align-items-center">
                                                <div>
                                                    <h4 class="font-weight-bold mb-0">{{ total_combinations_count }}</h4>
                                                    <small class="text-muted">Total Combinations</small>
                                                </div>
                                                <div class="ml-auto">
                                                    <i class="fas fa-list fa-2x text-success"></i>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="col-md-4">
                                        <div class="stat-card stat-card-warning">
                                            <div class="d-flex align-items-center">
                                                <div>
                                                    <h4 class="font-weight-bold mb-0">{{ students_in_same_class }}</h4>
                                                    <small class="text-muted">Students in Same Class</small>
                                                </div>
                                                <div class="ml-auto">
                                                    <i class="fas fa-user-friends fa-2x text-warning"></i>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <!-- Loading State -->
                                <div id="loading-overlay" class="loading-overlay" style="display: none;">
                                    <div class="loading-spinner"></div>
                                </div>

                                <!-- Combinations Grid -->
                                <div class="row" id="combinations-container">
                                    {% for combination in combinations %}
                                    <div class="col-md-6 mb-3 combination-item" 
                                         data-name="{{ combination.name|lower }}"
                                         data-code="{{ combination.code|lower }}"
                                         data-status="{{ combination.is_active|yesno:'active,inactive' }}">
                                        <div class="combination-card {% if not combination.is_active %}disabled{% endif %}"
                                             data-combination-id="{{ combination.id }}">
                                            <div class="card-body">
                                                <!-- Combination Header -->
                                                <div class="d-flex justify-content-between align-items-start mb-3">
                                                    <div>
                                                        <h5 class="font-weight-bold mb-1">
                                                            <i class="fas fa-cube"></i> {{ combination.code }}
                                                        </h5>
                                                        <p class="text-muted mb-0" style="font-size: 0.9rem;">
                                                            {{ combination.name }}
                                                        </p>
                                                    </div>
                                                    <div class="text-right">
                                                        <span class="badge {% if combination.is_active %}badge-success{% else %}badge-secondary{% endif %}">
                                                            {% if combination.is_active %}
                                                            <i class="fas fa-toggle-on"></i> Active
                                                            {% else %}
                                                            <i class="fas fa-toggle-off"></i> Inactive
                                                            {% endif %}
                                                        </span>
                                                        <div class="mt-1">
                                                            <small class="text-muted">
                                                                <i class="fas fa-users"></i> {{ combination.students.count }} students
                                                            </small>
                                                        </div>
                                                    </div>
                                                </div>

                                                <!-- Subjects List -->
                                                <div class="mb-3">
                                                    <small class="text-uppercase text-muted d-block mb-2">
                                                        <i class="fas fa-book"></i> Subjects
                                                    </small>
                                                    {% with subjects=combination_subjects_data|get_item:combination.id %}
                                                        {% if subjects %}
                                                            {% for subject in subjects.core %}
                                                                <span class="subject-chip subject-core">
                                                                    <i class="fas fa-star"></i> {{ subject }}
                                                                </span>
                                                            {% endfor %}
                                                            {% for subject in subjects.subsidiary %}
                                                                <span class="subject-chip subject-subsidiary">
                                                                    <i class="fas fa-circle"></i> {{ subject }}
                                                                </span>
                                                            {% endfor %}
                                                        {% else %}
                                                            <span class="text-muted">No subjects assigned</span>
                                                        {% endif %}
                                                    {% endwith %}
                                                </div>

                                                <!-- Action Button -->
                                                <div class="text-center">
                                                    {% if not combination.is_active %}
                                                        <button class="btn btn-sm btn-outline-secondary" disabled>
                                                            <i class="fas fa-ban"></i> Inactive
                                                        </button>
                                                    {% elif student.combination and student.combination.id == combination.id %}
                                                        <button class="btn btn-sm btn-success" disabled>
                                                            <i class="fas fa-check"></i> Currently Assigned
                                                        </button>
                                                    {% else %}
                                                        <button class="btn btn-sm btn-outline-primary select-btn" 
                                                                data-combination-id="{{ combination.id }}">
                                                            <i class="fas fa-hand-pointer"></i> Select
                                                        </button>
                                                    {% endif %}
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    {% empty %}
                                    <div class="col-12">
                                        <div class="alert alert-info text-center">
                                            <i class="fas fa-info-circle fa-2x mb-3"></i>
                                            <h5>No Combinations Available</h5>
                                            <p class="mb-0">There are no A-Level combinations configured yet.</p>
                                            <a href="{% url 'admin_combinations_list' %}" class="btn btn-primary mt-3">
                                                <i class="fas fa-plus"></i> Create Combinations
                                            </a>
                                        </div>
                                    </div>
                                    {% endfor %}
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</section>

<!-- Confirmation Modal -->
<div class="modal fade" id="confirmationModal" tabindex="-1" role="dialog" aria-labelledby="confirmationModalLabel" aria-hidden="true">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header bg-primary text-white">
                <h5 class="modal-title" id="confirmationModalLabel">
                    <i class="fas fa-check-circle"></i> Confirm Assignment
                </h5>
                <button type="button" class="close text-white" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <p>Are you sure you want to assign <strong id="student-name">{{ student.full_name }}</strong> to combination <strong id="combination-code"></strong>?</p>
                <div class="alert alert-info">
                    <i class="fas fa-info-circle"></i> This action will replace any existing combination assignment for this student.
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" id="confirm-assign-btn">
                    <i class="fas fa-check"></i> Yes, Assign
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Remove Assignment Modal -->
<div class="modal fade" id="removeAssignmentModal" tabindex="-1" role="dialog" aria-labelledby="removeAssignmentModalLabel" aria-hidden="true">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header bg-danger text-white">
                <h5 class="modal-title" id="removeAssignmentModalLabel">
                    <i class="fas fa-exclamation-triangle"></i> Remove Assignment
                </h5>
                <button type="button" class="close text-white" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <p>Are you sure you want to remove the combination assignment from <strong>{{ student.full_name }}</strong>?</p>
                <div class="alert alert-warning">
                    <i class="fas fa-exclamation-triangle"></i> This student will no longer be assigned to any subject combination.
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-danger" id="confirm-remove-btn">
                    <i class="fas fa-trash"></i> Remove Assignment
                </button>
            </div>
        </div>
    </div>
</div>
  <input type="hidden" id="csrf-token" value="{{ csrf_token }}">
{% endblock content %}

{% block extra_js %}
<script>
    $(document).ready(function() {
        // Global variables
        let selectedCombinationId = null;
        let selectedCombinationCode = null;
        let isAssigning = false;

        // Initialize
        initializePage();

        // Initialize page functions
        function initializePage() {
            setupEventListeners();
            updateAssignButton();
            
            // If student already has a combination, show it as selected
            {% if student.combination %}
                const currentCombinationId = {{ student.combination.id }};
                $(`.combination-card[data-combination-id="${currentCombinationId}"]`).addClass('selected');
            {% endif %}
        }

        // Setup event listeners
        function setupEventListeners() {
            // Combination selection
            $(document).on('click', '.select-btn:not(:disabled)', function(e) {
                e.stopPropagation();
                const combinationCard = $(this).closest('.combination-card');
                const combinationId = combinationCard.data('combination-id');
                
                // Deselect all cards
                $('.combination-card').removeClass('selected');
                
                // Select this card
                combinationCard.addClass('selected');
                
                // Update global variables
                selectedCombinationId = combinationId;
                selectedCombinationCode = combinationCard.find('h5').text().trim();
                
                // Update assign button
                updateAssignButton();
            });

            // Combination card click
            $(document).on('click', '.combination-card:not(.disabled)', function() {
                if ($(this).hasClass('selected')) {
                    $(this).removeClass('selected');
                    selectedCombinationId = null;
                    selectedCombinationCode = null;
                } else {
                    $('.combination-card').removeClass('selected');
                    $(this).addClass('selected');
                    selectedCombinationId = $(this).data('combination-id');
                    selectedCombinationCode = $(this).find('h5').text().trim();
                }
                updateAssignButton();
            });

            // Search functionality
            $('#search-input').on('input', function() {
                filterCombinations();
            });

            // Status filter
            $('#status-filter').on('change', function() {
                filterCombinations();
            });

            // Assign button click
            $('#assign-btn').on('click', function() {
                if (selectedCombinationId && !isAssigning) {
                    showConfirmationModal();
                }
            });

            // Confirm assignment
            $('#confirm-assign-btn').on('click', function() {
                assignCombination();
            });

            // Confirm remove assignment
            $('#confirm-remove-btn').on('click', function() {
                removeCombination();
            });
        }

        // Filter combinations based on search and status
        function filterCombinations() {
            const searchTerm = $('#search-input').val().toLowerCase();
            const statusFilter = $('#status-filter').val();
            
            $('.combination-item').each(function() {
                const name = $(this).data('name');
                const code = $(this).data('code');
                const status = $(this).data('status');
                
                let show = true;
                
                // Apply search filter
                if (searchTerm) {
                    if (!name.includes(searchTerm) && !code.includes(searchTerm)) {
                        show = false;
                    }
                }
                
                // Apply status filter
                if (statusFilter !== 'all' && status !== statusFilter) {
                    show = false;
                }
                
                // Show/hide element
                $(this).toggle(show);
            });
        }

        // Update assign button state
        function updateAssignButton() {
            const assignBtn = $('#assign-btn');
            
            if (selectedCombinationId) {
                assignBtn.prop('disabled', false);
                assignBtn.html('<i class="fas fa-check"></i> Assign to ' + selectedCombinationCode);
                
                {% if student.combination %}
                    if (selectedCombinationId == {{ student.combination.id }}) {
                        assignBtn.html('<i class="fas fa-check"></i> Already Assigned');
                        assignBtn.prop('disabled', true);
                    }
                {% endif %}
            } else {
                assignBtn.prop('disabled', true);
                assignBtn.html('<i class="fas fa-check"></i> Assign Selected Combination');
            }
        }

        // Show confirmation modal
        function showConfirmationModal() {
            $('#combination-code').text(selectedCombinationCode);
            $('#confirmationModal').modal('show');
        }

        // Show remove confirmation modal
        function showRemoveConfirmation() {
            $('#removeAssignmentModal').modal('show');
        }

        // Assign combination to student
        function assignCombination() {
            if (isAssigning) return;
            
            isAssigning = true;
            showLoading(true);
            
            $.ajax({
                url: '{% url "admin_assign_student_combination_ajax" student.id %}',
                method: 'POST',
                headers: {
                    'X-CSRFToken': getCSRFToken(),
                    'X-Requested-With': 'XMLHttpRequest'
                },
                data: {
                    'action': 'assign',
                    'combination_id': selectedCombinationId,
                    'csrfmiddlewaretoken': getCSRFToken()
                },
                success: function(data) {
                    if (data.success) {
                        $('#confirmationModal').modal('hide');
                        showToast(data.message, 'success');
                        
                        // Reload page after delay
                        setTimeout(function() {
                            location.reload();
                        }, 1500);
                    } else {
                        showToast(data.message, 'danger');
                        $('#confirmationModal').modal('hide');
                    }
                },
                error: function(xhr, status, error) {
                    console.error('Error:', error);
                    showToast('An error occurred while assigning combination. Please try again.', 'danger');
                    $('#confirmationModal').modal('hide');
                },
                complete: function() {
                    isAssigning = false;
                    showLoading(false);
                }
            });
        }

        // Remove combination assignment
        function removeCombination() {
            if (isAssigning) return;
            
            isAssigning = true;
            showLoading(true);
            
            $.ajax({
                url: '{% url "admin_assign_student_combination" student.id %}',
                method: 'POST',
                headers: {
                    'X-CSRFToken': getCSRFToken(),
                    'X-Requested-With': 'XMLHttpRequest'
                },
                data: {
                    'action': 'remove',
                    'csrfmiddlewaretoken': getCSRFToken()
                },
                success: function(data) {
                    if (data.success) {
                        $('#removeAssignmentModal').modal('hide');
                        showToast(data.message, 'success');
                        
                        // Reload page after delay
                        setTimeout(function() {
                            location.reload();
                        }, 1500);
                    } else {
                        showToast(data.message, 'danger');
                        $('#removeAssignmentModal').modal('hide');
                    }
                },
                error: function(xhr, status, error) {
                    console.error('Error:', error);
                    showToast('An error occurred while removing assignment. Please try again.', 'danger');
                    $('#removeAssignmentModal').modal('hide');
                },
                complete: function() {
                    isAssigning = false;
                    showLoading(false);
                }
            });
        }

        // Get CSRF token
        function getCSRFToken() {
            return document.getElementById('csrf-token').value;
        }

        // Show toast message
        function showToast(message, type = 'success') {
            const toastId = type === 'success' ? '#success-toast' : '#error-toast';
            const messageId = type === 'success' ? '#success-message' : '#error-message';
            
            $(messageId).text(message);
            $(toastId).addClass('show').fadeIn();
            
            setTimeout(function() {
                $(toastId).fadeOut(function() {
                    $(this).removeClass('show');
                });
            }, type === 'success' ? 3000 : 5000);
        }

        // Show/hide loading overlay
        function showLoading(show) {
            if (show) {
                $('#loading-overlay').show();
            } else {
                $('#loading-overlay').hide();
            }
        }

        // Keyboard shortcuts
        $(document).on('keydown', function(e) {
            // Escape key - clear selection
            if (e.key === 'Escape') {
                $('.combination-card').removeClass('selected');
                selectedCombinationId = null;
                selectedCombinationCode = null;
                updateAssignButton();
            }
            
            // Enter key - confirm assignment if modal is open
            if (e.key === 'Enter' && $('#confirmationModal').hasClass('show')) {
                $('#confirm-assign-btn').click();
            }
        });
    });
</script>
{% endblock extra_js %}