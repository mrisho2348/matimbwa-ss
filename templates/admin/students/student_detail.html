{% extends 'admin/base.html' %}
{% load custom_filters %}
{% load static %}
{% block title %} Student Details - {{ student.full_name }} {% endblock title %}

{% block breadcrumb %}
    <nav aria-label="breadcrumb" class="mb-4">
        <ol class="breadcrumb bg-white rounded-3 shadow-sm p-3">
            <li class="breadcrumb-item"><a href="{% url 'admin_dashboard' %}" class="text-decoration-none">
                <i class="fas fa-home me-1"></i> Dashboard
            </a></li>
            <li class="breadcrumb-item"><a href="{% url 'admin_students_list' %}" class="text-decoration-none">
                <i class="fas fa-users me-1"></i> Students
            </a></li>
            <li class="breadcrumb-item active text-primary fw-semibold" aria-current="page">
                <i class="fas fa-user-graduate me-1"></i> {{ student.full_name|truncatechars:20 }}
            </li>
        </ol>
    </nav>
{% endblock breadcrumb %}

{% block extra_css %}
<style>
    :root {
        --primary-gradient: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        --success-gradient: linear-gradient(135deg, #43e97b 0%, #38f9d7 100%);
        --warning-gradient: linear-gradient(135deg, #fa709a 0%, #fee140 100%);
        --info-gradient: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
        --danger-gradient: linear-gradient(135deg, #f56565 0%, #e53e3e 100%);
    }
    
    .student-header {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        border-radius: 20px;
        padding: 30px;
        color: white;
        margin-bottom: 30px;
        box-shadow: 0 15px 35px rgba(102, 126, 234, 0.3);
        position: relative;
        overflow: hidden;
    }
    
    .student-header::before {
        content: '';
        position: absolute;
        top: -50%;
        right: -50%;
        width: 100%;
        height: 200%;
        background: radial-gradient(circle, rgba(255,255,255,0.1) 1px, transparent 1px);
        background-size: 30px 30px;
        opacity: 0.3;
        z-index: 0;
    }
    
    .student-header-content {
        position: relative;
        z-index: 1;
    }
    
    .profile-section {
        background: white;
        border-radius: 20px;
        padding: 0;
        overflow: hidden;
        box-shadow: 0 10px 30px rgba(0,0,0,0.1);
        margin-bottom: 30px;
    }
    
    .profile-header {
        background: linear-gradient(135deg, #f6f8ff 0%, #f9f5ff 100%);
        padding: 25px;
        border-bottom: 2px solid #e8eaf6;
    }
    
    .profile-image-container {
        position: relative;
        margin: 0 auto;
        width: 200px;
        height: 200px;
    }
    
    .profile-image {
        width: 200px;
        height: 200px;
        border-radius: 50%;
        object-fit: cover;
        border: 6px solid white;
        box-shadow: 0 10px 30px rgba(0,0,0,0.15);
        transition: all 0.3s ease;
    }
    
    .profile-image:hover {
        transform: scale(1.05);
        box-shadow: 0 15px 40px rgba(0,0,0,0.2);
    }
    
    .profile-placeholder {
        width: 200px;
        height: 200px;
        border-radius: 50%;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        display: flex;
        align-items: center;
        justify-content: center;
        color: white;
        font-size: 4.5rem;
        border: 6px solid white;
        box-shadow: 0 10px 30px rgba(0,0,0,0.15);
    }
    
    .status-badge {
        position: absolute;
        bottom: 15px;
        right: 15px;
        padding: 8px 15px;
        border-radius: 20px;
        font-weight: 600;
        font-size: 0.85rem;
        box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        z-index: 2;
    }
    
    .status-active {
        background: linear-gradient(135deg, #43e97b 0%, #38f9d7 100%);
        color: white;
    }
    
    .status-inactive {
        background: linear-gradient(135deg, #f56565 0%, #e53e3e 100%);
        color: white;
    }
    
    .status-completed {
        background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
        color: white;
    }
    
    .info-card {
        background: white;
        border-radius: 16px;
        padding: 25px;
        margin-bottom: 25px;
        box-shadow: 0 8px 25px rgba(0,0,0,0.08);
        border: 1px solid rgba(0,0,0,0.05);
        transition: transform 0.3s ease;
    }
    
    .info-card:hover {
        transform: translateY(-5px);
        box-shadow: 0 15px 35px rgba(0,0,0,0.12);
    }
    
    .info-card-header {
        display: flex;
        align-items: center;
        margin-bottom: 20px;
        padding-bottom: 15px;
        border-bottom: 2px solid #f1f3f9;
    }
    
    .info-card-icon {
        width: 50px;
        height: 50px;
        border-radius: 12px;
        display: flex;
        align-items: center;
        justify-content: center;
        margin-right: 15px;
        font-size: 1.5rem;
        color: white;
    }
    
    .info-card-title {
        font-size: 1.2rem;
        font-weight: 700;
        color: #2c3e50;
        margin: 0;
    }
    
    .info-item {
        margin-bottom: 15px;
        padding-bottom: 15px;
        border-bottom: 1px dashed #e8eaf6;
    }
    
    .info-item:last-child {
        margin-bottom: 0;
        padding-bottom: 0;
        border-bottom: none;
    }
    
    .info-label {
        font-weight: 600;
        color: #4a5568;
        font-size: 0.95rem;
        margin-bottom: 5px;
        display: flex;
        align-items: center;
    }
    
    .info-label i {
        margin-right: 10px;
        width: 20px;
        color: #667eea;
    }
    
    .info-value {
        color: #2d3748;
        font-size: 1rem;
        padding-left: 30px;
    }
    
    .info-value-empty {
        color: #a0aec0;
        font-style: italic;
        padding-left: 30px;
    }
    
    .subjects-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
        gap: 15px;
        margin-top: 15px;
    }
    
    .subject-badge {
        background: linear-gradient(135deg, #f6f8ff 0%, #f1f5ff 100%);
        border: 2px solid #e2e8f0;
        border-radius: 12px;
        padding: 12px 15px;
        display: flex;
        align-items: center;
        justify-content: space-between;
        transition: all 0.3s ease;
    }
    
    .subject-badge:hover {
        border-color: #667eea;
        transform: translateY(-2px);
        box-shadow: 0 5px 15px rgba(102, 126, 234, 0.1);
    }
    
    .subject-name {
        font-weight: 600;
        color: #4a5568;
    }
    
    .subject-compulsory {
        color: #48bb78;
        font-size: 0.8rem;
        font-weight: 600;
    }
    
    .subject-optional {
        color: #ed8936;
        font-size: 0.8rem;
        font-weight: 600;
    }
    
    .parent-card {
        background: linear-gradient(135deg, #f9fafb 0%, #f7fafc 100%);
        border-radius: 15px;
        padding: 20px;
        border: 2px solid #e2e8f0;
        transition: all 0.3s ease;
    }
    
    .parent-card:hover {
        border-color: #667eea;
        transform: translateY(-3px);
        box-shadow: 0 10px 25px rgba(102, 126, 234, 0.1);
    }
    
    .parent-fee-responsible {
        background: linear-gradient(135deg, #e6fffa 0%, #e6fffa 100%);
        border-color: #81e6d9;
    }
    
    .action-buttons {
        position: fixed;
        bottom: 30px;
        right: 30px;
        z-index: 1000;
        display: flex;
        flex-direction: column;
        gap: 10px;
    }
    
    .floating-action-btn {
        width: 60px;
        height: 60px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        color: white;
        font-size: 1.3rem;
        box-shadow: 0 8px 25px rgba(0,0,0,0.2);
        transition: all 0.3s ease;
        border: none;
        position: relative;
    }
    
    .floating-action-btn:hover {
        transform: scale(1.1) rotate(5deg);
        box-shadow: 0 12px 35px rgba(0,0,0,0.3);
    }
    
    .floating-action-btn-primary {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    }
    
    .floating-action-btn-warning {
        background: linear-gradient(135deg, #ed8936 0%, #ed8936 100%);
    }
    
    .floating-action-btn-success {
        background: linear-gradient(135deg, #48bb78 0%, #38a169 100%);
    }
    
    .floating-action-btn-danger {
        background: linear-gradient(135deg, #f56565 0%, #e53e3e 100%);
    }
    
    .tooltip-text {
        position: absolute;
        right: 70px;
        background: rgba(0,0,0,0.8);
        color: white;
        padding: 8px 15px;
        border-radius: 8px;
        font-size: 0.85rem;
        white-space: nowrap;
        opacity: 0;
        transform: translateX(20px);
        transition: all 0.3s ease;
        pointer-events: none;
    }
    
    .floating-action-btn:hover .tooltip-text {
        opacity: 1;
        transform: translateX(0);
    }
    
    .stat-card {
        background: white;
        border-radius: 16px;
        padding: 25px;
        margin-bottom: 25px;
        box-shadow: 0 8px 25px rgba(0,0,0,0.08);
        text-align: center;
        transition: transform 0.3s ease;
    }
    
    .stat-card:hover {
        transform: translateY(-5px);
    }
    
    .stat-icon {
        width: 70px;
        height: 70px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        margin: 0 auto 15px;
        font-size: 1.8rem;
        color: white;
    }
    
    .stat-number {
        font-size: 2.5rem;
        font-weight: 700;
        margin-bottom: 5px;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
    }
    
    .stat-label {
        color: #718096;
        font-size: 0.95rem;
        font-weight: 600;
    }
    
    .badge-pill-custom {
        padding: 8px 15px;
        border-radius: 20px;
        font-weight: 600;
        font-size: 0.85rem;
    }
    
    .badge-primary-gradient {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
    }
    
    .badge-success-gradient {
        background: linear-gradient(135deg, #43e97b 0%, #38f9d7 100%);
        color: white;
    }
    
    .badge-warning-gradient {
        background: linear-gradient(135deg, #fa709a 0%, #fee140 100%);
        color: white;
    }
    
    .tab-content {
        background: white;
        border-radius: 0 0 20px 20px;
        padding: 30px;
        box-shadow: 0 10px 30px rgba(0,0,0,0.08);
    }
    
    .nav-tabs-custom {
        border-bottom: 3px solid #e8eaf6;
        margin-bottom: 0;
    }
    
    .nav-tabs-custom .nav-link {
        border: none;
        border-bottom: 3px solid transparent;
        color: #718096;
        font-weight: 600;
        padding: 15px 25px;
        margin-bottom: -3px;
        transition: all 0.3s ease;
    }
    
    .nav-tabs-custom .nav-link:hover {
        color: #667eea;
        border-color: transparent;
    }
    
    .nav-tabs-custom .nav-link.active {
        color: #667eea;
        border-bottom: 3px solid #667eea;
        background: transparent;
    }
    
    .timeline {
        position: relative;
        padding-left: 30px;
        margin: 20px 0;
    }
    
    .timeline::before {
        content: '';
        position: absolute;
        left: 10px;
        top: 0;
        bottom: 0;
        width: 2px;
        background: #e2e8f0;
    }
    
    .timeline-item {
        position: relative;
        margin-bottom: 25px;
    }
    
    .timeline-item::before {
        content: '';
        position: absolute;
        left: -20px;
        top: 5px;
        width: 12px;
        height: 12px;
        border-radius: 50%;
        background: #667eea;
        border: 2px solid white;
        box-shadow: 0 0 0 3px #667eea;
    }
    
    .timeline-date {
        color: #718096;
        font-size: 0.85rem;
        margin-bottom: 5px;
    }
    
    .timeline-content {
        background: #f7fafc;
        border-radius: 10px;
        padding: 15px;
        border-left: 3px solid #667eea;
    }
    
    .empty-state {
        text-align: center;
        padding: 50px 20px;
        color: #a0aec0;
    }
    
    .empty-state-icon {
        font-size: 4rem;
        margin-bottom: 20px;
        opacity: 0.5;
    }
    
    .remove-subject-btn {
        background: #fee;
        color: #dc3545;
        border: 1px solid #fcc;
        padding: 4px 8px;
        border-radius: 4px;
        font-size: 0.8rem;
        cursor: pointer;
        transition: all 0.3s ease;
    }
    
    .remove-subject-btn:hover {
        background: #fdd;
        color: #c82333;
    }
    
    .add-subject-btn {
        background: #e7f5ff;
        color: #007bff;
        border: 2px dashed #90caf9;
        padding: 12px 15px;
        border-radius: 12px;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: all 0.3s ease;
        cursor: pointer;
        text-decoration: none !important;
    }
    
    .add-subject-btn:hover {
        background: #d1ecff;
        border-color: #007bff;
        transform: translateY(-2px);
    }
    
    @media (max-width: 768px) {
        .subjects-grid {
            grid-template-columns: 1fr;
        }
        
        .floating-action-btn {
            width: 50px;
            height: 50px;
            font-size: 1.1rem;
        }
        
        .action-buttons {
            bottom: 20px;
            right: 20px;
        }
        
        .student-header {
            padding: 20px;
        }
    }
</style>
{% endblock extra_css %}

{% block content %}
<section class="content">
    <div class="container-fluid">
        <!-- Loading Overlay -->
        <div class="loading-overlay" id="loadingOverlay" style="display: none;">
            <div class="spinner"></div>
            <p class="text-primary fw-bold">Loading...</p>
        </div>

        <!-- Student Header -->
        <div class="student-header">
            <div class="student-header-content">
                <div class="row align-items-center">
                    <div class="col-lg-8">
                        <h1 class="display-6 fw-bold mb-3">{{ student.full_name }}</h1>
                        <div class="d-flex flex-wrap align-items-center gap-3 mb-3">
                            <span class="badge-pill-custom badge-primary-gradient">
                                <i class="fas fa-id-card me-2"></i>{{ student.registration_number }}
                            </span>
                            {% if student.examination_number %}
                            <span class="badge-pill-custom badge-success-gradient">
                                <i class="fas fa-file-alt me-2"></i>{{ student.examination_number }}
                            </span>
                            {% endif %}
                            <span class="badge-pill-custom {% if student.is_active %}badge-success-gradient{% else %}badge-danger-gradient{% endif %}">
                                <i class="fas fa-circle me-2"></i>{{ student.get_status_display }}
                            </span>
                        </div>
                        <p class="mb-0 opacity-90">
                            <i class="fas fa-graduation-cap me-2"></i>
                            {% if student.class_level %}
                                {{ student.class_level.name }}
                                {% if student.stream_class %}
                                    {{ student.stream_class.stream_letter }}
                                {% endif %}
                            {% else %}
                                No class assigned
                            {% endif %}
                            •
                            {% if student.age %}
                                {{ student.age }} years old
                            {% else %}
                                Age not specified
                            {% endif %}
                        </p>
                    </div>
                    <div class="col-lg-4 text-lg-end mt-4 mt-lg-0">
                        <div class="d-flex flex-column gap-2">
                            <div class="d-flex justify-content-lg-end gap-2 flex-wrap">
                                <a href="{% url 'admin_student_edit' student.id %}" class="btn btn-light btn-sm">
                                    <i class="fas fa-edit me-1"></i> Edit Profile
                                </a>
                            </div>
                            <small class="text-white opacity-75">
                                <i class="fas fa-calendar-alt me-1"></i>
                                Created: {{ student.created_at|date:"M d, Y" }}
                                • Updated: {{ student.updated_at|date:"M d, Y" }}
                            </small>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Main Content -->
        <div class="row">
            <!-- Left Column: Profile & Quick Stats -->
            <div class="col-lg-4">
                <!-- Profile Card -->
                <div class="profile-section">
                    <div class="profile-header text-center">
                        <div class="profile-image-container">
                            {% if student.profile_pic %}
                                <img src="{{ student.profile_pic.url }}" class="profile-image" alt="Profile Picture">
                            {% else %}
                                <div class="profile-placeholder">
                                    <i class="fas fa-user"></i>
                                </div>
                            {% endif %}
                            <div class="status-badge {% if student.status == 'active' %}status-active{% elif student.status == 'completed' %}status-completed{% else %}status-inactive{% endif %}">
                                {{ student.get_status_display }}
                            </div>
                        </div>
                        <h3 class="mt-4 mb-2">{{ student.full_name }}</h3>
                        <p class="text-muted mb-0">
                            {{ student.registration_number }}
                            {% if student.class_level %}
                                • {{ student.class_level.name }}
                            {% endif %}
                        </p>
                    </div>
                    <div class="p-4">
                        <div class="info-item">
                            <div class="info-label"><i class="fas fa-birthday-cake"></i> Date of Birth</div>
                            <div class="info-value">
                                {% if student.date_of_birth %}
                                    {{ student.date_of_birth|date:"F d, Y" }}
                                    ({{ student.age }} years)
                                {% else %}
                                    <span class="info-value-empty">Not specified</span>
                                {% endif %}
                            </div>
                        </div>
                        <div class="info-item">
                            <div class="info-label"><i class="fas fa-venus-mars"></i> Gender</div>
                            <div class="info-value">{{ student.get_gender_display|default:"Not specified" }}</div>
                        </div>
                        <div class="info-item">
                            <div class="info-label"><i class="fas fa-home"></i> Address</div>
                            <div class="info-value">
                                {% if student.address %}
                                    {{ student.address }}
                                {% else %}
                                    <span class="info-value-empty">Not specified</span>
                                {% endif %}
                            </div>
                        </div>
                        {% if student.physical_disabilities_condition %}
                        <div class="info-item">
                            <div class="info-label"><i class="fas fa-wheelchair"></i> Special Condition</div>
                            <div class="info-value">{{ student.physical_disabilities_condition }}</div>
                        </div>
                        {% endif %}
                    </div>
                </div>

                <!-- Quick Stats -->
                <div class="info-card">
                    <div class="info-card-header">
                        <div class="info-card-icon" style="background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);">
                            <i class="fas fa-chart-bar"></i>
                        </div>
                        <h4 class="info-card-title">Quick Stats</h4>
                    </div>
                    <div class="row">
                        <div class="col-6 mb-3">
                            <div class="stat-card">
                                <div class="stat-icon" style="background: linear-gradient(135deg, #43e97b 0%, #38f9d7 100%);">
                                    <i class="fas fa-book"></i>
                                </div>
                                <div class="stat-number">
                                    {% if student_subjects %}
                                        {{ student_subjects|length }}
                                    {% else %}
                                        0
                                    {% endif %}
                                </div>
                                <div class="stat-label">Subjects</div>
                            </div>
                        </div>
                        <div class="col-6 mb-3">
                            <div class="stat-card">
                                <div class="stat-icon" style="background: linear-gradient(135deg, #fa709a 0%, #fee140 100%);">
                                    <i class="fas fa-user-friends"></i>
                                </div>
                                <div class="stat-number">
                                    {% if student.parents.all %}
                                        {{ student.parents.all|length }}
                                    {% else %}
                                        0
                                    {% endif %}
                                </div>
                                <div class="stat-label">Parents</div>
                            </div>
                        </div>
                    </div>
                    <div class="info-item">
                        <div class="info-label"><i class="fas fa-calendar-plus"></i> Admission Year</div>
                        <div class="info-value">{{ student.admission_year|default:"Not specified" }}</div>
                    </div>
                    <div class="info-item">
                        <div class="info-label"><i class="fas fa-hashtag"></i> Serial Number</div>
                        <div class="info-value">{{ student.serial_number|default:"Not assigned" }}</div>
                    </div>
                </div>

                <!-- Contact Information -->
                <div class="info-card">
                    <div class="info-card-header">
                        <div class="info-card-icon" style="background: linear-gradient(135deg, #43e97b 0%, #38f9d7 100%);">
                            <i class="fas fa-phone-alt"></i>
                        </div>
                        <h4 class="info-card-title">Contact Information</h4>
                    </div>
                    <div class="info-item">
                        <div class="info-label"><i class="fas fa-phone"></i> Primary Contact</div>
                        <div class="info-value">
                            {% if student.parents.first %}
                                {{ student.parents.first.first_phone_number|default:"Not available" }}
                            {% else %}
                                <span class="info-value-empty">Not available</span>
                            {% endif %}
                        </div>
                    </div>
                    <div class="info-item">
                        <div class="info-label"><i class="fas fa-phone-alt"></i> Emergency Contact</div>
                        <div class="info-value">
                            {% if student.parents.first %}
                                {{ student.parents.first.second_phone_number|default:"Not available" }}
                            {% else %}
                                <span class="info-value-empty">Not available</span>
                            {% endif %}
                        </div>
                    </div>
                    {% if student.parents.all %}
                        <div class="mt-3">
                            <a href="{% url 'admin_add_parent_to_student' student.id %}" class="btn btn-sm btn-primary w-100">
                                <i class="fas fa-user-friends me-1"></i> View/Manage Parents
                            </a>
                        </div>
                    {% endif %}
                </div>
            </div>

            <!-- Right Column: Detailed Information -->
            <div class="col-lg-8">
                <!-- Navigation Tabs -->
                <ul class="nav nav-tabs nav-tabs-custom mb-4" id="studentTabs" role="tablist">
                    <li class="nav-item" role="presentation">
                        <button class="nav-link active" id="academic-tab" data-bs-toggle="tab" data-bs-target="#academic" type="button" role="tab" aria-controls="academic" aria-selected="true">
                            <i class="fas fa-graduation-cap me-2"></i> Academic Info
                        </button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="subjects-tab" data-bs-toggle="tab" data-bs-target="#subjects" type="button" role="tab" aria-controls="subjects" aria-selected="false">
                            <i class="fas fa-book me-2"></i> Subjects
                        </button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="parents-tab" data-bs-toggle="tab" data-bs-target="#parents" type="button" role="tab" aria-controls="parents" aria-selected="false">
                            <i class="fas fa-users me-2"></i> Parents/Guardians
                        </button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="history-tab" data-bs-toggle="tab" data-bs-target="#history" type="button" role="tab" aria-controls="history" aria-selected="false">
                            <i class="fas fa-history me-2"></i> History
                        </button>
                    </li>
                </ul>

                <div class="tab-content" id="studentTabsContent">
                    <!-- Academic Information Tab -->
                    <div class="tab-pane fade show active" id="academic" role="tabpanel" aria-labelledby="academic-tab">
                        <div class="row">
                            <div class="col-md-6">
                                <div class="info-card">
                                    <div class="info-card-header">
                                        <div class="info-card-icon" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);">
                                            <i class="fas fa-school"></i>
                                        </div>
                                        <h4 class="info-card-title">Current Academic Details</h4>
                                    </div>
                                    <div class="info-item">
                                        <div class="info-label"><i class="fas fa-layer-group"></i> Class Level</div>
                                        <div class="info-value">
                                            {% if student.class_level %}
                                                {{ student.class_level.name }} ({{ student.class_level.code }})
                                            {% else %}
                                                <span class="info-value-empty">Not assigned</span>
                                            {% endif %}
                                        </div>
                                    </div>
                                    <div class="info-item">
                                        <div class="info-label"><i class="fas fa-stream"></i> Stream/Class</div>
                                        <div class="info-value">
                                            {% if student.stream_class %}
                                                {{ student.stream_class }}
                                                {% if student.stream_class.capacity %}
                                                    <small class="text-muted ms-2">
                                                        ({{ student.stream_class.student_count }}/{{ student.stream_class.capacity }})
                                                    </small>
                                                {% endif %}
                                            {% else %}
                                                <span class="info-value-empty">Not assigned</span>
                                            {% endif %}
                                        </div>
                                    </div>
                                    <div class="info-item">
                                        <div class="info-label"><i class="fas fa-user-tie"></i> Class Teacher</div>
                                        <div class="info-value">
                                            {% if student.stream_class.class_teacher %}
                                                {{ student.stream_class.class_teacher.get_full_name }}
                                            {% else %}
                                                <span class="info-value-empty">Not assigned</span>
                                            {% endif %}
                                        </div>
                                    </div>
                                    <div class="info-item">
                                        <div class="info-label"><i class="fas fa-calendar-day"></i> Academic Year</div>
                                        <div class="info-value">
                                            {% if current_academic_year %}
                                                {{ current_academic_year.name }}
                                            {% else %}
                                                <span class="info-value-empty">Not set</span>
                                            {% endif %}
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="info-card">
                                    <div class="info-card-header">
                                        <div class="info-card-icon" style="background: linear-gradient(135deg, #ed8936 0%, #ed8936 100%);">
                                            <i class="fas fa-university"></i>
                                        </div>
                                        <h4 class="info-card-title">Previous School Information</h4>
                                    </div>
                                    <div class="info-item">
                                        <div class="info-label"><i class="fas fa-school"></i> Previous School</div>
                                        <div class="info-value">
                                            {% if student.previous_school %}
                                                {{ student.previous_school.name }}
                                            {% else %}
                                                <span class="info-value-empty">Not specified</span>
                                            {% endif %}
                                        </div>
                                    </div>
                                    <div class="info-item">
                                        <div class="info-label"><i class="fas fa-graduation-cap"></i> Previous Class</div>
                                        <div class="info-value">
                                            {% if student.previous_class_level %}
                                                {{ student.previous_class_level.name }}
                                            {% else %}
                                                <span class="info-value-empty">Not specified</span>
                                            {% endif %}
                                        </div>
                                    </div>
                                    <div class="info-item">
                                        <div class="info-label"><i class="fas fa-exchange-alt"></i> Transfer From</div>
                                        <div class="info-value">
                                            {% if student.transfer_from_school %}
                                                {{ student.transfer_from_school.name }}
                                            {% else %}
                                                <span class="info-value-empty">Not specified</span>
                                            {% endif %}
                                        </div>
                                    </div>
                                    <div class="info-item">
                                        <div class="info-label"><i class="fas fa-file-alt"></i> Previous Exam No.</div>
                                        <div class="info-value">
                                            {% if student.previously_examination_number %}
                                                {{ student.previously_examination_number }}
                                            {% else %}
                                                <span class="info-value-empty">Not specified</span>
                                            {% endif %}
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Examination Information -->
                        <div class="info-card">
                            <div class="info-card-header">
                                <div class="info-card-icon" style="background: linear-gradient(135deg, #48bb78 0%, #38a169 100%);">
                                    <i class="fas fa-file-certificate"></i>
                                </div>
                                <h4 class="info-card-title">Examination Information</h4>
                            </div>
                            <div class="row">
                                <div class="col-md-6">
                                    <div class="info-item">
                                        <div class="info-label"><i class="fas fa-file-alt"></i> Current Exam Number</div>
                                        <div class="info-value">
                                            {% if student.examination_number %}
                                                {{ student.examination_number }}
                                            {% else %}
                                                <span class="info-value-empty">Not assigned</span>
                                            {% endif %}
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="info-item">
                                        <div class="info-label"><i class="fas fa-calendar-check"></i> Last Exam Date</div>
                                        <div class="info-value">
                                            {% if last_exam_date %}
                                                {{ last_exam_date|date:"F d, Y" }}
                                            {% else %}
                                                <span class="info-value-empty">No exams taken</span>
                                            {% endif %}
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Subjects Tab -->
                    <div class="tab-pane fade" id="subjects" role="tabpanel" aria-labelledby="subjects-tab">
                        <div class="info-card">
                            <div class="info-card-header">
                                <div class="info-card-icon" style="background: linear-gradient(135deg, #f56565 0%, #e53e3e 100%);">
                                    <i class="fas fa-book-open"></i>
                                </div>
                                <h4 class="info-card-title">Enrolled Subjects</h4>
                                <div class="ms-auto">
                                    <span class="badge-pill-custom badge-primary-gradient">
                                        {% if student_subjects %}
                                            {{ student_subjects|length }} Subjects
                                        {% else %}
                                            No Subjects
                                        {% endif %}
                                    </span>
                                </div>
                            </div>
                            
                            {% if student_subjects %}
                                <div class="subjects-grid">
                                    {% for subject in student_subjects %}
                                        <div class="subject-badge">
                                            <div class="subject-name">{{ subject.name }}</div>
                                            <div class="subject-{% if subject.is_compulsory %}compulsory{% else %}optional{% endif %}">
                                                {% if subject.is_compulsory %}
                                                    <i class="fas fa-star me-1"></i>Compulsory
                                                {% else %}
                                                    <i class="fas fa-plus-circle me-1"></i>Optional
                                                    <button class="remove-subject-btn ms-2" data-subject-id="{{ subject.id }}" data-subject-name="{{ subject.name }}">
                                                        <i class="fas fa-times"></i> Remove
                                                    </button>
                                                {% endif %}
                                            </div>
                                        </div>
                                    {% endfor %}
                                    <!-- Add Subject Button -->
                                    <a href="#" class="add-subject-btn" data-toggle="modal" data-target="#addSubjectModal">
                                        <i class="fas fa-plus-circle me-2"></i> Add Optional Subject
                                    </a>
                                </div>
                                
                                <!-- Subject Summary -->
                                <div class="row mt-4 pt-3 border-top">
                                    <div class="col-md-6">
                                        <div class="info-item">
                                            <div class="info-label"><i class="fas fa-star"></i> Compulsory Subjects</div>
                                            <div class="info-value">
                                                {{ compulsory_count }} subjects
                                            </div>
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="info-item">
                                            <div class="info-label"><i class="fas fa-plus-circle"></i> Optional Subjects</div>
                                            <div class="info-value">
                                                {{ optional_count }} subjects
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            {% else %}
                                <div class="empty-state">
                                    <div class="empty-state-icon">
                                        <i class="fas fa-book"></i>
                                    </div>
                                    <h5 class="mb-3">No Subjects Enrolled</h5>
                                    <p class="text-muted mb-4">This student hasn't been enrolled in any subjects yet.</p>
                                    <a href="{% url 'admin_student_edit' student.id %}" class="btn btn-primary me-2">
                                        <i class="fas fa-edit me-2"></i> Edit Subjects
                                    </a>
                                    <a href="#" class="btn btn-success" data-toggle="modal" data-target="#addSubjectModal">
                                        <i class="fas fa-plus-circle me-2"></i> Add Subject
                                    </a>
                                </div>
                            {% endif %}
                        </div>
                    </div>

                    <!-- Parents/Guardians Tab -->
                    <div class="tab-pane fade" id="parents" role="tabpanel" aria-labelledby="parents-tab">
                        <div class="info-card">
                            <div class="info-card-header">
                                <div class="info-card-icon" style="background: linear-gradient(135deg, #9f7aea 0%, #805ad5 100%);">
                                    <i class="fas fa-users"></i>
                                </div>
                                <h4 class="info-card-title">Parents & Guardians</h4>
                                <div class="ms-auto">
                                    <a href="{% url 'admin_add_parent_to_student' student.id %}" class="btn btn-sm btn-primary">
                                        <i class="fas fa-user-plus me-1"></i> Add Parent
                                    </a>
                                </div>
                            </div>
                            
                            {% if student.parents.all %}
                                <div class="row">
                                    {% for parent in student.parents.all %}
                                        <div class="col-md-6 mb-4">
                                            <div class="parent-card {% if parent.is_fee_responsible %}parent-fee-responsible{% endif %}">
                                                <div class="d-flex justify-content-between align-items-start mb-3">
                                                    <h5 class="mb-0">{{ parent.full_name }}</h5>
                                                    {% if parent.is_fee_responsible %}
                                                        <span class="badge-pill-custom badge-success-gradient">
                                                            <i class="fas fa-money-check-alt me-1"></i>Fee Responsible
                                                        </span>
                                                    {% endif %}
                                                </div>
                                                <div class="info-item mb-2">
                                                    <div class="info-label"><i class="fas fa-user-tag"></i> Relationship</div>
                                                    <div class="info-value">{{ parent.relationship }}</div>
                                                </div>
                                                <div class="info-item mb-2">
                                                    <div class="info-label"><i class="fas fa-phone"></i> Primary Phone</div>
                                                    <div class="info-value">{{ parent.first_phone_number }}</div>
                                                </div>
                                                {% if parent.second_phone_number %}
                                                <div class="info-item mb-2">
                                                    <div class="info-label"><i class="fas fa-phone-alt"></i> Secondary Phone</div>
                                                    <div class="info-value">{{ parent.second_phone_number }}</div>
                                                </div>
                                                {% endif %}
                                                {% if parent.email %}
                                                <div class="info-item mb-2">
                                                    <div class="info-label"><i class="fas fa-envelope"></i> Email</div>
                                                    <div class="info-value">{{ parent.email }}</div>
                                                </div>
                                                {% endif %}
                                                <div class="info-item mb-3">
                                                    <div class="info-label"><i class="fas fa-home"></i> Address</div>
                                                    <div class="info-value">{{ parent.address }}</div>
                                                </div>
                                                <div class="d-flex gap-2">
                                                    <a href="{% url 'admin_edit_parent' student.id parent.id %}" class="btn btn-sm btn-outline-primary flex-fill">
                                                        <i class="fas fa-edit me-1"></i> Edit
                                                    </a>
                                                    <button class="btn btn-sm btn-outline-danger flex-fill remove-parent-btn" data-parent-id="{{ parent.id }}" data-parent-name="{{ parent.full_name }}">
                                                        <i class="fas fa-trash me-1"></i> Remove
                                                    </button>
                                                </div>
                                            </div>
                                        </div>
                                    {% endfor %}
                                </div>
                            {% else %}
                                <div class="empty-state">
                                    <div class="empty-state-icon">
                                        <i class="fas fa-user-friends"></i>
                                    </div>
                                    <h5 class="mb-3">No Parents/Guardians Added</h5>
                                    <p class="text-muted mb-4">This student doesn't have any parents or guardians registered yet.</p>
                                    <a href="{% url 'admin_add_parent_to_student' student.id %}" class="btn btn-primary">
                                        <i class="fas fa-user-plus me-2"></i> Add Parent/Guardian
                                    </a>
                                </div>
                            {% endif %}
                        </div>
                    </div>

                    <!-- History Tab -->
                    <div class="tab-pane fade" id="history" role="tabpanel" aria-labelledby="history-tab">
                        <div class="info-card">
                            <div class="info-card-header">
                                <div class="info-card-icon" style="background: linear-gradient(135deg, #718096 0%, #4a5568 100%);">
                                    <i class="fas fa-history"></i>
                                </div>
                                <h4 class="info-card-title">Student History</h4>
                            </div>
                            
                            <div class="timeline">
                                <div class="timeline-item">
                                    <div class="timeline-date">Admission Date</div>
                                    <div class="timeline-content">
                                        <strong>Student was admitted</strong><br>
                                        Admission Year: {{ student.admission_year }}<br>
                                        Serial Number: {{ student.serial_number }}<br>
                                        Registration Number: {{ student.registration_number }}
                                    </div>
                                </div>
                                
                                {% if student.created_at %}
                                <div class="timeline-item">
                                    <div class="timeline-date">{{ student.created_at|date:"F d, Y" }}</div>
                                    <div class="timeline-content">
                                        <strong>Student record created</strong><br>
                                        Initial status: {{ student.get_status_display }}<br>
                                        Created in the system
                                    </div>
                                </div>
                                {% endif %}
                                
                                {% if student.updated_at %}
                                <div class="timeline-item">
                                    <div class="timeline-date">{{ student.updated_at|date:"F d, Y" }}</div>
                                    <div class="timeline-content">
                                        <strong>Last updated</strong><br>
                                        Profile information was last modified
                                    </div>
                                </div>
                                {% endif %}
                                
                                {% if academic_history %}
                                    {% for record in academic_history %}
                                    <div class="timeline-item">
                                        <div class="timeline-date">{{ record.date|date:"F d, Y" }}</div>
                                        <div class="timeline-content">
                                            <strong>{{ record.title }}</strong><br>
                                            {{ record.description }}
                                        </div>
                                    </div>
                                    {% endfor %}
                                {% endif %}
                                
                                {% if student.status_changes %}
                                    {% for change in student.status_changes %}
                                    <div class="timeline-item">
                                        <div class="timeline-date">{{ change.date|date:"F d, Y" }}</div>
                                        <div class="timeline-content">
                                            <strong>Status changed to: {{ change.new_status }}</strong><br>
                                            {% if change.reason %}{{ change.reason }}{% endif %}
                                        </div>
                                    </div>
                                    {% endfor %}
                                {% endif %}
                            </div>
                            
                            {% if not academic_history and not student.status_changes %}
                                <div class="empty-state">
                                    <div class="empty-state-icon">
                                        <i class="fas fa-history"></i>
                                    </div>
                                    <h5 class="mb-3">No History Available</h5>
                                    <p class="text-muted">No historical records found for this student.</p>
                                </div>
                            {% endif %}
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Floating Action Buttons -->
        <div class="action-buttons">
            <button type="button" class="floating-action-btn floating-action-btn-primary" id="editStudentBtn">
                <i class="fas fa-edit"></i>
                <span class="tooltip-text">Edit Student</span>
            </button>
            
            <button type="button" class="floating-action-btn floating-action-btn-success" id="addParentBtn">
                <i class="fas fa-user-plus"></i>
                <span class="tooltip-text">Add Parent</span>
            </button>
            
            <button type="button" class="floating-action-btn floating-action-btn-danger" id="deleteBtn" data-toggle="modal" data-target="#deleteModal">
                <i class="fas fa-trash"></i>
                <span class="tooltip-text">Delete Student</span>
            </button>
        </div>

        <!-- Add Subject Modal -->
        <div class="modal fade" id="addSubjectModal" tabindex="-1" role="dialog">
            <div class="modal-dialog modal-lg" role="document">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title">Add Optional Subjects</h5>
                        <button type="button" class="close" data-dismiss="modal">
                            <span>&times;</span>
                        </button>
                    </div>
                    <div class="modal-body">
                        <div class="alert alert-info">
                            <i class="fas fa-info-circle me-2"></i>
                            Select optional subjects to enroll this student in.
                        </div>
                        
                        <div class="row">
                            <div class="col-md-12">
                                <div class="form-group">
                                    <label for="subjectSearch">Search Subjects</label>
                                    <input type="text" class="form-control" id="subjectSearch" placeholder="Type to search subjects...">
                                </div>
                            </div>
                        </div>
                        
                        <div class="available-subjects-container">
                            <h6 class="mb-3">Available Optional Subjects</h6>
                            <div class="subjects-grid" id="availableSubjectsGrid">
                                <!-- Subjects loaded from view context -->
                                {% for subject in available_subjects %}
                                <div class="subject-badge selectable-subject" data-subject-id="{{ subject.id }}">
                                    <div class="subject-name">{{ subject.name }}</div>
                                    <div class="subject-optional">
                                        <i class="fas fa-plus-circle me-1"></i>Optional
                                    </div>
                                </div>
                                {% empty %}
                                <div class="col-12">
                                    <div class="alert alert-info">
                                        <i class="fas fa-info-circle me-2"></i>
                                        No available optional subjects found for this student's class level.
                                    </div>
                                </div>
                                {% endfor %}
                            </div>
                        </div>
                        
                        <div class="selected-subjects-container mt-4">
                            <h6 class="mb-3">Selected Subjects</h6>
                            <div class="selected-subjects-list" id="selectedSubjectsList">
                                <!-- Selected subjects will appear here -->
                            </div>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-dismiss="modal">Cancel</button>
                        <button type="button" class="btn btn-primary" id="saveSubjectsBtn" disabled>
                            <i class="fas fa-save me-2"></i>Save Changes
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Delete Confirmation Modal -->
        <div class="modal fade" id="deleteModal" tabindex="-1" role="dialog">
            <div class="modal-dialog" role="document">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title text-danger">
                            <i class="fas fa-exclamation-triangle me-2"></i>Delete Student
                        </h5>
                        <button type="button" class="close" data-dismiss="modal">
                            <span>&times;</span>
                        </button>
                    </div>
                    <div class="modal-body">
                        <div class="alert alert-danger">
                            <h6 class="alert-heading">Warning!</h6>
                            <p>You are about to delete <strong>{{ student.full_name }}</strong> permanently.</p>
                            <hr>
                            <p class="mb-0">This action cannot be undone. All associated data will be deleted.</p>
                        </div>
                        <div class="form-group">
                            <label for="confirmDeleteText" class="form-label">
                                Type "DELETE" to confirm:
                            </label>
                            <input type="text" class="form-control" id="confirmDeleteText" placeholder="DELETE">
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-dismiss="modal">Cancel</button>
                        <button type="button" class="btn btn-danger" id="confirmDeleteBtn" disabled>
                            <i class="fas fa-trash me-2"></i>Delete Student
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</section>
{% endblock content %}

{% block extra_js %}
<script>
$(document).ready(function() {
    // Debug logging
    console.log('Student detail page initializing...');
    
    // Get CSRF token from cookies (alternative method)
    function getCSRFToken() {
        let csrfToken = '';
        // Try from meta tag first
        const csrfMeta = document.querySelector('meta[name="csrf-token"]');
        if (csrfMeta) {
            csrfToken = csrfMeta.getAttribute('content');
        }
        // Try from hidden input
        if (!csrfToken) {
            const csrfInput = document.querySelector('[name=csrfmiddlewaretoken]');
            if (csrfInput) {
                csrfToken = csrfInput.value;
            }
        }
        // Try from cookies as last resort
        if (!csrfToken) {
            const cookieValue = document.cookie
                .split('; ')
                .find(row => row.startsWith('csrftoken='))
                ?.split('=')[1];
            csrfToken = cookieValue || '';
        }
        
        console.log('CSRF Token found:', csrfToken ? 'Yes' : 'No');
        return csrfToken;
    }

    // Show loading overlay
    function showLoading() {
        $('#loadingOverlay').fadeIn(300);
    }

    // Hide loading overlay
    function hideLoading() {
        $('#loadingOverlay').fadeOut(300);
    }

    // Show success message
    function showSuccess(message) {
        return Swal.fire({
            title: 'Success!',
            text: message,
            icon: 'success',
            confirmButtonColor: '#667eea',
            timer: 2000
        });
    }

    // Show error message
    function showError(message) {
        return Swal.fire({
            title: 'Error!',
            text: message,
            icon: 'error',
            confirmButtonColor: '#dc3545'
        });
    }

    // Show confirmation dialog
    function showConfirm(title, text, confirmText = 'Yes, proceed!') {
        return Swal.fire({
            title: title,
            text: text,
            icon: 'warning',
            showCancelButton: true,
            confirmButtonColor: '#dc3545',
            cancelButtonColor: '#6c757d',
            confirmButtonText: confirmText,
            cancelButtonText: 'Cancel'
        });
    }

    // Initialize tooltips
    if ($.fn.tooltip) {
        $('[data-toggle="tooltip"]').tooltip();
    }

    // ============= FLOATING ACTION BUTTONS =============
    $('#editStudentBtn').on('click', function() {
        window.location.href = "{% url 'admin_student_edit' student.id %}";
    });

    $('#addParentBtn').on('click', function() {
        window.location.href = "{% url 'admin_add_parent_to_student' student.id %}";
    });

    // ============= DELETE STUDENT FUNCTIONALITY =============
    $('#confirmDeleteText').on('input', function() {
        const confirmBtn = $('#confirmDeleteBtn');
        confirmBtn.prop('disabled', $(this).val().toUpperCase() !== 'DELETE');
    });

    $('#confirmDeleteBtn').on('click', function() {
        if ($('#confirmDeleteText').val().toUpperCase() === 'DELETE') {
            deleteStudent();
        }
    });

    async function deleteStudent() {
        const result = await showConfirm(
            'Delete Student?',
            `Are you sure you want to permanently delete "${student.full_name}"? This action cannot be undone.`,
            'Yes, delete student!'
        );
        
        if (!result.isConfirmed) return;
        
        showLoading();
        
        try {
            const response = await $.ajax({
                url: "{% url 'admin_student_delete' student.id %}",
                type: 'POST',
                data: {
                    csrfmiddlewaretoken: getCSRFToken()
                },
                dataType: 'json'
            });
            
            hideLoading();
            $('#deleteModal').modal('hide');
            
            if (response.success) {
                await showSuccess(response.message || 'Student deleted successfully.');
                window.location.href = "{% url 'admin_students_list' %}";
            } else {
                await showError(response.message || 'Failed to delete student.');
            }
        } catch (error) {
            hideLoading();
            console.error('Delete error:', error);
            await showError('An error occurred while deleting the student.');
        }
    }

    // ============= SUBJECT MANAGEMENT =============
    let selectedSubjects = [];
    
    // Remove optional subject
    $(document).on('click', '.remove-subject-btn', async function(e) {
        e.preventDefault();
        e.stopPropagation();
        
        const subjectId = $(this).data('subject-id');
        const subjectName = $(this).data('subject-name');
        
        const result = await showConfirm(
            'Remove Subject?',
            `Are you sure you want to remove "${subjectName}" from this student's subjects?`,
            'Yes, remove it!'
        );
        
        if (!result.isConfirmed) return;
        
        await removeSubject(subjectId, subjectName);
    });

    async function removeSubject(subjectId, subjectName) {
        showLoading();
        
        try {
            const response = await $.ajax({
                url: "{% url 'admin_remove_student_subject' student.id %}",
                type: 'POST',
                data: {
                    subject_id: subjectId,
                    csrfmiddlewaretoken: getCSRFToken()
                },
                dataType: 'json'
            });
            
            hideLoading();
            
            if (response.success) {
                await showSuccess(`"${subjectName}" has been removed from student's subjects.`);
                // Update the UI without full page reload
                $(`.remove-subject-btn[data-subject-id="${subjectId}"]`).closest('.subject-badge').fadeOut(300, function() {
                    $(this).remove();
                    updateSubjectsCount();
                    updateSubjectStats();
                });
            } else {
                await showError(response.message || 'Failed to remove subject.');
            }
        } catch (error) {
            hideLoading();
            console.error('Remove subject error:', error);
            await showError('An error occurred while removing the subject.');
        }
    }

    // Update subject statistics
    function updateSubjectStats() {
        const optionalCount = $('.subject-badge .subject-optional').length;
        const compulsoryCount = $('.subject-badge .subject-compulsory').length;
        
        // Update counts in the summary section
        $('.info-value').filter(function() {
            return $(this).text().includes('subjects') && $(this).prev().find('i.fa-star').length > 0;
        }).text(compulsoryCount + ' subjects');
        
        $('.info-value').filter(function() {
            return $(this).text().includes('subjects') && $(this).prev().find('i.fa-plus-circle').length > 0;
        }).text(optionalCount + ' subjects');
    }

    // ============= ADD SUBJECT MODAL FUNCTIONALITY =============
    // Open modal and initialize subjects
    $(document).on('click', '.add-subject-btn', function(e) {
        e.preventDefault();
        selectedSubjects = [];
        $('#addSubjectModal').modal('show');
        initializeSubjectModal();
    });

    // Initialize subject modal with available subjects from context
    function initializeSubjectModal() {
        // Clear previous selections
        selectedSubjects = [];
        updateSelectedSubjectsList();
        $('#saveSubjectsBtn').prop('disabled', true);
        
        // Remove any existing badges and reset search
        $('.selectable-subject .badge.bg-success').remove();
        $('.selectable-subject').removeClass('selected');
        
        // Initialize search functionality
        $('#subjectSearch').off('input').on('input', function() {
            const searchTerm = $(this).val().toLowerCase();
            $('.selectable-subject').each(function() {
                const subjectName = $(this).find('.subject-name').text().toLowerCase();
                $(this).toggle(subjectName.includes(searchTerm));
            });
        });
        
        // Focus on search input
        setTimeout(() => {
            $('#subjectSearch').focus();
        }, 500);
    }

    // Handle subject selection in modal
    $(document).on('click', '.selectable-subject', function() {
        const subjectId = $(this).data('subject-id');
        const subjectName = $(this).find('.subject-name').text();
        
        const subjectIndex = selectedSubjects.findIndex(s => s.id == subjectId);
        
        if (subjectIndex === -1) {
            // Add to selected
            selectedSubjects.push({ id: subjectId, name: subjectName });
            $(this).addClass('selected');
            $(this).find('.subject-optional').append('<span class="badge bg-success ms-2">Selected</span>');
        } else {
            // Remove from selected
            selectedSubjects.splice(subjectIndex, 1);
            $(this).removeClass('selected');
            $(this).find('.badge.bg-success').remove();
        }
        
        updateSelectedSubjectsList();
    });

    // Update selected subjects list display
    function updateSelectedSubjectsList() {
        const selectedList = $('#selectedSubjectsList');
        selectedList.empty();
        
        if (selectedSubjects.length > 0) {
            selectedSubjects.forEach(subject => {
                const subjectHtml = `
                    <div class="selected-subject-item mb-2 p-3 bg-light rounded border">
                        <div class="d-flex justify-content-between align-items-center">
                            <div>
                                <strong>${subject.name}</strong>
                            </div>
                            <button class="btn btn-sm btn-outline-danger remove-selected-subject" 
                                    data-subject-id="${subject.id}">
                                <i class="fas fa-times"></i>
                            </button>
                        </div>
                    </div>
                `;
                selectedList.append(subjectHtml);
            });
            
            // Enable save button
            $('#saveSubjectsBtn').prop('disabled', false);
        } else {
            selectedList.html(`
                <div class="text-center text-muted py-4">
                    <i class="fas fa-info-circle me-2"></i>
                    No subjects selected. Click on subjects above to select them.
                </div>
            `);
            
            // Disable save button
            $('#saveSubjectsBtn').prop('disabled', true);
        }
    }

    // Remove selected subject from list
    $(document).on('click', '.remove-selected-subject', function(e) {
        e.stopPropagation();
        
        const subjectId = $(this).data('subject-id');
        const subjectIndex = selectedSubjects.findIndex(s => s.id == subjectId);
        
        if (subjectIndex > -1) {
            selectedSubjects.splice(subjectIndex, 1);
            $(`.selectable-subject[data-subject-id="${subjectId}"]`)
                .removeClass('selected')
                .find('.badge.bg-success').remove();
            updateSelectedSubjectsList();
        }
    });

    // Save selected subjects
    $('#saveSubjectsBtn').on('click', async function() {
        if (selectedSubjects.length === 0) {
            await showError('Please select at least one subject to add.');
            return;
        }

        showLoading();
        
        const subjectIds = selectedSubjects.map(subject => subject.id);
        
        try {
            const response = await $.ajax({
                url: "{% url 'admin_add_optional_subjects' student.id %}",
                type: 'POST',
                data: {
                    subject_ids: JSON.stringify(subjectIds),
                    csrfmiddlewaretoken: getCSRFToken()
                },
                dataType: 'json'
            });
            
            hideLoading();
            
            if (response.success) {
                $('#addSubjectModal').modal('hide');
                await showSuccess(`${selectedSubjects.length} subject(s) have been added to student.`);
                // Refresh the page to show updated subjects
                setTimeout(() => {
                    location.reload();
                }, 1500);
            } else {
                await showError(response.message || 'Failed to add subjects.');
            }
        } catch (error) {
            hideLoading();
            console.error('Add subjects error:', error);
            if (error.status === 403) {
                await showError('CSRF token missing or invalid. Please refresh the page and try again.');
            } else {
                await showError('An error occurred while adding subjects.');
            }
        }
    });

    // ============= PARENT MANAGEMENT =============
    $(document).on('click', '.remove-parent-btn', async function(e) {
        e.preventDefault();
        e.stopPropagation();
        
        const parentId = $(this).data('parent-id');
        const parentName = $(this).data('parent-name');
        
        const result = await showConfirm(
            'Remove Parent?',
            `Are you sure you want to remove "${parentName}" from this student's parents/guardians?`,
            'Yes, remove them!'
        );
        
        if (!result.isConfirmed) return;
        
        await removeParent(parentId, parentName);
    });

    async function removeParent(parentId, parentName) {
        showLoading();
        
        try {
            const response = await $.ajax({
                url: "{% url 'admin_remove_parent_from_student' student.id %}",
                type: 'POST',
                data: {
                    parent_id: parentId,
                    csrfmiddlewaretoken: getCSRFToken()
                },
                dataType: 'json'
            });
            
            hideLoading();
            
            if (response.success) {
                await showSuccess(response.message || 'Parent has been removed from student.');
                // Remove parent card from UI
                $(`.remove-parent-btn[data-parent-id="${parentId}"]`).closest('.col-md-6').fadeOut(300, function() {
                    $(this).remove();
                    updateParentsCount();
                    
                    // If no parents left, show empty state
                    if ($('.parent-card').length === 0) {
                        showEmptyParentsState();
                    }
                });
            } else {
                await showError(response.message || 'Failed to remove parent.');
            }
        } catch (error) {
            hideLoading();
            console.error('Remove parent error:', error);
            if (error.status === 403) {
                await showError('CSRF token missing or invalid. Please refresh the page and try again.');
            } else {
                await showError('An error occurred while removing the parent.');
            }
        }
    }

    // Show empty parents state
    function showEmptyParentsState() {
        const parentsTabContent = $('#parents .info-card .row');
        parentsTabContent.html(`
            <div class="col-12">
                <div class="empty-state">
                    <div class="empty-state-icon">
                        <i class="fas fa-user-friends"></i>
                    </div>
                    <h5 class="mb-3">No Parents/Guardians Added</h5>
                    <p class="text-muted mb-4">This student doesn't have any parents or guardians registered yet.</p>
                    <a href="{% url 'admin_add_parent_to_student' student.id %}" class="btn btn-primary">
                        <i class="fas fa-user-plus me-2"></i> Add Parent/Guardian
                    </a>
                </div>
            </div>
        `);
    }

    // Update parents count
    function updateParentsCount() {
        const parentCount = $('.parent-card').length;
        $('.stat-number').filter(function() {
            return $(this).next('.stat-label').text() === 'Parents';
        }).text(parentCount);
    }

    // ============= TAB FUNCTIONALITY =============
    $('#studentTabs button').on('click', function(e) {
        e.preventDefault();
        $(this).tab('show');
    });

    // ============= INITIAL SETUP =============
    // Update subjects count on page load
    function updateSubjectsCount() {
        const subjectCount = $('#subjects .subject-badge:not(.add-subject-btn)').length;
        $('#subjects .badge-pill-custom').text(subjectCount + ' Subject' + (subjectCount !== 1 ? 's' : ''));
    }

    // Initialize on page load
    updateSubjectsCount();
    updateSubjectStats();
    
    // Initialize modal events
    $('#addSubjectModal').on('shown.bs.modal', function() {
        $('#subjectSearch').focus();
    }).on('hidden.bs.modal', function() {
        selectedSubjects = [];
        $('#subjectSearch').val('');
        $('#saveSubjectsBtn').prop('disabled', true);
    });

    // Initialize delete modal
    $('#deleteModal').on('shown.bs.modal', function() {
        $('#confirmDeleteText').focus();
    }).on('hidden.bs.modal', function() {
        $('#confirmDeleteText').val('');
        $('#confirmDeleteBtn').prop('disabled', true);
    });

    // Test CSRF token
    console.log('CSRF Token:', getCSRFToken() ? 'Available' : 'Missing');
    
    // Add CSRF token to all AJAX requests
    $.ajaxSetup({
        beforeSend: function(xhr, settings) {
            if (!/^(GET|HEAD|OPTIONS|TRACE)$/i.test(settings.type) && !this.crossDomain) {
                xhr.setRequestHeader("X-CSRFToken", getCSRFToken());
            }
        }
    });

    // Error handling for AJAX
    $(document).ajaxError(function(event, jqxhr, settings, thrownError) {
        console.error('AJAX Error:', {
            status: jqxhr.status,
            statusText: jqxhr.statusText,
            responseText: jqxhr.responseText,
            url: settings.url,
            type: settings.type
        });
        
        if (jqxhr.status === 403) {
            showError('Session expired or CSRF token invalid. Please refresh the page and try again.');
        } else if (jqxhr.status === 404) {
            showError('The requested resource was not found. URL: ' + settings.url);
        } else if (jqxhr.status >= 500) {
            showError('Server error occurred. Please try again later.');
        } else if (jqxhr.status === 0) {
            showError('Network error. Please check your internet connection.');
        }
    });

    console.log('Student detail page initialized successfully.');
});
</script>
{% endblock extra_js %}