{% extends 'admin/base.html' %}
{% load static %}

{% block title %}Students by Class - School Management System{% endblock %}

{% block extra_css %}


<style>
    :root {
        --primary-gradient: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        --success-gradient: linear-gradient(135deg, #43e97b 0%, #38f9d7 100%);
        --warning-gradient: linear-gradient(135deg, #fa709a 0%, #fee140 100%);
        --info-gradient: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
        --danger-gradient: linear-gradient(135deg, #f56565 0%, #e53e3e 100%);
    }
    
    .dashboard-header {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        border-radius: 20px;
        padding: 30px;
        color: white;
        margin-bottom: 30px;
        box-shadow: 0 15px 35px rgba(102, 126, 234, 0.3);
        position: relative;
        overflow: hidden;
    }
    
    .dashboard-header::before {
        content: '';
        position: absolute;
        top: -50%;
        right: -50%;
        width: 100%;
        height: 200%;
        background: radial-gradient(circle, rgba(255,255,255,0.1) 1px, transparent 1px);
        background-size: 30px 30px;
        opacity: 0.3;
        z-index: 0;
    }
    
    .dashboard-header-content {
        position: relative;
        z-index: 1;
    }
    
    .filter-section {
        background: white;
        border-radius: 16px;
        padding: 25px;
        margin-bottom: 30px;
        box-shadow: 0 8px 25px rgba(0,0,0,0.08);
        border: 1px solid rgba(0,0,0,0.05);
    }
    
    .filter-row {
        display: flex;
        flex-wrap: wrap;
        gap: 15px;
        align-items: flex-end;
    }
    
    .filter-group {
        flex: 1 1 200px;
        min-width: 180px;
    }
    
    .filter-label {
        font-weight: 600;
        color: #4a5568;
        margin-bottom: 8px;
        font-size: 0.9rem;
        display: flex;
        align-items: center;
    }
    
    .filter-label i {
        margin-right: 8px;
        color: #667eea;
        font-size: 0.9rem;
    }
    
    /* Select2 Customization */
    .select2-container--bootstrap-5 .select2-selection {
        min-height: 45px;
        padding: 0.375rem 0.75rem;
        border: 2px solid #e2e8f0 !important;
        border-radius: 10px !important;
        background: #f8fafc;
    }
    
    .select2-container--bootstrap-5 .select2-selection--single .select2-selection__rendered {
        line-height: 45px;
        padding-left: 0;
        color: #4a5568;
    }
    
    .select2-container--bootstrap-5 .select2-selection--single .select2-selection__arrow {
        height: 45px;
    }
    
    .select2-container--bootstrap-5 .select2-dropdown {
        border: 2px solid #e2e8f0;
        border-radius: 10px;
        box-shadow: 0 10px 30px rgba(0,0,0,0.1);
    }
    
    .filter-actions {
        display: flex;
        gap: 10px;
        align-items: center;
        margin-left: auto;
    }
    
    .btn-filter {
        padding: 12px 25px;
        border-radius: 10px;
        font-weight: 600;
        font-size: 0.95rem;
        display: inline-flex;
        align-items: center;
        transition: all 0.3s ease;
        border: none;
        cursor: pointer;
    }
    
    .btn-filter i {
        margin-right: 8px;
    }
    
    .btn-apply {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
    }
    
    .btn-apply:hover {
        transform: translateY(-2px);
        box-shadow: 0 10px 25px rgba(102, 126, 234, 0.3);
    }
    
    .btn-reset {
        background: #f1f5f9;
        color: #4a5568;
    }
    
    .btn-reset:hover {
        background: #e2e8f0;
    }
    
    .stats-summary {
        display: flex;
        flex-wrap: wrap;
        gap: 20px;
        margin-bottom: 25px;
    }
    
    .stat-item {
        background: white;
        border-radius: 12px;
        padding: 15px 25px;
        box-shadow: 0 4px 15px rgba(0,0,0,0.05);
        border: 1px solid #e2e8f0;
        display: flex;
        align-items: center;
        gap: 15px;
        flex: 1 1 auto;
        min-width: 160px;
        cursor: pointer;
        transition: all 0.3s ease;
    }
    
    .stat-item:hover {
        transform: translateY(-2px);
        box-shadow: 0 8px 25px rgba(0,0,0,0.1);
    }
    
    .stat-icon-sm {
        width: 50px;
        height: 50px;
        border-radius: 12px;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        display: flex;
        align-items: center;
        justify-content: center;
        color: white;
        font-size: 1.5rem;
    }
    
    .stat-info h4 {
        font-size: 1.8rem;
        font-weight: 700;
        margin: 0;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
    }
    
    .stat-info p {
        margin: 0;
        color: #718096;
        font-weight: 500;
        font-size: 0.9rem;
    }
    
    .table-container {
        background: white;
        border-radius: 16px;
        overflow: hidden;
        box-shadow: 0 8px 25px rgba(0,0,0,0.08);
        margin-bottom: 30px;
    }
    
    .table-header {
        background: linear-gradient(135deg, #f6f8ff 0%, #f9f5ff 100%);
        padding: 20px 25px;
        border-bottom: 2px solid #e8eaf6;
        display: flex;
        justify-content: space-between;
        align-items: center;
    }
    
    .export-buttons {
        display: flex;
        gap: 10px;
    }
    
    .btn-export {
        padding: 10px 20px;
        border-radius: 10px;
        font-weight: 600;
        font-size: 0.9rem;
        display: inline-flex;
        align-items: center;
        transition: all 0.3s ease;
        border: none;
        cursor: pointer;
        color: white;
    }
    
    .btn-export i {
        margin-right: 8px;
    }
    
    .btn-export-excel {
        background: linear-gradient(135deg, #48bb78 0%, #38a169 100%);
    }
    
    .btn-export-pdf {
        background: linear-gradient(135deg, #f56565 0%, #e53e3e 100%);
    }
    
    .btn-export:hover {
        transform: translateY(-2px);
        box-shadow: 0 5px 15px rgba(0,0,0,0.2);
    }
    
    /* DataTables Customization */
    .dataTables_wrapper .dataTables_length,
    .dataTables_wrapper .dataTables_filter {
        margin-bottom: 15px;
    }
    
    .dataTables_wrapper .dataTables_length select {
        border: 2px solid #e2e8f0;
        border-radius: 10px;
        padding: 5px 10px;
        background: #f8fafc;
    }
    
    .dataTables_wrapper .dataTables_filter input {
        border: 2px solid #e2e8f0;
        border-radius: 10px;
        padding: 7px 15px;
        background: #f8fafc;
    }
    
    .dataTables_wrapper .dataTables_filter input:focus {
        border-color: #667eea;
        outline: none;
        box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
    }
    
    .dataTables_wrapper .dataTables_paginate .paginate_button {
        border-radius: 10px;
        margin: 0 3px;
    }
    
    .dataTables_wrapper .dataTables_paginate .paginate_button.current {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        border-color: transparent;
        color: white !important;
    }
    
    .dataTables_wrapper .dataTables_paginate .paginate_button:hover {
        background: linear-gradient(135deg, #f6f8ff 0%, #f9f5ff 100%);
        border-color: #667eea;
    }
    
    .dataTables_info {
        color: #718096;
        font-size: 0.9rem;
        padding-top: 10px !important;
    }
    
    table.dataTable {
        margin-top: 0 !important;
        margin-bottom: 0 !important;
    }
    
    table.dataTable thead th {
        background: #f8fafc;
        color: #4a5568;
        font-weight: 600;
        font-size: 0.9rem;
        padding: 15px 20px;
        border-bottom: 2px solid #e2e8f0;
    }
    
    table.dataTable tbody td {
        padding: 15px 20px;
        vertical-align: middle;
    }
    
    .student-avatar {
        width: 45px;
        height: 45px;
        border-radius: 50%;
        object-fit: cover;
        border: 3px solid white;
        box-shadow: 0 4px 15px rgba(0,0,0,0.1);
    }
    
    .student-avatar-placeholder {
        width: 45px;
        height: 45px;
        border-radius: 50%;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        display: flex;
        align-items: center;
        justify-content: center;
        color: white;
        font-weight: 600;
        font-size: 1.2rem;
        border: 3px solid white;
        box-shadow: 0 4px 15px rgba(0,0,0,0.1);
    }
    
    .badge-status {
        padding: 6px 12px;
        border-radius: 20px;
        font-size: 0.8rem;
        font-weight: 600;
        display: inline-flex;
        align-items: center;
        color: white;
    }
    
    .badge-status i {
        margin-right: 5px;
        font-size: 0.6rem;
    }
    
    .badge-active {
        background: linear-gradient(135deg, #43e97b 0%, #38f9d7 100%);
    }
    
    .badge-suspended {
        background: linear-gradient(135deg, #fa709a 0%, #fee140 100%);
    }
    
    .badge-withdrawn {
        background: linear-gradient(135deg, #f56565 0%, #e53e3e 100%);
    }
    
    .badge-completed {
        background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
    }
    
    .badge-transferred {
        background: linear-gradient(135deg, #a0aec0 0%, #718096 100%);
    }
    
    .action-buttons {
        display: flex;
        gap: 8px;
        justify-content: center;
    }
    
    .action-btn {
        width: 36px;
        height: 36px;
        border-radius: 10px;
        display: flex;
        align-items: center;
        justify-content: center;
        color: white;
        font-size: 0.9rem;
        transition: all 0.3s ease;
        border: none;
        text-decoration: none;
    }
    
    .action-btn:hover {
        transform: translateY(-2px);
        box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        text-decoration: none;
        color: white;
    }
    
    .btn-view {
        background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
    }
    
    .btn-edit {
        background: linear-gradient(135deg, #fa709a 0%, #fee140 100%);
    }
    
    .btn-parents {
        background: linear-gradient(135deg, #9f7aea 0%, #805ad5 100%);
    }
    
    .loading-overlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(255,255,255,0.9);
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        z-index: 9999;
        display: none;
    }
    
    .spinner {
        width: 60px;
        height: 60px;
        border: 5px solid #f3f3f3;
        border-top: 5px solid #667eea;
        border-radius: 50%;
        animation: spin 1s linear infinite;
        margin-bottom: 20px;
    }
    
    @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
    }
    
    .empty-state {
        text-align: center;
        padding: 60px 20px;
        color: #a0aec0;
    }
    
    .empty-state-icon {
        font-size: 4rem;
        margin-bottom: 20px;
        opacity: 0.5;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
    }
    
    /* Custom filter badges */
    .active-filters {
        display: flex;
        flex-wrap: wrap;
        gap: 10px;
        margin-top: 15px;
        padding-top: 15px;
        border-top: 1px solid #e2e8f0;
    }
    
    .filter-badge {
        background: #f1f5f9;
        border-radius: 20px;
        padding: 5px 15px;
        font-size: 0.85rem;
        display: inline-flex;
        align-items: center;
        gap: 8px;
    }
    
    .filter-badge .badge-label {
        font-weight: 600;
        color: #4a5568;
    }
    
    .filter-badge .badge-value {
        color: #667eea;
        font-weight: 500;
    }
    
    .filter-badge .remove-filter {
        cursor: pointer;
        color: #f56565;
        margin-left: 5px;
    }
    
    .filter-badge .remove-filter:hover {
        color: #e53e3e;
    }
    
    @media (max-width: 768px) {
        .filter-row {
            flex-direction: column;
            gap: 15px;
        }
        
        .filter-group {
            width: 100%;
        }
        
        .filter-actions {
            width: 100%;
            margin-left: 0;
        }
        
        .table-header {
            flex-direction: column;
            gap: 15px;
            text-align: center;
        }
        
        .stats-summary {
            flex-direction: column;
        }
        
        .stat-item {
            width: 100%;
        }
        
        .action-buttons {
            justify-content: flex-start;
        }
    }
</style>
{% endblock extra_css %}

{% block content %}
<section class="content">
    <div class="container-fluid">
        <!-- Loading Overlay -->
        <div class="loading-overlay" id="loadingOverlay">
            <div class="spinner"></div>
            <p class="text-primary fw-bold mt-3" id="loadingText">Loading data...</p>
        </div>
        
        <!-- Dashboard Header -->
        <div class="dashboard-header">
            <div class="dashboard-header-content">
                <div class="row align-items-center">
                    <div class="col-lg-8">
                        <h1 class="display-6 fw-bold mb-3">
                            <i class="fas fa-users me-3"></i>Students by Class
                        </h1>
                        <p class="mb-0 opacity-90">
                            Filter and manage students by class, stream, and academic year
                        </p>
                    </div>
                    <div class="col-lg-4 text-lg-end">
                        <a href="{% url 'admin_students_add' %}" class="btn btn-light">
                            <i class="fas fa-user-plus me-2"></i>Add New Student
                        </a>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Statistics Summary - Dynamic -->
        <div class="stats-summary" id="statisticsContainer">
            <div class="stat-item" onclick="filterByStat('all')">
                <div class="stat-icon-sm">
                    <i class="fas fa-user-graduate"></i>
                </div>
                <div class="stat-info">
                    <h4 id="totalStudents">0</h4>
                    <p>Total Students</p>
                </div>
            </div>
            <div class="stat-item" onclick="filterByStat('active')">
                <div class="stat-icon-sm" style="background: linear-gradient(135deg, #43e97b 0%, #38f9d7 100%);">
                    <i class="fas fa-check-circle"></i>
                </div>
                <div class="stat-info">
                    <h4 id="activeStudents">0</h4>
                    <p>Active Students</p>
                </div>
            </div>
            <div class="stat-item" onclick="filterByStat('male')">
                <div class="stat-icon-sm" style="background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);">
                    <i class="fas fa-male"></i>
                </div>
                <div class="stat-info">
                    <h4 id="maleStudents">0</h4>
                    <p>Male</p>
                </div>
            </div>
            <div class="stat-item" onclick="filterByStat('female')">
                <div class="stat-icon-sm" style="background: linear-gradient(135deg, #fa709a 0%, #fee140 100%);">
                    <i class="fas fa-female"></i>
                </div>
                <div class="stat-info">
                    <h4 id="femaleStudents">0</h4>
                    <p>Female</p>
                </div>
            </div>
        </div>
        
        <!-- Filter Section -->
        <div class="filter-section">
            <div class="filter-row">
                <!-- Class Level Filter -->
                <div class="filter-group">
                    <label class="filter-label">
                        <i class="fas fa-layer-group"></i> Class Level
                    </label>
                    <select class="form-select select2-filter" id="classLevelFilter">
                        <option value="">All Classes</option>
                        {% for class_level in class_levels %}
                        <option value="{{ class_level.id }}">
                            {{ class_level.name }} ({{ class_level.student_count }} students)
                        </option>
                        {% endfor %}
                    </select>
                </div>
                
                <!-- Stream Filter - Will be populated dynamically -->
                <div class="filter-group">
                    <label class="filter-label">
                        <i class="fas fa-stream"></i> Stream
                    </label>
                    <select class="form-select select2-filter" id="streamFilter">
                        <option value="">All Streams</option>
                        <!-- Streams will be loaded via AJAX -->
                    </select>
                </div>
                
                <!-- Academic Year Filter -->
                <div class="filter-group">
                    <label class="filter-label">
                        <i class="fas fa-calendar-alt"></i> Academic Year
                    </label>
                    <select class="form-select select2-filter" id="academicYearFilter">
                        <option value="">All Years</option>
                        {% for year in academic_years %}
                        <option value="{{ year.id }}">
                            {{ year.name }} {% if year.is_active %}(Active){% endif %}
                        </option>
                        {% endfor %}
                    </select>
                </div>
                
                <!-- Status Filter -->
                <div class="filter-group">
                    <label class="filter-label">
                        <i class="fas fa-tag"></i> Status
                    </label>
                    <select class="form-select select2-filter" id="statusFilter">
                        <option value="">All Status</option>
                        {% for status_code, status_name in status_choices %}
                        <option value="{{ status_code }}">
                            {{ status_name }}
                        </option>
                        {% endfor %}
                    </select>
                </div>
                
                <!-- Gender Filter -->
                <div class="filter-group">
                    <label class="filter-label">
                        <i class="fas fa-venus-mars"></i> Gender
                    </label>
                    <select class="form-select select2-filter" id="genderFilter">
                        <option value="">All Genders</option>
                        {% for gender_code, gender_name in gender_choices %}
                        <option value="{{ gender_code }}">
                            {{ gender_name }}
                        </option>
                        {% endfor %}
                    </select>
                </div>
                
                <!-- Filter Actions -->
                <div class="filter-actions">
                    <button type="button" class="btn-filter btn-apply" onclick="applyFilters()">
                        <i class="fas fa-filter"></i> Apply Filters
                    </button>
                    <button type="button" class="btn-filter btn-reset" onclick="resetFilters()">
                        <i class="fas fa-redo"></i> Reset
                    </button>
                </div>
            </div>
        </div>
        
        <!-- Active Filters Display -->
        <div class="active-filters" id="activeFiltersContainer" style="display: none;"></div>
        
        <!-- Students Table -->
        <div class="table-container">
            <div class="table-header">
                <h5 class="mb-0">
                    <i class="fas fa-user-graduate me-2"></i>
                    Students List
                </h5>
                
                <div class="export-buttons">
                    <button class="btn-export btn-export-excel" onclick="exportToExcel()">
                        <i class="fas fa-file-excel"></i> Excel
                    </button>
                    <button class="btn-export btn-export-pdf" onclick="exportToPDF()">
                        <i class="fas fa-file-pdf"></i> PDF
                    </button>
                </div>
            </div>
            
            <div class="table-responsive">
                <table class="data-table" id="studentsTable" style="width: 100%;">
                    <thead>
                        <tr>
                            <th width="60">#</th>
                            <th>Student Information</th>
                            <th>Class & Stream</th>
                            <th>Academic Year</th>
                            <th>Contact</th>
                            <th>Status</th>
                            <th width="120">Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        <!-- Data will be loaded via AJAX -->
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</section>
{% endblock %}

{% block extra_js %}
<!-- Select2 JS -->


<script>
// Global variables
let dataTable;
let activeFilters = {};

$(document).ready(function() {
    // Initialize tooltips
    $('[data-toggle="tooltip"]').tooltip();
    
    // Initialize Select2
    $('.select2-filter').select2({
        theme: 'bootstrap-5',
        width: '100%',
        placeholder: 'Select option',
        allowClear: true
    });
    
    // Initialize DataTable with server-side processing
    dataTable = $('#studentsTable').DataTable({
        processing: true,
        serverSide: true,
        ajax: {
            url: '{% url "students_api" %}',
            type: 'GET',
            data: function(d) {
                // Add custom filter parameters
                d.class_level = $('#classLevelFilter').val() || '';
                d.stream = $('#streamFilter').val() || '';
                d.academic_year = $('#academicYearFilter').val() || '';
                d.status = $('#statusFilter').val() || '';
                d.gender = $('#genderFilter').val() || '';
            },
            dataSrc: function(json) {
                // Update statistics after data load
                updateStatistics(json.recordsFiltered, json);
                return json.data;
            },
            error: function(xhr, error, thrown) {
                console.error('DataTable error:', error);
                Swal.fire({
                    icon: 'error',
                    title: 'Error',
                    text: 'Failed to load student data. Please try again.'
                });
            }
        },
        pageLength: 25,
        lengthMenu: [[10, 25, 50, 100, -1], [10, 25, 50, 100, "All"]],
        order: [[0, 'asc']],
        columns: [
            { data: 0, name: '#' },
            { 
                data: 1,
                name: 'student_info',
                render: function(data) {
                    const student = JSON.parse(data);
                    return renderStudentInfo(student);
                }
            },
            { 
                data: 2,
                name: 'class_stream',
                render: function(data) {
                    const info = JSON.parse(data);
                    return renderClassInfo(info);
                }
            },
            { 
                data: 3,
                name: 'academic_year',
                render: function(data) {
                    const info = JSON.parse(data);
                    return renderAcademicYearInfo(info);
                }
            },
            { 
                data: 4,
                name: 'contact',
                render: function(data) {
                    const info = JSON.parse(data);
                    return renderContactInfo(info);
                }
            },
            { 
                data: 5,
                name: 'status',
                render: function(data) {
                    const info = JSON.parse(data);
                    return renderStatusInfo(info);
                }
            },
            { 
                data: 6,
                name: 'actions',
                render: function(data) {
                    return renderActionButtons(data);
                }
            }
        ],
        columnDefs: [
            { orderable: false, targets: [6] },
            { searchable: false, targets: [6] },
            { className: 'text-center', targets: [0, 6] }
        ],
        language: {
            search: "_INPUT_",
            searchPlaceholder: "Search students...",
            lengthMenu: "Show _MENU_ entries",
            info: "Showing _START_ to _END_ of _TOTAL_ students",
            infoEmpty: "Showing 0 to 0 of 0 students",
            infoFiltered: "(filtered from _MAX_ total entries)",
            paginate: {
                first: '<i class="fas fa-angle-double-left"></i>',
                previous: '<i class="fas fa-angle-left"></i>',
                next: '<i class="fas fa-angle-right"></i>',
                last: '<i class="fas fa-angle-double-right"></i>'
            }
        },
        dom: '<"row"<"col-sm-12 col-md-6"l><"col-sm-12 col-md-6"f>>' +
             '<"row"<"col-sm-12"tr>>' +
             '<"row"<"col-sm-12 col-md-5"i><"col-sm-12 col-md-7"p>>',
        initComplete: function() {
            // Load initial statistics
            loadStatistics();
            
            // Load initial streams (all streams)
            loadStreams('');
        }
    });
    
    // Stream filter dependency on class level
    $('#classLevelFilter').on('change', function() {
        const classId = $(this).val();
        loadStreams(classId);
    });
    
    // Auto-apply filters when select2 changes
    $('.select2-filter').on('change', function() {
        updateActiveFilters();
        dataTable.ajax.reload();
    });
});

// Load streams based on selected class
function loadStreams(classId) {
    showLoading('Loading streams...');
    
    const streamSelect = $('#streamFilter');
    const currentValue = streamSelect.val();
    
    // Clear current options except the first one
    streamSelect.find('option:not(:first)').remove();
    
    let url = '{% url "admin_get_streams_by_class" %}';
    if (classId) {
        url += '?class_id=' + classId;
    } else {
        // If no class selected, load all streams
        url += '?class_id=';
    }
    
    $.ajax({
        url: url,
        method: 'GET',
        success: function(response) {
            // Handle different possible response structures
            let streams = [];
            
            if (response.success) {
                // Check for streams array (your current format)
                if (response.streams && Array.isArray(response.streams)) {
                    streams = response.streams;
                }
                // Check for data array (previous format)
                else if (response.data && Array.isArray(response.data)) {
                    streams = response.data;
                }
                // Check if response itself is an array
                else if (Array.isArray(response)) {
                    streams = response;
                }
            }
            
            if (streams.length > 0) {
                // Add new options
                streams.forEach(function(stream) {
                    // Handle different stream object structures
                    const streamId = stream.id;
                    const streamText = stream.text || 
                                      (stream.stream_letter ? 
                                       `${stream.class_level_name || ''}${stream.stream_letter}` : 
                                       'Unknown Stream');
                    
                    const option = new Option(streamText, streamId, false, false);
                    streamSelect.append(option);
                });
                
                // Restore previous value if it still exists in new options
                if (currentValue) {
                    const optionExists = streams.some(s => s.id == currentValue);
                    if (optionExists) {
                        streamSelect.val(currentValue).trigger('change');
                    } else {
                        streamSelect.val('').trigger('change');
                    }
                }
                
                // Refresh Select2
                streamSelect.trigger('change.select2');
            } else {
                console.log('No streams found for the selected class');
            }
            hideLoading();
        },
        error: function(xhr, status, error) {
            hideLoading();
            console.error('AJAX error:', error);
            console.error('Response:', xhr.responseText);
            Swal.fire({
                icon: 'error',
                title: 'Error',
                text: 'Failed to load streams. Please try again.'
            });
        }
    });
}

// Render functions
function renderStudentInfo(student) {
    const avatar = student.profile_pic 
        ? `<img src="${student.profile_pic}" class="student-avatar me-3" alt="${student.full_name}">`
        : `<div class="student-avatar-placeholder me-3">${student.first_name.charAt(0).toUpperCase()}</div>`;
    
    return `
        <div class="d-flex align-items-center">
            ${avatar}
            <div>
                <h6 class="mb-1 fw-bold student-name">
                    ${student.full_name}
                </h6>
                <div class="text-muted small">
                    <i class="fas fa-id-card me-1"></i>
                    <span class="reg-number">${student.registration_number}</span>
                    â€¢
                    <i class="fas fa-birthday-cake ms-2 me-1"></i>
                    ${student.date_of_birth}
                </div>
            </div>
        </div>
    `;
}

function renderClassInfo(info) {
    let html = `
        <div class="fw-bold class-level">
            ${info.class_level}
        </div>
        <div class="text-muted small">
            <i class="fas fa-stream me-1"></i>
            <span class="stream-name">${info.stream}</span>
        </div>
    `;
    
    if (info.combination) {
        html += `
            <div class="text-muted small">
                <i class="fas fa-cubes me-1"></i>
                ${info.combination}
            </div>
        `;
    }
    
    return html;
}

function renderAcademicYearInfo(info) {
    let html = `
        <div class="fw-bold academic-year">${info.academic_year}</div>
    `;
    
    if (info.admission_year) {
        html += `
            <div class="text-muted small">
                <i class="fas fa-calendar-plus me-1"></i>
                Admitted: <span class="admission-year">${info.admission_year}</span>
            </div>
        `;
    }
    
    return html;
}

function renderContactInfo(info) {
    if (info.parent_name) {
        return `
            <div class="small fw-bold parent-name">${info.parent_name}</div>
            <div class="text-muted small parent-phone">
                <i class="fas fa-phone me-1"></i>
                ${info.parent_phone}
            </div>
            ${info.parent_email ? `
                <div class="text-muted small parent-email">
                    <i class="fas fa-envelope me-1"></i>
                    ${info.parent_email}
                </div>
            ` : ''}
        `;
    } else {
        return `
            <span class="text-muted small">
                <i class="fas fa-exclamation-circle me-1"></i>
                No parent assigned
            </span>
        `;
    }
}

function renderStatusInfo(info) {
    return `
        <span class="badge-status badge-${info.status} student-status">
            <i class="fas fa-circle"></i>
            ${info.status_display}
        </span>
        <div class="mt-1 small text-muted">
            <i class="far fa-clock me-1"></i>
            ${info.updated_at}
        </div>
    `;
}

function renderActionButtons(studentId) {
    return `
        <div class="action-buttons">
            <a href="/admin/students/${studentId}/" 
               class="action-btn btn-view" 
               title="View Details"
               data-toggle="tooltip">
                <i class="fas fa-eye"></i>
            </a>
            <a href="/admin/students/${studentId}/edit/" 
               class="action-btn btn-edit"
               title="Edit Student"
               data-toggle="tooltip">
                <i class="fas fa-edit"></i>
            </a>
            <a href="/admin/students/${studentId}/parent/add/" 
               class="action-btn btn-parents"
               title="Manage Parents"
               data-toggle="tooltip">
                <i class="fas fa-user-friends"></i>
            </a>
        </div>
    `;
}

// Apply filters
function applyFilters() {
    showLoading('Applying filters...');
    updateActiveFilters();
    dataTable.ajax.reload(function() {
        hideLoading();
    });
}

// Update active filters display
function updateActiveFilters() {
    activeFilters = {
        class: $('#classLevelFilter').val() ? $('#classLevelFilter option:selected').text() : null,
        stream: $('#streamFilter').val() ? $('#streamFilter option:selected').text() : null,
        year: $('#academicYearFilter').val() ? $('#academicYearFilter option:selected').text() : null,
        status: $('#statusFilter').val() ? $('#statusFilter option:selected').text() : null,
        gender: $('#genderFilter').val() ? $('#genderFilter option:selected').text() : null
    };
    
    const container = $('#activeFiltersContainer');
    let html = '<span class="fw-bold text-muted me-2">Active Filters:</span>';
    let hasFilters = false;
    
    for (const [key, value] of Object.entries(activeFilters)) {
        if (value) {
            hasFilters = true;
            html += `
                <div class="filter-badge">
                    <span class="badge-label">${key.charAt(0).toUpperCase() + key.slice(1)}:</span>
                    <span class="badge-value">${value}</span>
                    <span class="remove-filter" onclick="removeFilter('${key}')">
                        <i class="fas fa-times"></i>
                    </span>
                </div>
            `;
        }
    }
    
    if (hasFilters) {
        container.html(html).show();
    } else {
        container.hide();
    }
}

// Remove a specific filter
function removeFilter(filterName) {
    const filterMap = {
        'class': '#classLevelFilter',
        'stream': '#streamFilter',
        'year': '#academicYearFilter',
        'status': '#statusFilter',
        'gender': '#genderFilter'
    };
    
    $(filterMap[filterName]).val('').trigger('change');
    
    // If removing class filter, reload all streams
    if (filterName === 'class') {
        loadStreams('');
    }
    
    updateActiveFilters();
    dataTable.ajax.reload();
}

// Reset all filters
function resetFilters() {
    $('.select2-filter').val('').trigger('change');
    loadStreams(''); // Load all streams
    updateActiveFilters();
    dataTable.ajax.reload();
}

// Load statistics
function loadStatistics() {
    $.ajax({
        url: '{% url "statistics_api" %}',
        method: 'GET',
        success: function(response) {
            if (response.success) {
                $('#totalStudents').text(response.statistics.total);
                $('#activeStudents').text(response.statistics.active);
                $('#maleStudents').text(response.statistics.male);
                $('#femaleStudents').text(response.statistics.female);
            }
        },
        error: function() {
            console.error('Failed to load statistics');
        }
    });
}

// Update statistics
function updateStatistics(total, json) {
    $('#totalStudents').text(total);
    
    // You can add more detailed statistics from the API if needed
    // This is a placeholder for now
}

// Filter by stat click
function filterByStat(type) {
    switch(type) {
        case 'active':
            $('#statusFilter').val('active').trigger('change');
            break;
        case 'male':
            $('#genderFilter').val('male').trigger('change');
            break;
        case 'female':
            $('#genderFilter').val('female').trigger('change');
            break;
        default:
            // Reset status and gender for 'all'
            $('#statusFilter').val('').trigger('change');
            $('#genderFilter').val('').trigger('change');
    }
    
    updateActiveFilters();
    dataTable.ajax.reload();
}

// Show loading overlay
function showLoading(message = 'Loading...') {
    $('#loadingText').text(message);
    $('#loadingOverlay').fadeIn(300);
}

// Hide loading overlay
function hideLoading() {
    $('#loadingOverlay').fadeOut(300);
}

// Export to Excel
function exportToExcel() {
    showLoading('Generating Excel file...');
    
    // Get current filter values
    const classLevel = $('#classLevelFilter').val() || '';
    const stream = $('#streamFilter').val() || '';
    const academicYear = $('#academicYearFilter').val() || '';
    const status = $('#statusFilter').val() || '';
    const gender = $('#genderFilter').val() || '';
    const search = $('input[type="search"]').val() || '';
    
    // Build URL with filter parameters
    let url = '{% url "export_students_excel" %}?';
    const params = new URLSearchParams({
        class_level: classLevel,
        stream: stream,
        academic_year: academicYear,
        status: status,
        gender: gender,
        search: search
    });
    
    // Redirect to export URL
    window.location.href = url + params.toString();
    
    // Hide loading after a short delay
    setTimeout(() => {
        hideLoading();
    }, 2000);
}

// Export to PDF
function exportToPDF() {
    showLoading('Generating PDF file...');
    
    // Get current filter values
    const classLevel = $('#classLevelFilter').val() || '';
    const stream = $('#streamFilter').val() || '';
    const academicYear = $('#academicYearFilter').val() || '';
    const status = $('#statusFilter').val() || '';
    const gender = $('#genderFilter').val() || '';
    const search = $('input[type="search"]').val() || '';
    
    // Build URL with filter parameters
    let url = '{% url "export_students_pdf" %}?';
    const params = new URLSearchParams({
        class_level: classLevel,
        stream: stream,
        academic_year: academicYear,
        status: status,
        gender: gender,
        search: search
    });
    
    // Redirect to export URL
    window.location.href = url + params.toString();
    
    // Hide loading after a short delay
    setTimeout(() => {
        hideLoading();
    }, 2000);
}

// Keyboard shortcut
document.addEventListener('keydown', function(e) {
    if (e.ctrlKey && e.key === 'f') {
        e.preventDefault();
        $('input[type="search"]').focus();
    }
});
</script>
{% endblock extra_js %}