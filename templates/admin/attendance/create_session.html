<!-- attendance/create_session.html -->
{% extends 'admin/base.html' %}
{% load static %}

{% block title %}Create Attendance Session{% endblock %}

{% block breadcrumb %}
<button type="button" class="btn btn-secondary" onclick="window.history.back()">
    <i class="fas fa-arrow-left"></i> Back
</button>
<button type="button" class="btn btn-info" data-toggle="modal" data-target="#bulkCreateModal">
    <i class="fas fa-users"></i> Bulk Create
</button>
<button type="button" class="btn btn-success" id="saveDraftBtn">
    <i class="fas fa-save"></i> Save as Draft
</button>
{% endblock breadcrumb %}

{% block extra_css %}
<link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
<link href="https://cdn.jsdelivr.net/npm/@ttskch/select2-bootstrap4-theme@1.5.2/dist/select2-bootstrap4.min.css" rel="stylesheet" />
<style>
    .create-session-container {
        background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
        min-height: calc(100vh - 200px);
        padding: 20px;
        border-radius: 10px;
    }
    
    .session-wrapper {
        background: white;
        border-radius: 10px;
        padding: 30px;
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
        max-width: 1200px;
        margin: 0 auto;
    }
    
    .session-header {
        margin-bottom: 30px;
        padding-bottom: 20px;
        border-bottom: 2px solid #e9ecef;
    }
    
    .session-title {
        font-size: 1.8rem;
        font-weight: 700;
        color: #2c3e50;
        display: flex;
        align-items: center;
        gap: 15px;
    }
    
    .session-steps {
        display: flex;
        align-items: center;
        gap: 10px;
        margin-top: 20px;
    }
    
    .step-indicator {
        width: 35px;
        height: 35px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: 600;
        font-size: 0.9rem;
        background: #e9ecef;
        color: #6c757d;
        cursor: pointer;
        transition: all 0.3s ease;
    }
    
    .step-indicator.active {
        background: #007bff;
        color: white;
    }
    
    .step-indicator.completed {
        background: #28a745;
        color: white;
    }
    
    .step-separator {
        width: 30px;
        height: 2px;
        background: #e9ecef;
    }
    
    .step-separator.active {
        background: #007bff;
    }
    
    .steps-container {
        min-height: 400px;
        position: relative;
    }
    
    .step-content {
        display: none;
        animation: fadeIn 0.5s ease;
    }
    
    .step-content.active {
        display: block;
    }
    
    @keyframes fadeIn {
        from { opacity: 0; transform: translateY(20px); }
        to { opacity: 1; transform: translateY(0); }
    }
    
    .session-details-form {
        max-width: 800px;
        margin: 0 auto;
    }
    
    .form-section {
        background: #f8f9fa;
        border-radius: 10px;
        padding: 25px;
        margin-bottom: 25px;
        border: 1px solid #e9ecef;
    }
    
    .section-title {
        font-weight: 600;
        color: #495057;
        margin-bottom: 20px;
        display: flex;
        align-items: center;
        gap: 10px;
        font-size: 1.1rem;
    }
    
    .form-row {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
        gap: 20px;
        margin-bottom: 20px;
    }
    
    .required::after {
        content: '*';
        color: #dc3545;
        margin-left: 3px;
    }
    
    .quick-dates {
        display: flex;
        gap: 10px;
        margin-bottom: 20px;
        flex-wrap: wrap;
    }
    
    .quick-date-btn {
        padding: 8px 15px;
        border: 1px solid #dee2e6;
        background: white;
        border-radius: 5px;
        cursor: pointer;
        transition: all 0.2s ease;
        font-size: 0.9rem;
        color: #495057;
    }
    
    .quick-date-btn:hover {
        background: #f8f9fa;
        border-color: #007bff;
        color: #007bff;
    }
    
    .quick-date-btn.active {
        background: #007bff;
        border-color: #007bff;
        color: white;
    }
    
    .students-selection {
        max-width: 100%;
    }
    
    .selection-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 20px;
        padding: 15px;
        background: #f8f9fa;
        border-radius: 8px;
        border: 1px solid #e9ecef;
    }
    
    .info-badge {
        padding: 5px 12px;
        border-radius: 20px;
        font-weight: 500;
        font-size: 0.9rem;
    }
    
    .info-badge.total { background: #6c757d; color: white; }
    .info-badge.selected { background: #007bff; color: white; }
    
    .students-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
        gap: 15px;
        margin-bottom: 30px;
        max-height: 500px;
        overflow-y: auto;
        padding: 10px;
    }
    
    .student-select-card {
        background: white;
        border: 2px solid #e9ecef;
        border-radius: 8px;
        padding: 15px;
        cursor: pointer;
        transition: all 0.3s ease;
    }
    
    .student-select-card:hover {
        border-color: #007bff;
        transform: translateY(-2px);
        box-shadow: 0 3px 10px rgba(0, 0, 0, 0.1);
    }
    
    .student-select-card.selected {
        border-color: #28a745;
        background: #f8fff9;
    }
    
    .student-header {
        display: flex;
        align-items: center;
        gap: 15px;
        margin-bottom: 10px;
    }
    
    .student-avatar-sm {
        width: 45px;
        height: 45px;
        border-radius: 50%;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        display: flex;
        align-items: center;
        justify-content: center;
        color: white;
        font-weight: 600;
        flex-shrink: 0;
    }
    
    .student-name {
        font-weight: 600;
        color: #495057;
        margin-bottom: 3px;
    }
    
    .student-details {
        font-size: 0.85rem;
        color: #6c757d;
    }
    
    .status-select {
        width: 100%;
        padding: 8px;
        border: 1px solid #dee2e6;
        border-radius: 5px;
        font-size: 0.9rem;
        background: white;
        cursor: pointer;
    }
    
    .status-select.present { background: #d4edda; color: #155724; }
    .status-select.absent { background: #f8d7da; color: #721c24; }
    .status-select.late { background: #fff3cd; color: #856404; }
    .status-select.excused { background: #d1ecf1; color: #0c5460; }
    
    .remark-input {
        width: 100%;
        padding: 8px;
        border: 1px solid #dee2e6;
        border-radius: 5px;
        font-size: 0.85rem;
        margin-top: 8px;
        display: none;
    }
    
    .student-select-card.selected .remark-input {
        display: block;
    }
    
    .bulk-actions {
        background: #f8f9fa;
        border-radius: 8px;
        padding: 15px;
        margin-bottom: 20px;
        border: 1px solid #e9ecef;
    }
    
    .bulk-controls {
        display: flex;
        gap: 10px;
        align-items: center;
    }
    
    .review-container {
        max-width: 900px;
        margin: 0 auto;
    }
    
    .review-summary {
        background: #f8f9fa;
        border-radius: 10px;
        padding: 25px;
        margin-bottom: 30px;
        border: 1px solid #e9ecef;
    }
    
    .summary-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 20px;
        margin-bottom: 20px;
    }
    
    .summary-item {
        text-align: center;
        padding: 15px;
        background: white;
        border-radius: 8px;
        border: 1px solid #e9ecef;
    }
    
    .summary-value {
        font-size: 1.5rem;
        font-weight: 700;
        color: #495057;
        margin-bottom: 5px;
    }
    
    .step-navigation {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-top: 30px;
        padding-top: 20px;
        border-top: 1px solid #e9ecef;
    }
    
    .nav-btn {
        padding: 8px 20px;
        border-radius: 5px;
        font-weight: 500;
        display: flex;
        align-items: center;
        gap: 8px;
        transition: all 0.3s ease;
    }
    
    .btn-prev {
        background: #6c757d;
        color: white;
        border: none;
    }
    
    .btn-prev:hover {
        background: #5a6268;
    }
    
    .btn-next {
        background: #007bff;
        color: white;
        border: none;
    }
    
    .btn-next:hover {
        background: #0056b3;
    }
    
    .btn-submit {
        background: #28a745;
        color: white;
        border: none;
    }
    
    .btn-submit:hover {
        background: #218838;
    }
    
    .loading-overlay {
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(255, 255, 255, 0.9);
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        z-index: 9999;
        display: none;
    }
    
    .loading-spinner {
        width: 50px;
        height: 50px;
        border: 5px solid #f3f3f3;
        border-top: 5px solid #007bff;
        border-radius: 50%;
        animation: spin 1s linear infinite;
        margin-bottom: 20px;
    }
    
    @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
    }
    
    /* Select2 customizations */
    .select2-container {
        width: 100% !important;
    }
    
    .select2-container--bootstrap4 .select2-selection {
        min-height: 38px;
        border: 1px solid #ced4da;
        border-radius: 0.25rem;
        transition: border-color 0.15s ease-in-out, box-shadow 0.15s ease-in-out;
    }
    
    .select2-container--bootstrap4.select2-container--focus .select2-selection {
        border-color: #80bdff;
        box-shadow: 0 0 0 0.2rem rgba(0, 123, 255, 0.25);
    }
    
    .select2-container--bootstrap4 .select2-selection--multiple {
        min-height: 38px;
    }
    
    .select2-container--bootstrap4 .select2-selection--multiple .select2-selection__choice {
        background-color: #007bff;
        border-color: #006fe6;
        color: white;
        padding: 2px 8px;
        margin-top: 5px;
    }
    
    .select2-container--bootstrap4 .select2-selection--multiple .select2-selection__choice__remove {
        color: white;
        margin-right: 5px;
    }
    
    .select2-container--bootstrap4 .select2-selection--multiple .select2-selection__choice__remove:hover {
        color: #ffcccb;
    }
    
    .select2-search--inline .select2-search__field {
        margin-top: 7px;
    }
    
    .select2-dropdown {
        border: 1px solid #ced4da;
        border-radius: 0.25rem;
        box-shadow: 0 0.5rem 1rem rgba(0, 0, 0, 0.15);
    }
    
    @media (max-width: 768px) {
        .session-wrapper {
            padding: 20px;
        }
        
        .form-row {
            grid-template-columns: 1fr;
        }
        
        .students-grid {
            grid-template-columns: 1fr;
        }
        
        .step-navigation {
            flex-direction: column;
            gap: 15px;
        }
        
        .nav-btn {
            width: 100%;
            justify-content: center;
        }
        
        .select2-container {
            font-size: 0.9rem;
        }
    }
</style>
{% endblock %}

{% block content %}
<section class="content">
    <div class="container-fluid">
        <div class="create-session-container">
            <div class="session-wrapper">
                <!-- Session Header -->
                <div class="session-header">
                    <div class="session-title">
                        <i class="fas fa-calendar-plus"></i>
                        Create Attendance Session
                    </div>
                    
                    <!-- Step Indicators -->
                    <div class="session-steps">
                        <div class="step-indicator active" data-step="1">
                            <i class="fas fa-info-circle"></i>
                        </div>
                        <div class="step-separator"></div>
                        <div class="step-indicator" data-step="2">
                            <i class="fas fa-users"></i>
                        </div>
                        <div class="step-separator"></div>
                        <div class="step-indicator" data-step="3">
                            <i class="fas fa-check-circle"></i>
                        </div>
                    </div>
                </div>
                
                <!-- Steps Container -->
                <div class="steps-container">
                    <!-- Step 1: Session Details -->
                    <div class="step-content active" id="step1">
                        <form id="sessionDetailsForm">
                            <div class="session-details-form">
                                <!-- Date Selection -->
                                <div class="form-section">
                                    <h5 class="section-title">
                                        <i class="fas fa-calendar-alt"></i>
                                        Date & Time
                                    </h5>
                                    
                                    <div class="quick-dates">
                                        <button type="button" class="quick-date-btn active" data-date="today">
                                            Today ({{ today|date:"M d" }})
                                        </button>
                                        <button type="button" class="quick-date-btn" data-date="yesterday">
                                            Yesterday ({{ yesterday|date:"M d" }})
                                        </button>
                                        <button type="button" class="quick-date-btn" data-date="tomorrow">
                                            Tomorrow ({{ tomorrow|date:"M d" }})
                                        </button>
                                    </div>
                                    
                                    <div class="form-row">
                                        <div class="form-group">
                                            <label for="sessionDate" class="required">Date</label>
                                            <input type="date" 
                                                   class="form-control" 
                                                   id="sessionDate" 
                                                   value="{{ today|date:'Y-m-d' }}"
                                                   required>
                                        </div>
                                        <div class="form-group">
                                            <label for="period">Period (Optional)</label>
                                            <select class="form-control select2-single" id="period">
                                                <option value="">Select Period</option>
                                                {% for i in "12345678" %}
                                                <option value="{{ i }}">Period {{ i }}</option>
                                                {% endfor %}
                                            </select>
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- Class & Stream Selection -->
                                <div class="form-section">
                                    <h5 class="section-title">
                                        <i class="fas fa-school"></i>
                                        Class & Stream
                                    </h5>
                                    
                                    <div class="form-row">
                                        <div class="form-group">
                                            <label for="classLevel" class="required">Class Level</label>
                                            <select class="form-control select2-single" id="classLevel" required>
                                                <option value="">Select Class Level</option>
                                                {% for class in class_levels %}
                                                <option value="{{ class.id }}">{{ class.name }}</option>
                                                {% endfor %}
                                            </select>
                                        </div>
                                        <div class="form-group">
                                            <label for="stream" class="required">Stream</label>
                                            <select class="form-control select2-single" id="stream" required disabled>
                                                <option value="">Select Class First</option>
                                            </select>
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- Session Type -->
                                <div class="form-section">
                                    <h5 class="section-title">
                                        <i class="fas fa-tasks"></i>
                                        Session Details
                                    </h5>
                                    
                                    <div class="form-row">
                                        <div class="form-group">
                                            <label for="sessionType" class="required">Session Type</label>
                                            <select class="form-control select2-single" id="sessionType" required>
                                                <option value="">Select Type</option>
                                                <option value="CLASS">Class Attendance</option>
                                                <option value="SUBJECT">Subject Attendance</option>
                                            </select>
                                        </div>
                                        <div class="form-group">
                                            <label for="defaultStatus" class="required">Default Status</label>
                                            <select class="form-control select2-single" id="defaultStatus" required>
                                                <option value="P" selected>Present</option>
                                                <option value="A">Absent</option>
                                                <option value="L">Late</option>
                                                <option value="E">Excused</option>
                                            </select>
                                        </div>
                                    </div>
                                    
                                    <!-- Subject Selection (Only for Subject Type) -->
                                    <div class="form-row" id="subjectSection" style="display: none;">
                                        <div class="form-group">
                                            <label for="subject" class="required">Subject</label>
                                            <select class="form-control select2-single" id="subject" disabled>
                                                <option value="">Select Subject</option>
                                            </select>
                                        </div>
                                    </div>
                                    
                                    <div class="form-group">
                                        <label for="description">Description (Optional)</label>
                                        <textarea class="form-control" 
                                                  id="description" 
                                                  rows="2" 
                                                  placeholder="Add any additional details..."></textarea>
                                    </div>
                                </div>
                            </div>
                        </form>
                    </div>
                    
                    <!-- Step 2: Select Students -->
                    <div class="step-content" id="step2">
                        <div class="students-selection">
                            <!-- Selection Header -->
                            <div class="selection-header">
                                <div class="selection-info">
                                    <span class="info-badge total">
                                        <i class="fas fa-users"></i>
                                        <span id="totalStudentsCount">0</span> Students
                                    </span>
                                    <span class="info-badge selected">
                                        <i class="fas fa-check-circle"></i>
                                        <span id="selectedStudentsCount">0</span> Selected
                                    </span>
                                </div>
                                <div class="selection-actions">
                                    <button type="button" class="btn btn-outline-primary btn-sm" id="selectAllBtn">
                                        <i class="fas fa-check-double"></i> Select All
                                    </button>
                                    <button type="button" class="btn btn-outline-secondary btn-sm" id="deselectAllBtn">
                                        <i class="fas fa-times"></i> Deselect All
                                    </button>
                                </div>
                            </div>
                            
                            <!-- Student Search -->
                            <div class="student-search mb-3">
                                <div class="input-group">
                                    <div class="input-group-prepend">
                                        <span class="input-group-text">
                                            <i class="fas fa-search"></i>
                                        </span>
                                    </div>
                                    <input type="text" 
                                           class="form-control" 
                                           id="studentSearch" 
                                           placeholder="Search students by name or admission number...">
                                </div>
                            </div>
                            
                            <!-- Bulk Actions -->
                            <div class="bulk-actions mb-3">
                                <div class="bulk-controls">
                                    <select class="form-control select2-single" id="bulkStatus" style="max-width: 120px;">
                                        <option value="P">Present</option>
                                        <option value="A">Absent</option>
                                        <option value="L">Late</option>
                                        <option value="E">Excused</option>
                                    </select>
                                    <button type="button" class="btn btn-primary btn-sm" id="applyBulkStatus">
                                        <i class="fas fa-check"></i> Apply to Selected
                                    </button>
                                    <button type="button" class="btn btn-outline-info btn-sm" id="addRemarkToAll">
                                        <i class="fas fa-comment"></i> Add Remark
                                    </button>
                                </div>
                            </div>
                            
                            <!-- Students Grid -->
                            <div class="students-grid" id="studentsGrid">
                                <div class="text-center py-5" id="loadingStudents">
                                    <div class="spinner-border text-primary" role="status">
                                        <span class="sr-only">Loading students...</span>
                                    </div>
                                    <p class="text-muted mt-3">Select class and stream to load students</p>
                                </div>
                            </div>
                            
                            <!-- No Students Message -->
                            <div class="text-center py-5" id="noStudentsMessage" style="display: none;">
                                <i class="fas fa-users-slash fa-3x text-muted mb-3"></i>
                                <h5 class="text-muted">No Students Found</h5>
                                <p class="text-muted">No students are registered in the selected class and stream.</p>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Step 3: Review & Confirm -->
                    <div class="step-content" id="step3">
                        <div class="review-container">
                            <div class="review-summary">
                                <h5 class="section-title mb-4">
                                    <i class="fas fa-clipboard-check"></i>
                                    Review & Confirm
                                </h5>
                                
                                <div class="summary-grid">
                                    <div class="summary-item">
                                        <div class="summary-value" id="reviewDate">{{ today|date:"M d, Y" }}</div>
                                        <div class="summary-label">Date</div>
                                    </div>
                                    <div class="summary-item">
                                        <div class="summary-value" id="reviewClass">-</div>
                                        <div class="summary-label">Class</div>
                                    </div>
                                    <div class="summary-item">
                                        <div class="summary-value" id="reviewType">-</div>
                                        <div class="summary-label">Session Type</div>
                                    </div>
                                    <div class="summary-item">
                                        <div class="summary-value" id="reviewTotal">0</div>
                                        <div class="summary-label">Total Students</div>
                                    </div>
                                </div>
                                
                                <!-- Attendance Summary -->
                                <div class="summary-grid mt-4">
                                    <div class="summary-item">
                                        <div class="summary-value text-success" id="reviewPresent">0</div>
                                        <div class="summary-label">Present</div>
                                    </div>
                                    <div class="summary-item">
                                        <div class="summary-value text-danger" id="reviewAbsent">0</div>
                                        <div class="summary-label">Absent</div>
                                    </div>
                                    <div class="summary-item">
                                        <div class="summary-value text-warning" id="reviewLate">0</div>
                                        <div class="summary-label">Late</div>
                                    </div>
                                    <div class="summary-item">
                                        <div class="summary-value text-info" id="reviewExcused">0</div>
                                        <div class="summary-label">Excused</div>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Preview -->
                            <div class="card">
                                <div class="card-header">
                                    <h6 class="card-title mb-0">
                                        <i class="fas fa-list"></i>
                                        Student List
                                    </h6>
                                </div>
                                <div class="card-body p-0">
                                    <div class="table-responsive">
                                        <table class="table table-sm mb-0">
                                            <thead>
                                                <tr>
                                                    <th>#</th>
                                                    <th>Student</th>
                                                    <th>Admission No.</th>
                                                    <th>Status</th>
                                                    <th>Remark</th>
                                                </tr>
                                            </thead>
                                            <tbody id="reviewTableBody">
                                                <!-- Will be populated dynamically -->
                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Step Navigation -->
                <div class="step-navigation">
                    <button type="button" class="nav-btn btn-prev" id="prevStepBtn" disabled>
                        <i class="fas fa-arrow-left"></i> Previous
                    </button>
                    
                    <div class="step-info">
                        <span class="text-muted">Step</span>
                        <strong id="currentStep">1</strong>
                        <span class="text-muted">of 3</span>
                    </div>
                    
                    <button type="button" class="nav-btn btn-next" id="nextStepBtn">
                        Next <i class="fas fa-arrow-right"></i>
                    </button>
                </div>
            </div>
        </div>
    </div>
</section>

<!-- Loading Overlay -->
<div class="loading-overlay" id="loadingOverlay">
    <div class="loading-spinner"></div>
    <h5 id="loadingMessage">Creating attendance session...</h5>
</div>

<!-- Add Remark Modal -->
<div class="modal fade" id="remarkModal" tabindex="-1" role="dialog">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="fas fa-comment"></i> Add Remark
                </h5>
                <button type="button" class="close" data-dismiss="modal">
                    <span>&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label for="remarkText">Remark Text</label>
                    <textarea class="form-control" id="remarkText" rows="3" 
                              placeholder="Enter remark for selected students..."></textarea>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" id="applyRemark">
                    <i class="fas fa-check"></i> Apply to Selected
                </button>
            </div>
        </div>
    </div>
</div>
{% endblock content %}

{% block extra_js %}
<script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>
<script>
$(document).ready(function() {
    // Global variables
    let currentStep = 1;
    let selectedClassId = null;
    let selectedStreamId = null;
    let studentsData = [];
    let selectedStudents = new Set();
    let studentStatus = {};
    
    // Initialize Select2
    function initializeSelect2() {
        $('.select2-single').select2({
            theme: 'bootstrap4',
            width: '100%',
            placeholder: 'Select an option',
            allowClear: true,
            dropdownParent: $('.session-wrapper')
        });
        
        // Handle Select2 change events
        $('#classLevel').on('select2:select', function(e) {
            const classId = $(this).val();
            selectedClassId = classId;
            loadStreamsForClass(classId);
            
            // Enable subject loading if session type is SUBJECT
            if ($('#sessionType').val() === 'SUBJECT') {
                loadSubjectsForClass(classId);
            }
        });
        
        $('#sessionType').on('select2:select', function(e) {
            const type = $(this).val();
            if (type === 'SUBJECT') {
                $('#subjectSection').show();
                if (selectedClassId) {
                    loadSubjectsForClass(selectedClassId);
                }
            } else {
                $('#subjectSection').hide();
            }
        });
        
        $('#stream').on('select2:select', function(e) {
            selectedStreamId = $(this).val();
        });
    }
    
    // Initialize
    function initialize() {
        initializeSelect2();
        
        // Quick date selection
        $('.quick-date-btn').click(function() {
            $('.quick-date-btn').removeClass('active');
            $(this).addClass('active');
            
            const dateType = $(this).data('date');
            const today = new Date();
            const sessionDate = $('#sessionDate');
            
            switch(dateType) {
                case 'today':
                    sessionDate.val(today.toISOString().split('T')[0]);
                    break;
                case 'yesterday':
                    const yesterday = new Date(today);
                    yesterday.setDate(yesterday.getDate() - 1);
                    sessionDate.val(yesterday.toISOString().split('T')[0]);
                    break;
                case 'tomorrow':
                    const tomorrow = new Date(today);
                    tomorrow.setDate(tomorrow.getDate() + 1);
                    sessionDate.val(tomorrow.toISOString().split('T')[0]);
                    break;
            }
        });
        
        // Step navigation
        $('#nextStepBtn').click(nextStep);
        $('#prevStepBtn').click(prevStep);
        
        // Student selection
        $('#selectAllBtn').click(selectAllStudents);
        $('#deselectAllBtn').click(deselectAllStudents);
        
        // Bulk actions
        $('#applyBulkStatus').click(applyBulkStatus);
        $('#addRemarkToAll').click(function() {
            $('#remarkModal').modal('show');
        });
        
        // Apply remark
        $('#applyRemark').click(function() {
            const remark = $('#remarkText').val().trim();
            if (remark) {
                applyRemarkToSelected(remark);
                $('#remarkModal').modal('hide');
                $('#remarkText').val('');
            }
        });
        
        // Student search
        $('#studentSearch').on('keyup', function() {
            filterStudents($(this).val().toLowerCase());
        });
        
        // Save draft
        $('#saveDraftBtn').click(saveAsDraft);
    }
    
    // Load streams for selected class
    function loadStreamsForClass(classId) {
        if (!classId) {
            $('#stream').empty().html('<option value="">Select Class First</option>');
            $('#stream').prop('disabled', true).trigger('change');
            return;
        }
        
        $.ajax({
            url: `/attendance/api/streams/class/${classId}/`,
            method: 'GET',
            success: function(response) {
                if (response.success) {
                    const $streamSelect = $('#stream');
                    let options = '<option value="">Select Stream</option>';
                    
                    response.streams.forEach(stream => {
                        options += `<option value="${stream.id}">${stream.name}</option>`;
                    });
                    
                    $streamSelect.html(options).prop('disabled', false);
                    $streamSelect.select2({
                        theme: 'bootstrap4',
                        width: '100%',
                        placeholder: 'Select Stream',
                        dropdownParent: $('.session-wrapper')
                    });
                }
            },
            error: function() {
                showToast('Error loading streams', 'error');
            }
        });
    }
    
    // Load subjects for selected class
    function loadSubjectsForClass(classId) {
        if (!classId) {
            $('#subject').empty().html('<option value="">Select Class First</option>');
            $('#subject').prop('disabled', true).trigger('change');
            return;
        }
        
        $.ajax({
            url: `/attendance/api/subjects/class/${classId}/`,
            method: 'GET',
            success: function(response) {
                if (response.success) {
                    const $subjectSelect = $('#subject');
                    let options = '<option value="">Select Subject</option>';
                    
                    response.subjects.forEach(subject => {
                        options += `<option value="${subject.id}">${subject.name}</option>`;
                    });
                    
                    $subjectSelect.html(options).prop('disabled', false);
                    $subjectSelect.select2({
                        theme: 'bootstrap4',
                        width: '100%',
                        placeholder: 'Select Subject',
                        dropdownParent: $('.session-wrapper')
                    });
                }
            },
            error: function() {
                showToast('Error loading subjects', 'error');
            }
        });
    }
    
    // Load students for selected class and stream
    function loadStudents() {
        const classId = $('#classLevel').val();
        const streamId = $('#stream').val();
        
        if (!classId || !streamId) {
            showToast('Please select both class and stream first', 'warning');
            return false;
        }
        
        selectedClassId = classId;
        selectedStreamId = streamId;
        
        $('#loadingStudents').show();
        $('#studentsGrid').hide();
        
        $.ajax({
            url: `/attendance/api/students/class/${classId}/stream/${streamId}/`,
            method: 'GET',
            success: function(response) {
                $('#loadingStudents').hide();
                if (response.success) {
                    studentsData = response.students;
                    renderStudentsGrid();
                    updateStudentCounts();
                } else {
                    showToast(response.message || 'No students found', 'warning');
                    $('#noStudentsMessage').show();
                    $('#studentsGrid').hide();
                }
            },
            error: function() {
                $('#loadingStudents').hide();
                showToast('Error loading students', 'error');
            }
        });
        
        return true;
    }
    
    // Render students grid
    function renderStudentsGrid() {
        const $studentsGrid = $('#studentsGrid');
        const $noStudentsMessage = $('#noStudentsMessage');
        
        if (studentsData.length === 0) {
            $noStudentsMessage.show();
            $studentsGrid.hide();
            return;
        }
        
        $noStudentsMessage.hide();
        $studentsGrid.show().empty();
        
        studentsData.forEach(student => {
            const isSelected = selectedStudents.has(student.id.toString());
            const status = studentStatus[student.id]?.status || $('#defaultStatus').val();
            const remark = studentStatus[student.id]?.remark || '';
            
            const studentCard = `
                <div class="student-select-card ${isSelected ? 'selected' : ''}" data-student-id="${student.id}">
                    <div class="student-header">
                        <div class="student-avatar-sm">
                            ${student.full_name.charAt(0)}
                        </div>
                        <div class="student-info">
                            <div class="student-name">${student.full_name}</div>
                            <div class="student-details">
                                ${student.admission_number}
                            </div>
                        </div>
                        <div class="custom-control custom-checkbox">
                            <input type="checkbox" 
                                   class="custom-control-input student-checkbox" 
                                   id="student_${student.id}"
                                   ${isSelected ? 'checked' : ''}>
                            <label class="custom-control-label" for="student_${student.id}"></label>
                        </div>
                    </div>
                    
                    <select class="status-select ${getStatusClass(status)}" data-student-id="${student.id}">
                        <option value="P" ${status === 'P' ? 'selected' : ''}>Present</option>
                        <option value="A" ${status === 'A' ? 'selected' : ''}>Absent</option>
                        <option value="L" ${status === 'L' ? 'selected' : ''}>Late</option>
                        <option value="E" ${status === 'E' ? 'selected' : ''}>Excused</option>
                    </select>
                    
                    <input type="text" 
                           class="remark-input" 
                           placeholder="Add remark..."
                           value="${remark}"
                           data-student-id="${student.id}">
                </div>
            `;
            
            $studentsGrid.append(studentCard);
        });
        
        // Attach event listeners
        $('.student-select-card').click(function(e) {
            if (!$(e.target).closest('select').length && 
                !$(e.target).closest('.custom-control').length &&
                !$(e.target).is('input')) {
                toggleStudentSelection($(this).data('student-id'));
            }
        });
        
        $('.student-checkbox').change(function() {
            const studentId = $(this).closest('.student-select-card').data('student-id');
            if ($(this).is(':checked')) {
                selectStudent(studentId);
            } else {
                deselectStudent(studentId);
            }
        });
        
        $('.status-select').change(function() {
            const studentId = $(this).data('student-id');
            const status = $(this).val();
            
            if (!studentStatus[studentId]) {
                studentStatus[studentId] = {};
            }
            studentStatus[studentId].status = status;
            
            $(this).removeClass('status-present status-absent status-late status-excused')
                   .addClass(getStatusClass(status));
            
            updateStudentCounts();
            updateReviewData();
        });
        
        $('.remark-input').on('input', function() {
            const studentId = $(this).data('student-id');
            const remark = $(this).val().trim();
            
            if (!studentStatus[studentId]) {
                studentStatus[studentId] = {};
            }
            studentStatus[studentId].remark = remark;
        });
    }
    
    // Get status CSS class
    function getStatusClass(status) {
        switch(status) {
            case 'P': return 'status-present';
            case 'A': return 'status-absent';
            case 'L': return 'status-late';
            case 'E': return 'status-excused';
            default: return '';
        }
    }
    
    // Toggle student selection
    function toggleStudentSelection(studentId) {
        if (selectedStudents.has(studentId.toString())) {
            deselectStudent(studentId);
        } else {
            selectStudent(studentId);
        }
    }
    
    // Select student
    function selectStudent(studentId) {
        selectedStudents.add(studentId.toString());
        $(`.student-select-card[data-student-id="${studentId}"]`).addClass('selected');
        $(`#student_${studentId}`).prop('checked', true);
        
        // Initialize status if not set
        if (!studentStatus[studentId]) {
            studentStatus[studentId] = {
                status: $('#defaultStatus').val(),
                remark: ''
            };
        }
        
        updateStudentCounts();
    }
    
    // Deselect student
    function deselectStudent(studentId) {
        selectedStudents.delete(studentId.toString());
        $(`.student-select-card[data-student-id="${studentId}"]`).removeClass('selected');
        $(`#student_${studentId}`).prop('checked', false);
        updateStudentCounts();
    }
    
    // Select all students
    function selectAllStudents() {
        studentsData.forEach(student => {
            selectStudent(student.id);
        });
        showToast('All students selected', 'success');
    }
    
    // Deselect all students
    function deselectAllStudents() {
        selectedStudents.clear();
        $('.student-select-card').removeClass('selected');
        $('.student-checkbox').prop('checked', false);
        updateStudentCounts();
        showToast('All students deselected', 'info');
    }
    
    // Apply bulk status
    function applyBulkStatus() {
        const status = $('#bulkStatus').val();
        
        selectedStudents.forEach(studentId => {
            if (!studentStatus[studentId]) {
                studentStatus[studentId] = {};
            }
            studentStatus[studentId].status = status;
            
            // Update UI
            $(`.status-select[data-student-id="${studentId}"]`)
                .val(status)
                .removeClass('status-present status-absent status-late status-excused')
                .addClass(getStatusClass(status));
        });
        
        updateStudentCounts();
        updateReviewData();
        showToast(`Status applied to ${selectedStudents.size} students`, 'success');
    }
    
    // Apply remark to selected
    function applyRemarkToSelected(remark) {
        selectedStudents.forEach(studentId => {
            if (!studentStatus[studentId]) {
                studentStatus[studentId] = {};
            }
            studentStatus[studentId].remark = remark;
            
            // Update UI
            $(`.remark-input[data-student-id="${studentId}"]`).val(remark);
        });
        
        showToast(`Remark added to ${selectedStudents.size} students`, 'success');
    }
    
    // Filter students
    function filterStudents(searchTerm) {
        if (!searchTerm) {
            $('.student-select-card').show();
            return;
        }
        
        $('.student-select-card').each(function() {
            const studentText = $(this).text().toLowerCase();
            $(this).toggle(studentText.indexOf(searchTerm) > -1);
        });
    }
    
    // Update student counts
    function updateStudentCounts() {
        const totalStudents = studentsData.length;
        const selectedCount = selectedStudents.size;
        
        $('#totalStudentsCount').text(totalStudents);
        $('#selectedStudentsCount').text(selectedCount);
        updateReviewData();
    }
    
    // Next step
    function nextStep() {
        switch(currentStep) {
            case 1:
                if (validateStep1()) {
                    if (!loadStudents()) return;
                    gotoStep(2);
                }
                break;
            case 2:
                if (validateStep2()) {
                    gotoStep(3);
                }
                break;
            case 3:
                createAttendanceSession();
                break;
        }
    }
    
    // Previous step
    function prevStep() {
        if (currentStep > 1) {
            gotoStep(currentStep - 1);
        }
    }
    
    // Go to specific step
    function gotoStep(step) {
        // Update step indicators
        $('.step-indicator').removeClass('active completed');
        
        for (let i = 1; i <= step; i++) {
            $(`.step-indicator[data-step="${i}"]`).addClass(i === step ? 'active' : 'completed');
        }
        
        // Hide all steps, show current step
        $('.step-content').removeClass('active');
        $(`#step${step}`).addClass('active');
        
        // Update navigation buttons
        currentStep = step;
        $('#currentStep').text(step);
        
        $('#prevStepBtn').prop('disabled', step === 1);
        
        if (step === 3) {
            $('#nextStepBtn').html('<i class="fas fa-check"></i> Submit');
            $('#nextStepBtn').removeClass('btn-next').addClass('btn-submit');
            updateReviewData();
        } else {
            $('#nextStepBtn').html('Next <i class="fas fa-arrow-right"></i>');
            $('#nextStepBtn').removeClass('btn-submit').addClass('btn-next');
        }
    }
    
    // Validate step 1
    function validateStep1() {
        const requiredFields = ['sessionDate', 'classLevel', 'stream', 'sessionType'];
        let isValid = true;
        
        requiredFields.forEach(fieldId => {
            const $field = $(`#${fieldId}`);
            if (!$field.val()) {
                isValid = false;
                $field.addClass('is-invalid');
                showToast(`Please fill in ${fieldId.replace(/([A-Z])/g, ' $1').toLowerCase()}`, 'error');
            } else {
                $field.removeClass('is-invalid');
            }
        });
        
        // Additional validation for subject type
        if ($('#sessionType').val() === 'SUBJECT' && !$('#subject').val()) {
            isValid = false;
            $('#subject').addClass('is-invalid');
            showToast('Please select a subject for subject attendance', 'error');
        }
        
        return isValid;
    }
    
    // Validate step 2
    function validateStep2() {
        if (selectedStudents.size === 0) {
            showToast('Please select at least one student', 'warning');
            return false;
        }
        return true;
    }
    
    // Update review data
    function updateReviewData() {
        // Basic info
        $('#reviewDate').text($('#sessionDate').val() ? new Date($('#sessionDate').val()).toLocaleDateString() : '-');
        
        const className = $('#classLevel option:selected').text();
        const streamName = $('#stream option:selected').text();
        $('#reviewClass').text(className + (streamName && streamName !== 'Select Stream' ? ' ' + streamName : ''));
        
        $('#reviewType').text($('#sessionType option:selected').text());
        
        // Attendance counts
        let presentCount = 0, absentCount = 0, lateCount = 0, excusedCount = 0;
        
        selectedStudents.forEach(studentId => {
            const status = studentStatus[studentId]?.status || $('#defaultStatus').val();
            switch(status) {
                case 'P': presentCount++; break;
                case 'A': absentCount++; break;
                case 'L': lateCount++; break;
                case 'E': excusedCount++; break;
            }
        });
        
        $('#reviewPresent').text(presentCount);
        $('#reviewAbsent').text(absentCount);
        $('#reviewLate').text(lateCount);
        $('#reviewExcused').text(excusedCount);
        $('#reviewTotal').text(selectedStudents.size);
        
        // Update review table
        const $reviewTableBody = $('#reviewTableBody');
        $reviewTableBody.empty();
        
        let index = 1;
        selectedStudents.forEach(studentId => {
            const student = studentsData.find(s => s.id == studentId);
            if (student) {
                const status = studentStatus[studentId]?.status || $('#defaultStatus').val();
                const remark = studentStatus[studentId]?.remark || '';
                const statusText = {
                    'P': 'Present',
                    'A': 'Absent',
                    'L': 'Late',
                    'E': 'Excused'
                }[status];
                
                const statusClass = {
                    'P': 'badge-success',
                    'A': 'badge-danger',
                    'L': 'badge-warning',
                    'E': 'badge-info'
                }[status];
                
                $reviewTableBody.append(`
                    <tr>
                        <td>${index++}</td>
                        <td>${student.full_name}</td>
                        <td>${student.admission_number}</td>
                        <td><span class="badge ${statusClass}">${statusText}</span></td>
                        <td><small class="text-muted">${remark || '-'}</small></td>
                    </tr>
                `);
            }
        });
    }
    
    // Create attendance session
    function createAttendanceSession() {
        if (!validateStep3()) return;
        
        showLoading('Creating attendance session...');
        
        // Prepare student attendance data
        const studentAttendance = {};
        selectedStudents.forEach(studentId => {
            studentAttendance[studentId] = {
                status: studentStatus[studentId]?.status || $('#defaultStatus').val(),
                remark: studentStatus[studentId]?.remark || ''
            };
        });
        
        // Prepare session data
        const sessionData = {
            date: $('#sessionDate').val(),
            attendance_type: $('#sessionType').val(),
            class_level: $('#classLevel').val(),
            stream: $('#stream').val(),
            subject: $('#sessionType').val() === 'SUBJECT' ? $('#subject').val() : null,
            period: $('#period').val() || null,
            description: $('#description').val() || '',
            student_attendance: studentAttendance,
            action: 'create_session'
        };
        
        $.ajax({
            url: '{% url "admin_attendance_crud" %}',
            method: 'POST',
            headers: { 'X-CSRFToken': '{{ csrf_token }}' },
            contentType: 'application/json',
            data: JSON.stringify(sessionData),
            success: function(response) {
                hideLoading();
                if (response.success) {
                    showToast('Attendance session created successfully!', 'success');
                    setTimeout(() => {
                        window.location.href = '{% url "attendance_session_list" %}';
                    }, 1500);
                } else {
                    showToast(response.message || 'Error creating session', 'error');
                }
            },
            error: function(xhr) {
                hideLoading();
                showToast('Error creating attendance session', 'error');
            }
        });
    }
    
    // Validate step 3
    function validateStep3() {
        if (selectedStudents.size === 0) {
            showToast('No students selected for attendance', 'error');
            return false;
        }
        return true;
    }
    
    // Save as draft
    function saveAsDraft() {
        if (!validateStep1()) return;
        
        showLoading('Saving as draft...');
        
        const draftData = {
            date: $('#sessionDate').val(),
            attendance_type: $('#sessionType').val(),
            class_level: $('#classLevel').val(),
            stream: $('#stream').val(),
            subject: $('#sessionType').val() === 'SUBJECT' ? $('#subject').val() : null,
            period: $('#period').val() || null,
            description: $('#description').val() || '',
            is_draft: true
        };
        
        localStorage.setItem('attendance_draft', JSON.stringify(draftData));
        
        setTimeout(() => {
            hideLoading();
            showToast('Draft saved successfully!', 'success');
        }, 1000);
    }
    
    // Show toast notification
    function showToast(message, type = 'info') {
        const toast = $(`
            <div class="toast" role="alert" style="position: fixed; top: 20px; right: 20px; z-index: 10000;">
                <div class="toast-header bg-${type} text-white">
                    <strong class="mr-auto">${type.charAt(0).toUpperCase() + type.slice(1)}</strong>
                    <button type="button" class="ml-2 mb-1 close text-white" data-dismiss="toast">
                        <span>&times;</span>
                    </button>
                </div>
                <div class="toast-body">
                    ${message}
                </div>
            </div>
        `);
        
        $('body').append(toast);
        toast.toast({ delay: 3000 }).toast('show');
        
        setTimeout(() => {
            toast.remove();
        }, 3000);
    }
    
    // Show loading overlay
    function showLoading(message = 'Loading...') {
        $('#loadingMessage').text(message);
        $('#loadingOverlay').show();
    }
    
    // Hide loading overlay
    function hideLoading() {
        $('#loadingOverlay').hide();
    }
    
    // Initialize
    initialize();
});
</script>
{% endblock extra_js %}